---
phase: 02-lease-entry-and-core-ui
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/components/forms/FieldTooltip.tsx
  - src/components/forms/EssentialFields.tsx
  - src/components/forms/OptionalFieldsSection.tsx
  - src/components/forms/LeaseEntryForm.tsx
  - src/hooks/use-auto-save.ts
autonomous: true

must_haves:
  truths:
    - "User sees 5 essential fields on initial form load"
    - "User can click 'Add more details' to reveal optional fields"
    - "Tapping (?) icon on a field shows a detailed educational popover"
    - "Short hint text is visible below each field label"
    - "Form state auto-saves to localStorage as user types"
    - "Validation errors appear after first submit attempt, not during initial fill"
    - "Unusual-but-valid values show yellow warnings without blocking submission"
  artifacts:
    - path: "src/components/forms/LeaseEntryForm.tsx"
      provides: "Main form component with React Hook Form integration"
      contains: "useForm"
      min_lines: 50
    - path: "src/components/forms/EssentialFields.tsx"
      provides: "5 essential lease fields with tooltips"
      contains: "monthlyPayment"
    - path: "src/components/forms/OptionalFieldsSection.tsx"
      provides: "Progressive disclosure expandable section"
      contains: "isExpanded"
    - path: "src/components/forms/FieldTooltip.tsx"
      provides: "Reusable educational tooltip with two-layer system"
      contains: "PopoverContent"
    - path: "src/hooks/use-auto-save.ts"
      provides: "Debounced localStorage auto-save hook"
      contains: "useDebounce"
  key_links:
    - from: "src/components/forms/LeaseEntryForm.tsx"
      to: "src/lib/validations/lease-schema.ts"
      via: "zodResolver imports shared schema"
      pattern: "zodResolver.*leaseFormSchema"
    - from: "src/components/forms/EssentialFields.tsx"
      to: "src/lib/content/field-tooltips.ts"
      via: "imports tooltip content for each field"
      pattern: "fieldTooltips"
    - from: "src/components/forms/LeaseEntryForm.tsx"
      to: "src/hooks/use-auto-save.ts"
      via: "auto-save hook watches form state"
      pattern: "useAutoSave|useFormAutoSave"
    - from: "src/components/forms/LeaseEntryForm.tsx"
      to: "src/components/ui/form.tsx"
      via: "uses shadcn Form primitives for accessibility"
      pattern: "FormField|FormItem|FormLabel|FormControl|FormMessage"
---

<objective>
Build the complete lease entry form UI: FieldTooltip component, auto-save hook, essential fields section, progressive disclosure optional section, and the main LeaseEntryForm that ties them together with React Hook Form.

Purpose: This is the core user-facing form -- the primary way users interact with the product in Phase 2. It must feel warm, educational, and non-intimidating.
Output: A fully functional client-side form component with validation, tooltips, progressive disclosure, and auto-save. (Not yet connected to server actions -- that's Plan 03.)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-lease-entry-and-core-ui/02-CONTEXT.md
@.planning/phases/02-lease-entry-and-core-ui/02-RESEARCH.md
@.planning/phases/02-lease-entry-and-core-ui/02-01-SUMMARY.md

@src/lib/validations/lease-schema.ts
@src/lib/content/field-tooltips.ts
@src/lib/types/lease.ts
@src/components/ui/form.tsx
@src/components/ui/input.tsx
@src/components/ui/popover.tsx
@src/components/ui/tooltip.tsx
@src/components/ui/button.tsx
@src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FieldTooltip component and auto-save hook</name>
  <files>
    src/components/forms/FieldTooltip.tsx
    src/hooks/use-auto-save.ts
  </files>
  <action>
    1. Create `src/components/forms/FieldTooltip.tsx` -- the two-layer educational tooltip system.

       This is a "use client" component that wraps the shadcn Popover. It renders:
       - A small (?) icon button (use lucide-react HelpCircle, size h-4 w-4)
       - On click/tap, opens a Popover with:
         - Title (bold)
         - Description (casual, friendly explanation)
         - "Where to find this" section (if provided) with a subtle visual separator
         - "Learn more" external link (if provided) with arrow icon, opens in new tab
         - Example value (if provided) in a subtle code/mono style

       Props interface:
       ```typescript
       interface FieldTooltipProps {
         fieldName: string; // key into fieldTooltips
       }
       ```

       The component should import `fieldTooltips` from `@/lib/content/field-tooltips` and look up content by fieldName. This keeps the component thin and the content centralized.

       Styling:
       - PopoverContent: max-w-sm, p-4, rounded-xl (warm style)
       - (?) button: inline-flex, vertically centered with label text, text-muted-foreground, hover:text-foreground transition
       - "Where to find this" section: border-t, pt-2, mt-2 visual separator
       - "Learn more" link: text-primary, hover:underline, flex items-center gap-1 with small external link icon
       - Screen reader: <span className="sr-only">Help for {title}</span> on the button

       Accessibility: Use Popover (not Tooltip) because the content is rich and interactive (has links). Tooltip is for simple text hints only.

    2. Create `src/hooks/use-auto-save.ts` -- debounced localStorage persistence for form drafts.

       This is a "use client" hook. Implementation:
       ```typescript
       export function useFormAutoSave<T extends Record<string, unknown>>(
         watch: UseFormWatch<T>,
         storageKey: string,
         delay?: number // default 500ms
       ): {
         loadSaved: () => Partial<T> | null;
         clearSaved: () => void;
         hasSavedDraft: boolean;
       }
       ```

       Behavior:
       - Uses `watch()` to subscribe to all form changes
       - Debounces with `useDebounce` from `use-debounce` package (500ms default)
       - Saves debounced data to localStorage via `useEffect`
       - `loadSaved()` reads from localStorage (only call in useEffect to avoid SSR mismatch)
       - `clearSaved()` removes the localStorage entry
       - `hasSavedDraft` is a state boolean, set in a useEffect on mount (checks if localStorage key exists)

       IMPORTANT: Guard all localStorage access with `typeof window !== 'undefined'` to prevent SSR errors. Only access localStorage inside useEffect or event handlers, never during render.

       Storage key convention: `"lease-draft"` for new leases, `"lease-draft-{id}"` for editing existing leases.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `src/components/forms/FieldTooltip.tsx` exports FieldTooltip component
    - `src/hooks/use-auto-save.ts` exports useFormAutoSave hook
    - FieldTooltip accepts `fieldName` prop and renders Popover with content from field-tooltips.ts
    - Auto-save hook uses useDebounce with configurable delay
    - No direct localStorage access outside useEffect (grep for localStorage to verify)
  </verify>
  <done>
    FieldTooltip renders a (?) icon that opens a rich educational popover with description, "where to find", and "learn more" link. Auto-save hook debounces form state to localStorage with SSR-safe guards. Both components ready for integration into the main form.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build LeaseEntryForm with essential fields and progressive disclosure</name>
  <files>
    src/components/forms/EssentialFields.tsx
    src/components/forms/OptionalFieldsSection.tsx
    src/components/forms/LeaseEntryForm.tsx
  </files>
  <action>
    1. Create `src/components/forms/EssentialFields.tsx` -- the 5 essential lease fields that appear on first load.

       "use client" component. Receives `control` from React Hook Form via `useFormContext()`.

       Fields (each uses shadcn FormField/FormItem/FormLabel/FormDescription/FormControl/FormMessage):
       - **Monthly Payment** ($): number input, placeholder "450", prefix "$" label or adornment
       - **Lease Term** (months): number input, placeholder "36", suffix "months" hint
       - **Annual Mileage Allowance**: number input, placeholder "12000", suffix "miles/year"
       - **Residual Value** ($): number input, placeholder "18000", prefix "$"
       - **Current Mileage**: number input, placeholder "15000", suffix "miles"

       Each field includes:
       - `<FormLabel>` with field name + `<FieldTooltip fieldName="..." />` inline
       - `<FormDescription>` with the `shortHint` from field-tooltips.ts (always visible, subtle)
       - `<FormControl>` wrapping `<Input type="number" />`
       - `<FormMessage />` for validation errors (auto-displayed by shadcn)

       Layout: Vertical stack with `space-y-6` between fields. Each field is a clean card-like row.

    2. Create `src/components/forms/OptionalFieldsSection.tsx` -- progressive disclosure expandable section.

       "use client" component. Uses `useFormContext()` for form access.

       Renders:
       - A "Add more details" button (shadcn Button, variant="outline") with chevron icon
       - Subtle hint text: "More details improve accuracy" (muted, not pushy)
       - When expanded, shows optional fields grouped by domain concept:

       **Vehicle Information** group:
       - Make (text input), Model (text input), Year (number input)

       **Financial Details** group:
       - MSRP ($), Net Cap Cost ($), Residual Percent (%), Money Factor (decimal), Down Payment ($)

       **Fees** group:
       - Disposition Fee ($), Purchase Fee ($), Overage Fee Per Mile ($/mile)

       **Lease Timeline** group:
       - Months Elapsed (number), State Code (2-letter select or text input), Start Date, End Date

       Each group has a subtle heading (text-sm font-medium text-muted-foreground) and a visual separator.

       Track optional field completion count and show it on the expand button: "Add more details (3 of 14 added)"

       Use `useWatch` for specific fields when computing the completeness count -- do NOT use `form.watch()` at root level (performance pitfall from research).

    3. Create `src/components/forms/LeaseEntryForm.tsx` -- the main form component that orchestrates everything.

       "use client" component. This is the top-level form.

       Implementation:
       - Initialize `useForm<LeaseFormData>` with `zodResolver(leaseFormSchema)`, mode: "onTouched", reValidateMode: "onChange"
       - Default values: monthlyPayment empty, termMonths 36, allowedMilesPerYear 12000, residualValue empty, currentMileage empty (use undefined/empty string for fields user must fill, sensible defaults for fields with common values)
       - Integrate `useFormAutoSave` hook with key "lease-draft"
       - On mount (useEffect), check for saved draft and restore with `form.reset(savedData)` if found. Show a subtle "Draft restored" indicator that fades out.
       - Wrap form in `<Form {...form}>` provider (shadcn)
       - Render `<EssentialFields />` inside the Form context
       - Render `<OptionalFieldsSection />` below
       - Render submit button: "Save Lease" (shadcn Button, size="lg", full width on mobile)
       - Show warnings (from warning check function) as amber/yellow alerts below relevant fields or in a summary above the submit button. Warnings are non-blocking.

       Form submission handler (temporary until Plan 03 wires server actions):
       - `onSubmit`: console.log the validated data for now. Plan 03 will replace this with the server action call.
       - Show a "validating..." state on the submit button using `form.formState.isSubmitting`

       Visual container:
       - Centered card on desktop: max-w-2xl mx-auto
       - Rounded-2xl border with subtle shadow (shadow-sm)
       - Padding: p-6 sm:p-8
       - Full width on mobile (no horizontal margin, rounded corners removed on xs)
       - Card header with title "Enter Your Lease Details" and subtitle "Start with the basics -- you can always add more details later."

       Accessibility:
       - All inputs have proper labels via FormLabel
       - Error messages linked via aria-describedby (handled by shadcn FormMessage)
       - Submit button disabled state when isSubmitting
       - Focus management: first field focused on mount (optional, only if no draft restored)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `src/components/forms/LeaseEntryForm.tsx` exports LeaseEntryForm
    - `src/components/forms/EssentialFields.tsx` exports EssentialFields with 5 form fields
    - `src/components/forms/OptionalFieldsSection.tsx` exports OptionalFieldsSection with expandable section
    - LeaseEntryForm uses zodResolver with leaseFormSchema
    - LeaseEntryForm integrates useFormAutoSave hook
    - Each essential field has FormLabel + FieldTooltip + FormDescription + FormControl + FormMessage
    - Progressive disclosure section tracks and displays optional field completion count
    - `npm run build` succeeds
  </verify>
  <done>
    Complete lease entry form renders with 5 essential fields visible by default, expandable optional fields section with grouped sub-sections, educational tooltips on every field, auto-save to localStorage, and hybrid validation timing. Form validates with Zod on submit and shows friendly error messages. Visual style is warm and approachable with rounded corners, soft shadows, and friendly copy.
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds with all form components
- `npx tsc --noEmit` passes with no errors
- Form components properly compose: LeaseEntryForm > EssentialFields + OptionalFieldsSection, each field has FieldTooltip
- React Hook Form integration: zodResolver, onTouched mode, auto-save hook
- Progressive disclosure: optional fields hidden by default, expandable via button
- All 5 essential fields rendered with validation, tooltips, and descriptions
- Optional fields organized in logical groups
</verification>

<success_criteria>
1. LeaseEntryForm renders 5 essential fields on load (monthly payment, term, mileage allowance, residual value, current mileage)
2. Each field has a (?) tooltip icon that opens educational popover with description and "where to find" guidance
3. Short hint text visible below each field label
4. "Add more details" button expands to show optional fields in grouped sections
5. Optional field completion count displayed on expand button
6. Form auto-saves drafts to localStorage with 500ms debounce
7. Restored drafts shown with "Draft restored" indicator
8. Validation errors appear only after first submit attempt (onTouched mode)
9. Warning function output shown as amber/yellow non-blocking alerts
10. Submit button shows loading state during submission
</success_criteria>

<output>
After completion, create `.planning/phases/02-lease-entry-and-core-ui/02-02-SUMMARY.md`
</output>
