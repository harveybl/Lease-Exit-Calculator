---
phase: 02-lease-entry-and-core-ui
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - src/app/lease/actions.ts
  - src/app/lease/new/page.tsx
  - src/app/lease/[id]/edit/page.tsx
  - src/app/lease/page.tsx
  - src/app/page.tsx
  - src/components/forms/LeaseEntryForm.tsx
autonomous: true

must_haves:
  truths:
    - "Submitting the form saves lease data to the database"
    - "Saved lease persists across browser sessions (refresh, close and reopen)"
    - "User can navigate to edit an existing lease and see pre-filled data"
    - "User can delete an existing lease"
    - "Current mileage entry is date-stamped with today's date"
    - "Server validates with the same Zod schema used on the client"
  artifacts:
    - path: "src/app/lease/actions.ts"
      provides: "Server Actions for lease CRUD (create, update, delete, fetch)"
      exports: ["createLease", "updateLease", "deleteLease", "getLease", "getLeases"]
      contains: "use server"
    - path: "src/app/lease/new/page.tsx"
      provides: "New lease entry page"
      contains: "LeaseEntryForm"
    - path: "src/app/lease/[id]/edit/page.tsx"
      provides: "Edit existing lease page with pre-filled form"
      contains: "LeaseEntryForm"
    - path: "src/app/lease/page.tsx"
      provides: "Lease list page showing saved leases with edit/delete actions"
      contains: "getLeases"
  key_links:
    - from: "src/app/lease/actions.ts"
      to: "src/lib/db/schema.ts"
      via: "Drizzle ORM insert/update/delete on leases table"
      pattern: "db\\.(insert|update|delete).*leases"
    - from: "src/app/lease/actions.ts"
      to: "src/lib/validations/lease-schema.ts"
      via: "Server-side validation with shared Zod schema"
      pattern: "leaseFormSchema\\.safeParse"
    - from: "src/components/forms/LeaseEntryForm.tsx"
      to: "src/app/lease/actions.ts"
      via: "Form onSubmit calls server action"
      pattern: "createLease|updateLease"
    - from: "src/app/lease/[id]/edit/page.tsx"
      to: "src/app/lease/actions.ts"
      via: "Server component fetches lease data for pre-fill"
      pattern: "getLease"
    - from: "src/app/lease/page.tsx"
      to: "src/app/lease/actions.ts"
      via: "Server component fetches all leases for list"
      pattern: "getLeases"
---

<objective>
Create server actions for lease CRUD operations, wire the form to persist data to the database, build the lease list page with edit/delete, and update the home page to navigate to the lease entry flow.

Purpose: This plan connects the form UI (Plan 02) to the database (Phase 1), completing the full create-read-update-delete cycle. After this plan, a user can enter a lease, save it, see it listed, edit it, and delete it.
Output: Server actions for all lease CRUD, page routes for new/edit/list, working persistence across sessions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-lease-entry-and-core-ui/02-CONTEXT.md
@.planning/phases/02-lease-entry-and-core-ui/02-RESEARCH.md
@.planning/phases/02-lease-entry-and-core-ui/02-01-SUMMARY.md
@.planning/phases/02-lease-entry-and-core-ui/02-02-SUMMARY.md

@src/lib/db/schema.ts
@src/lib/db/client.ts
@src/lib/db/custom-types.ts
@src/lib/validations/lease-schema.ts
@src/lib/types/lease.ts
@src/components/forms/LeaseEntryForm.tsx
@src/app/layout.tsx
@src/app/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create server actions for lease CRUD and wire form submission</name>
  <files>
    src/app/lease/actions.ts
    src/components/forms/LeaseEntryForm.tsx
  </files>
  <action>
    1. Create `src/app/lease/actions.ts` with "use server" directive. Implement these server actions:

       **createLease(data: LeaseFormData)**:
       - Import `leaseFormSchema` from `@/lib/validations/lease-schema` and validate with `.safeParse(data)`
       - If validation fails, return `{ success: false, error: parsed.error.flatten() }`
       - Map form data to database columns. CRITICAL: The existing DB schema (src/lib/db/schema.ts) has ALL fields as `.notNull()`. The form has optional fields. For optional fields not provided, use sensible defaults:
         - make: "" (empty string), model: "" (empty string), year: current year
         - msrp: 0, netCapCost: 0, residualPercent: 0, moneyFactor: 0
         - downPayment: 0, dispositionFee: 0, purchaseFee: 0
         - overageFeePerMile: 0.25 (standard default)
         - monthsElapsed: 0
         - stateCode: "" (empty -- no state selected)
         - startDate: today, endDate: today + termMonths
       - For Decimal fields, pass the number value directly -- the custom `decimalNumber` Drizzle type in custom-types.ts handles the conversion to Decimal.js. Check how the custom type works (read custom-types.ts) to confirm the correct input format.
       - Set `mileageDate` to `new Date()` (today) for the date-stamped mileage entry (ENTRY-07)
       - Insert using `db.insert(leases).values({...}).returning()`
       - Call `revalidatePath('/lease')` after successful insert
       - Return `{ success: true, leaseId: lease.id }`

       **updateLease(id: string, data: LeaseFormData)**:
       - Validate with same Zod schema
       - Use `db.update(leases).set({...updatedAt: new Date()}).where(eq(leases.id, id)).returning()`
       - Update `mileageDate` to today if `currentMileage` changed (date-stamp the new reading)
       - Call `revalidatePath('/lease')` and `revalidatePath('/lease/${id}/edit')`
       - Return `{ success: true }` or `{ success: false, error: ... }`

       **deleteLease(id: string)**:
       - Use `db.delete(leases).where(eq(leases.id, id))`
       - Call `revalidatePath('/lease')`
       - Return `{ success: true }` or error

       **getLease(id: string)**:
       - Use `db.select().from(leases).where(eq(leases.id, id)).limit(1)`
       - Return the lease or null
       - This is a data-fetching function (not a mutation) but lives in actions.ts for colocation

       **getLeases()**:
       - Use `db.select().from(leases).orderBy(desc(leases.updatedAt))`
       - Return array of leases

       Import `eq` and `desc` from `drizzle-orm`.

    2. Update `src/components/forms/LeaseEntryForm.tsx` to wire up server actions:

       - Add props: `leaseId?: string` (for edit mode) and `initialData?: Partial<LeaseFormData>` (pre-filled data for editing)
       - Import `createLease` and `updateLease` from `@/app/lease/actions`
       - In `onSubmit` handler:
         - If `leaseId` exists: call `updateLease(leaseId, data)`
         - Else: call `createLease(data)`
       - On success:
         - Clear auto-save draft (`clearSaved()`)
         - Show success feedback (a green toast or success message at the top of the form)
         - If creating: redirect to `/lease` (list page) using `useRouter().push('/lease')` from next/navigation
         - If editing: show "Changes saved" success message, stay on page
       - On error:
         - If server returns field errors, map them back to form using `form.setError(fieldName, { message })`
         - If server returns generic error, show error message at top of form
       - Use React 19 `useTransition` or `useActionState` for pending state (show loading on submit button)

       - When `initialData` is provided, use it as `defaultValues` in `useForm()` instead of empty defaults
       - When editing, change the submit button text to "Save Changes" and the card title to "Edit Lease Details"
       - When editing, do NOT restore localStorage draft (only restore draft for new leases)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `src/app/lease/actions.ts` exports createLease, updateLease, deleteLease, getLease, getLeases
    - actions.ts has "use server" directive at top
    - actions.ts validates with leaseFormSchema.safeParse before database operations
    - actions.ts calls revalidatePath after mutations
    - LeaseEntryForm.tsx accepts leaseId and initialData props
    - LeaseEntryForm.tsx calls createLease or updateLease based on leaseId presence
    - `npm run build` succeeds
  </verify>
  <done>
    Server actions handle full lease CRUD with server-side Zod validation matching client schema. Form component wired to call createLease (new) or updateLease (edit) on submit, with success/error feedback, auto-save draft clearing on success, and redirect behavior.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create page routes (new, edit, list) and update home page</name>
  <files>
    src/app/lease/new/page.tsx
    src/app/lease/[id]/edit/page.tsx
    src/app/lease/page.tsx
    src/app/page.tsx
  </files>
  <action>
    1. Create `src/app/lease/new/page.tsx` -- Server Component page for new lease entry.
       - Simple wrapper that renders `<LeaseEntryForm />` with no props (new mode)
       - Page metadata: title "New Lease | Lease Tracker"
       - Include a back link to `/lease` (lease list)

    2. Create `src/app/lease/[id]/edit/page.tsx` -- Server Component page for editing existing lease.
       - Receives `params: { id: string }` from dynamic route
       - Calls `getLease(id)` to fetch existing data
       - If lease not found, call `notFound()` from next/navigation (renders 404)
       - Maps database lease object back to `LeaseFormData` shape (Decimal fields need to be converted to numbers: call `.toNumber()` on Decimal.js values, or check what the Drizzle select returns -- the custom type may return Decimal objects or numbers)
       - Renders `<LeaseEntryForm leaseId={id} initialData={mappedData} />`
       - Page metadata: title "Edit Lease | Lease Tracker"
       - Include a back link to `/lease`

    3. Create `src/app/lease/page.tsx` -- Server Component page listing all saved leases.
       - Calls `getLeases()` to fetch all leases
       - If no leases: show empty state with friendly message ("No leases yet. Add your first lease to get started.") and a prominent "Add Lease" button linking to `/lease/new`
       - If leases exist: render a list/card view of each lease showing:
         - Vehicle info (make, model, year) or "Unnamed Lease" if no make/model
         - Monthly payment
         - Term and months elapsed
         - Last updated date
         - "Edit" button linking to `/lease/{id}/edit`
         - "Delete" button that calls `deleteLease(id)` via a form action or client-side handler
       - Delete should have a confirmation step (simple: button text changes to "Confirm Delete?" on first click, or use a dialog)
       - "Add New Lease" button at the top
       - Page metadata: title "Your Leases | Lease Tracker"
       - Style: consistent with the warm, approachable theme. Lease cards with rounded corners, subtle shadow, clean layout.

    4. Update `src/app/page.tsx` -- modify the home page to serve as a landing/entry point.
       - Keep the existing LegalDisclaimer
       - Add a prominent "Enter Your Lease" call-to-action button linking to `/lease/new`
       - Add a "View Saved Leases" link to `/lease`
       - Update the subtitle from "Calculation results will appear here" to something warm and inviting: "Find out the smartest financial move for your vehicle lease."
       - Keep the page clean and simple -- it's an entry point, not a feature page

    IMPORTANT: The delete functionality requires careful implementation. Since this is a Server Component page, the delete button needs to work via either:
    - A `<form action={deleteLease.bind(null, id)}>` pattern (Server Action in form)
    - Or a small client component for the delete button with confirmation

    Choose the approach that provides the best UX (confirmation before delete is essential -- users should not accidentally lose their lease data).
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds
    - Route `/lease/new` renders LeaseEntryForm in new mode (no leaseId prop)
    - Route `/lease/[id]/edit` fetches lease and renders LeaseEntryForm with initialData
    - Route `/lease` renders lease list or empty state
    - Home page `/` has navigation to lease entry and list
    - Delete button has confirmation before executing
    - 404 handled when editing non-existent lease
    - All pages have proper metadata titles
  </verify>
  <done>
    All page routes created: /lease/new (create), /lease/[id]/edit (edit with pre-fill), /lease (list with edit/delete). Home page updated with navigation to lease flow. Delete has confirmation step. Complete CRUD cycle works: create -> list -> edit -> delete. Lease data persists to Postgres via Drizzle ORM and survives browser sessions.
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds with all routes
- `npx tsc --noEmit` passes
- Server actions validate with shared Zod schema (same as client)
- Database operations use Drizzle ORM (insert, update, delete, select)
- Mileage date stamped on create and on mileage change during edit
- Form redirects to list after successful create
- Edit page pre-fills all form fields from database
- Delete has confirmation before execution
- revalidatePath called after all mutations
- All pages accessible via navigation from home page
</verification>

<success_criteria>
1. Creating a new lease saves all form data to the database and redirects to lease list
2. Lease list page shows all saved leases with make/model/year, payment, and term info
3. Clicking "Edit" on a lease opens the form pre-filled with that lease's data
4. Saving edits updates the existing lease (not creates a new one)
5. Deleting a lease requires confirmation and removes it from the database
6. Current mileage is date-stamped with today's date on create and on mileage change
7. Server validates all data with the same Zod schema used on the client
8. Empty state shown when no leases exist, with clear call to action
9. Home page provides navigation to create new lease and view existing leases
</success_criteria>

<output>
After completion, create `.planning/phases/02-lease-entry-and-core-ui/02-03-SUMMARY.md`
</output>
