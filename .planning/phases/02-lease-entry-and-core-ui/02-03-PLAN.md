---
phase: 02-lease-entry-and-core-ui
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - src/lib/db/schema.ts
  - src/app/lease/actions.ts
  - src/app/lease/new/page.tsx
  - src/app/lease/[id]/edit/page.tsx
  - src/app/lease/page.tsx
  - src/app/page.tsx
  - src/components/forms/LeaseEntryForm.tsx
autonomous: true

must_haves:
  truths:
    - "Submitting the form saves lease data to the database"
    - "Saved lease persists across browser sessions (refresh, close and reopen)"
    - "User can navigate to edit an existing lease and see pre-filled data"
    - "User can delete an existing lease"
    - "Current mileage entry is date-stamped with today's date"
    - "Mileage date only updates when the mileage value actually changes"
    - "Server validates with the same Zod schema used on the client"
    - "Optional fields store NULL in the database (not empty strings or zero)"
  artifacts:
    - path: "src/lib/db/schema.ts"
      provides: "Updated schema with nullable optional columns"
      contains: "make.*varchar.*100"
    - path: "src/app/lease/actions.ts"
      provides: "Server Actions for lease CRUD (create, update, delete, fetch)"
      exports: ["createLease", "updateLease", "deleteLease", "getLease", "getLeases"]
      contains: "use server"
    - path: "src/app/lease/new/page.tsx"
      provides: "New lease entry page"
      contains: "LeaseEntryForm"
    - path: "src/app/lease/[id]/edit/page.tsx"
      provides: "Edit existing lease page with pre-filled form"
      contains: "LeaseEntryForm"
    - path: "src/app/lease/page.tsx"
      provides: "Lease list page showing saved leases with edit/delete actions"
      contains: "getLeases"
  key_links:
    - from: "src/app/lease/actions.ts"
      to: "src/lib/db/schema.ts"
      via: "Drizzle ORM insert/update/delete on leases table"
      pattern: "db\\.(insert|update|delete).*leases"
    - from: "src/app/lease/actions.ts"
      to: "src/lib/validations/lease-schema.ts"
      via: "Server-side validation with shared Zod schema"
      pattern: "leaseFormSchema\\.safeParse"
    - from: "src/components/forms/LeaseEntryForm.tsx"
      to: "src/app/lease/actions.ts"
      via: "Form onSubmit calls server action"
      pattern: "createLease|updateLease"
    - from: "src/app/lease/[id]/edit/page.tsx"
      to: "src/app/lease/actions.ts"
      via: "Server component fetches lease data for pre-fill"
      pattern: "getLease"
    - from: "src/app/lease/page.tsx"
      to: "src/app/lease/actions.ts"
      via: "Server component fetches all leases for list"
      pattern: "getLeases"
    - from: "src/app/lease/actions.ts"
      to: "src/lib/db/schema.ts"
      via: "Nullable columns align with Zod optional fields"
      pattern: "make|model|year|msrp|stateCode"
---

<objective>
Create server actions for lease CRUD operations, wire the form to persist data to the database, build the lease list page with edit/delete, and update the home page to navigate to the lease entry flow. Also migrate the DB schema to make optional fields nullable so they store NULL instead of garbage defaults.

Purpose: This plan connects the form UI (Plan 02) to the database (Phase 1), completing the full create-read-update-delete cycle. After this plan, a user can enter a lease, save it, see it listed, edit it, and delete it. The schema migration ensures optional fields use NULL (semantically "not provided") rather than empty strings or zeros.
Output: Server actions for all lease CRUD, page routes for new/edit/list, working persistence across sessions, nullable optional columns.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-lease-entry-and-core-ui/02-CONTEXT.md
@.planning/phases/02-lease-entry-and-core-ui/02-RESEARCH.md
@.planning/phases/02-lease-entry-and-core-ui/02-01-SUMMARY.md
@.planning/phases/02-lease-entry-and-core-ui/02-02-SUMMARY.md

@src/lib/db/schema.ts
@src/lib/db/client.ts
@src/lib/db/custom-types.ts
@src/lib/validations/lease-schema.ts
@src/lib/types/lease.ts
@src/components/forms/LeaseEntryForm.tsx
@src/app/layout.tsx
@src/app/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate DB schema to nullable optional fields, create server actions, and wire form submission</name>
  <files>
    src/lib/db/schema.ts
    src/app/lease/actions.ts
    src/components/forms/LeaseEntryForm.tsx
  </files>
  <action>
    **Step 1: Update DB schema to make optional fields nullable.**

    Edit `src/lib/db/schema.ts`. The following columns are optional in the Zod form schema (Plan 02-01) because progressive disclosure means users may never fill them. Change these from `.notNull()` to no constraint (nullable by default in Drizzle/Postgres):

    **Remove `.notNull()` from these columns:**
    - `make` (varchar) -- user may not enter vehicle info
    - `model` (varchar) -- user may not enter vehicle info
    - `year` (integer) -- user may not enter vehicle info
    - `msrp` (decimalNumber) -- optional financial detail
    - `netCapCost` (decimalNumber) -- optional financial detail
    - `residualPercent` (decimalNumber) -- optional financial detail
    - `moneyFactor` (decimalNumber) -- optional financial detail
    - `downPayment` (decimalNumber) -- optional, default 0 in Zod but NULL in DB means "not provided"
    - `dispositionFee` (decimalNumber) -- optional fee
    - `purchaseFee` (decimalNumber) -- optional fee
    - `monthsElapsed` (integer) -- optional timeline detail
    - `stateCode` (varchar) -- optional location
    - `startDate` (date) -- optional timeline
    - `endDate` (date) -- optional timeline

    **Keep `.notNull()` on these columns (they are required in the form):**
    - `id` (has defaultRandom)
    - `monthlyPayment` -- essential field
    - `termMonths` -- essential field
    - `allowedMilesPerYear` -- essential field
    - `residualValue` -- essential field
    - `currentMileage` -- essential field
    - `mileageDate` -- always set by server to today
    - `overageFeePerMile` -- has default value (0.25)
    - `createdAt`, `updatedAt` -- have defaultNow

    After editing schema.ts, run `npx drizzle-kit push` to apply the schema change to the database. This uses Drizzle Kit's push mode (no migration files -- direct sync to DB), which is the approach used in Phase 1. If the project uses `drizzle-kit generate` + `drizzle-kit migrate` instead, use that workflow. Check `drizzle.config.ts` for the configured approach.

    IMPORTANT: This is a non-destructive change (removing NOT NULL constraints). Existing data (if any) will not be affected. New rows will simply allow NULL for these columns.

    **Step 2: Create `src/app/lease/actions.ts`** with "use server" directive. Implement these server actions:

    **createLease(data: LeaseFormData)**:
    - Import `leaseFormSchema` from `@/lib/validations/lease-schema` and validate with `.safeParse(data)`
    - If validation fails, return `{ success: false, error: parsed.error.flatten() }`
    - Map form data to database columns. Since optional columns are now nullable, pass `undefined` (or `null`) for optional fields the user didn't fill in -- Drizzle will store NULL in the database. Do NOT use empty strings or zero as sentinel values.
    - For Decimal fields (monthlyPayment, residualValue, overageFeePerMile, and any optional decimal fields the user DID provide), create `new Decimal(value)` from `@/lib/decimal` before passing to Drizzle. The custom `decimalNumber` type in custom-types.ts expects a `Decimal` object as input (it calls `.toFixed()` in `toDriver`).
    - For optional Decimal fields not provided: pass `null` (column is now nullable).
    - Set `mileageDate` to `new Date()` (today) for the date-stamped mileage entry (ENTRY-07)
    - Set `overageFeePerMile` to `new Decimal(data.overageFeePerMile ?? 0.25)` -- use form value or standard default
    - Insert using `db.insert(leases).values({...}).returning()`
    - Call `revalidatePath('/lease')` after successful insert
    - Return `{ success: true, leaseId: lease.id }`

    **updateLease(id: string, data: LeaseFormData)**:
    - Validate with same Zod schema
    - CRITICAL mileage date-stamping logic (ENTRY-07): Before updating, fetch the existing lease to compare mileage:
      ```typescript
      const [existing] = await db.select({ currentMileage: leases.currentMileage })
        .from(leases).where(eq(leases.id, id)).limit(1);

      const mileageChanged = existing && data.currentMileage !== existing.currentMileage;
      ```
      Only set `mileageDate: new Date()` in the update if `mileageChanged` is true. If the user edits other fields but leaves mileage unchanged, the original mileageDate must be preserved -- it records WHEN that specific mileage reading was taken.
    - Use `db.update(leases).set({...updatedAt: new Date(), ...(mileageChanged ? { mileageDate: new Date() } : {})}).where(eq(leases.id, id)).returning()`
    - Apply same Decimal conversion as createLease for numeric fields
    - Pass `null` for optional fields not provided (not empty strings/zeros)
    - Call `revalidatePath('/lease')` and `revalidatePath('/lease/${id}/edit')`
    - Return `{ success: true }` or `{ success: false, error: ... }`

    **deleteLease(id: string)**:
    - Use `db.delete(leases).where(eq(leases.id, id))`
    - Call `revalidatePath('/lease')`
    - Return `{ success: true }` or error

    **getLease(id: string)**:
    - Use `db.select().from(leases).where(eq(leases.id, id)).limit(1)`
    - Return the lease or null
    - This is a data-fetching function (not a mutation) but lives in actions.ts for colocation

    **getLeases()**:
    - Use `db.select().from(leases).orderBy(desc(leases.updatedAt))`
    - Return array of leases

    Import `eq` and `desc` from `drizzle-orm`.

    **Step 3: Update `src/components/forms/LeaseEntryForm.tsx`** to wire up server actions:

    - Add props: `leaseId?: string` (for edit mode) and `initialData?: Partial<LeaseFormData>` (pre-filled data for editing)
    - Import `createLease` and `updateLease` from `@/app/lease/actions`
    - In `onSubmit` handler:
      - If `leaseId` exists: call `updateLease(leaseId, data)`
      - Else: call `createLease(data)`
    - On success:
      - Clear auto-save draft (`clearSaved()`)
      - Show success feedback (a green toast or success message at the top of the form)
      - If creating: redirect to `/lease` (list page) using `useRouter().push('/lease')` from next/navigation
      - If editing: show "Changes saved" success message, stay on page
    - On error:
      - If server returns field errors, map them back to form using `form.setError(fieldName, { message })`
      - If server returns generic error, show error message at top of form
    - Use React 19 `useTransition` or `useActionState` for pending state (show loading on submit button)

    - When `initialData` is provided, use it as `defaultValues` in `useForm()` instead of empty defaults
    - When editing, change the submit button text to "Save Changes" and the card title to "Edit Lease Details"
    - When editing, do NOT restore localStorage draft (only restore draft for new leases)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `src/lib/db/schema.ts` has nullable optional columns (grep for `.notNull()` -- should only appear on essential fields: monthlyPayment, termMonths, allowedMilesPerYear, residualValue, currentMileage, mileageDate, overageFeePerMile, createdAt, updatedAt, id)
    - `npx drizzle-kit push` succeeds (or generate+migrate succeeds) -- schema changes applied to DB
    - `src/app/lease/actions.ts` exports createLease, updateLease, deleteLease, getLease, getLeases
    - actions.ts has "use server" directive at top
    - actions.ts validates with leaseFormSchema.safeParse before database operations
    - actions.ts creates `new Decimal(value)` for all numeric fields before passing to Drizzle insert/update. Verify by inserting a test lease and reading it back -- Decimal fields (monthlyPayment, residualValue, etc.) should round-trip correctly (e.g., insert 450.00, read back Decimal('450.00'))
    - actions.ts passes `null` (not empty string or 0) for unprovided optional fields
    - updateLease fetches existing lease and compares currentMileage before deciding whether to update mileageDate
    - actions.ts calls revalidatePath after mutations
    - LeaseEntryForm.tsx accepts leaseId and initialData props
    - LeaseEntryForm.tsx calls createLease or updateLease based on leaseId presence
    - `npm run build` succeeds
  </verify>
  <done>
    DB schema updated: optional columns are nullable (NULL = "not provided"). Server actions handle full lease CRUD with server-side Zod validation, proper Decimal.js conversion for all numeric fields, and correct mileage date-stamping (only updates mileageDate when currentMileage actually changes). Form component wired to call createLease (new) or updateLease (edit) on submit, with success/error feedback, auto-save draft clearing on success, and redirect behavior.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create page routes (new, edit, list) and update home page</name>
  <files>
    src/app/lease/new/page.tsx
    src/app/lease/[id]/edit/page.tsx
    src/app/lease/page.tsx
    src/app/page.tsx
  </files>
  <action>
    1. Create `src/app/lease/new/page.tsx` -- Server Component page for new lease entry.
       - Simple wrapper that renders `<LeaseEntryForm />` with no props (new mode)
       - Page metadata: title "New Lease | Lease Tracker"
       - Include a back link to `/lease` (lease list)

    2. Create `src/app/lease/[id]/edit/page.tsx` -- Server Component page for editing existing lease.
       - Receives `params: { id: string }` from dynamic route
       - Calls `getLease(id)` to fetch existing data
       - If lease not found, call `notFound()` from next/navigation (renders 404)
       - Maps database lease object back to `LeaseFormData` shape. For Decimal fields returned by Drizzle (the custom type returns `Decimal` objects from `fromDriver`), convert to plain numbers using `.toNumber()` before passing as initialData. For nullable fields that are NULL in the database, pass `undefined` so the form treats them as empty/optional.
       - Renders `<LeaseEntryForm leaseId={id} initialData={mappedData} />`
       - Page metadata: title "Edit Lease | Lease Tracker"
       - Include a back link to `/lease`

    3. Create `src/app/lease/page.tsx` -- Server Component page listing all saved leases.
       - Calls `getLeases()` to fetch all leases
       - If no leases: show empty state with friendly message ("No leases yet. Add your first lease to get started.") and a prominent "Add Lease" button linking to `/lease/new`
       - If leases exist: render a list/card view of each lease showing:
         - Vehicle info (make, model, year) or "Unnamed Lease" if make/model are NULL
         - Monthly payment (convert Decimal to display string)
         - Term and months elapsed
         - Last updated date
         - "Edit" button linking to `/lease/{id}/edit`
         - "Delete" button that calls `deleteLease(id)` via a form action or client-side handler
       - Delete should have a confirmation step (simple: button text changes to "Confirm Delete?" on first click, or use a dialog)
       - "Add New Lease" button at the top
       - Page metadata: title "Your Leases | Lease Tracker"
       - Style: consistent with the warm, approachable theme. Lease cards with rounded corners, subtle shadow, clean layout.

    4. Update `src/app/page.tsx` -- modify the home page to serve as a landing/entry point.
       - Keep the existing LegalDisclaimer
       - Add a prominent "Enter Your Lease" call-to-action button linking to `/lease/new`
       - Add a "View Saved Leases" link to `/lease`
       - Update the subtitle from "Calculation results will appear here" to something warm and inviting: "Find out the smartest financial move for your vehicle lease."
       - Keep the page clean and simple -- it's an entry point, not a feature page

    IMPORTANT: The delete functionality requires careful implementation. Since this is a Server Component page, the delete button needs to work via either:
    - A `<form action={deleteLease.bind(null, id)}>` pattern (Server Action in form)
    - Or a small client component for the delete button with confirmation

    Choose the approach that provides the best UX (confirmation before delete is essential -- users should not accidentally lose their lease data).
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds
    - Route `/lease/new` renders LeaseEntryForm in new mode (no leaseId prop)
    - Route `/lease/[id]/edit` fetches lease and renders LeaseEntryForm with initialData
    - Route `/lease/[id]/edit` correctly converts Decimal objects to numbers and NULL to undefined for initialData
    - Route `/lease` renders lease list or empty state
    - Lease list displays "Unnamed Lease" for leases with NULL make/model (not empty string)
    - Home page `/` has navigation to lease entry and list
    - Delete button has confirmation before executing
    - 404 handled when editing non-existent lease
    - All pages have proper metadata titles
  </verify>
  <done>
    All page routes created: /lease/new (create), /lease/[id]/edit (edit with pre-fill), /lease (list with edit/delete). Home page updated with navigation to lease flow. Delete has confirmation step. Edit page correctly handles Decimal-to-number conversion and NULL-to-undefined mapping. Complete CRUD cycle works: create -> list -> edit -> delete. Lease data persists to Postgres via Drizzle ORM and survives browser sessions.
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds with all routes
- `npx tsc --noEmit` passes
- DB schema has nullable optional columns (NOT NULL only on essential fields)
- `npx drizzle-kit push` (or migrate) applies schema changes successfully
- Server actions validate with shared Zod schema (same as client)
- Decimal.js fields round-trip correctly: insert number -> stored as numeric -> read back as Decimal -> convert to number for display
- Optional fields store NULL when not provided (not empty string or 0)
- Database operations use Drizzle ORM (insert, update, delete, select)
- Mileage date stamped on create; on update, only re-stamped when currentMileage value actually changes
- Form redirects to list after successful create
- Edit page pre-fills all form fields from database (Decimal -> number, NULL -> undefined)
- Delete has confirmation before execution
- revalidatePath called after all mutations
- All pages accessible via navigation from home page
</verification>

<success_criteria>
1. Creating a new lease saves all form data to the database and redirects to lease list
2. Optional fields not filled by the user store NULL in the database (not empty string or 0)
3. Lease list page shows all saved leases with make/model/year (or "Unnamed Lease" for NULL), payment, and term info
4. Clicking "Edit" on a lease opens the form pre-filled with that lease's data
5. Saving edits updates the existing lease (not creates a new one)
6. Deleting a lease requires confirmation and removes it from the database
7. Current mileage is date-stamped with today's date on create
8. On update, mileage date only changes when currentMileage value differs from stored value
9. Decimal fields (monthlyPayment, residualValue, etc.) correctly round-trip through Decimal.js conversion
10. Server validates all data with the same Zod schema used on the client
11. Empty state shown when no leases exist, with clear call to action
12. Home page provides navigation to create new lease and view existing leases
</success_criteria>

<output>
After completion, create `.planning/phases/02-lease-entry-and-core-ui/02-03-SUMMARY.md`
</output>
