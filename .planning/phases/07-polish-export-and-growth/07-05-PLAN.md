---
phase: 07-polish-export-and-growth
plan: 05
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/lib/pdf/comparison-pdf.tsx
  - src/components/comparison/ExportButton.tsx
  - src/components/comparison/ComparisonView.tsx
  - package.json
autonomous: true

must_haves:
  truths:
    - "User can click Export PDF and download a PDF with all comparison options and cost breakdowns"
    - "PDF includes vehicle info heading, recommendation, all 6 option summaries with line items, and disclaimers"
    - "PDF library loads lazily and does not bloat the main bundle"
  artifacts:
    - path: "src/lib/pdf/comparison-pdf.tsx"
      provides: "React PDF document component for comparison data"
      contains: "@react-pdf/renderer"
    - path: "src/components/comparison/ExportButton.tsx"
      provides: "Client-side export button with lazy PDF loading"
      contains: "dynamic"
    - path: "src/components/comparison/ComparisonView.tsx"
      provides: "Renders ExportButton with comparison data"
      contains: "ExportButton"
  key_links:
    - from: "src/components/comparison/ExportButton.tsx"
      to: "src/lib/pdf/comparison-pdf.tsx"
      via: "dynamic import of PDFDownloadLink + ComparisonPDF"
      pattern: "dynamic.*import"
    - from: "src/components/comparison/ComparisonView.tsx"
      to: "src/components/comparison/ExportButton.tsx"
      via: "renders ExportButton with serialized data"
      pattern: "ExportButton"
---

<objective>
Add PDF export capability so users can download a comparison summary as a printable PDF document.

Purpose: PLSH-01 requires PDF export of comparison results. Users need to save/print their analysis for reference when visiting dealerships or discussing with family.

Output: ExportButton component in ComparisonView that lazily loads @react-pdf/renderer and generates a downloadable PDF with all options, line items, recommendation, and disclaimers.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-polish-export-and-growth/07-RESEARCH.md
@src/lib/calculations/evaluate-all.ts
@src/components/comparison/ComparisonView.tsx
@src/components/comparison/HeroSummary.tsx
@src/lib/utils/format-currency.ts
@src/lib/types/scenario.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-pdf and create PDF document template</name>
  <files>
    package.json
    src/lib/pdf/comparison-pdf.tsx
  </files>
  <action>
    1. Install: `npm install @react-pdf/renderer`

    2. Create src/lib/pdf/comparison-pdf.tsx as a 'use client' component:
       - Import Document, Page, View, Text, StyleSheet from @react-pdf/renderer
       - Define a serializable data interface (PDFComparisonData) that uses plain strings/numbers instead of Decimal:
         ```typescript
         interface PDFLineItem {
           label: string
           amount: string  // pre-formatted currency string
           description: string
           type: string
         }
         interface PDFScenarioData {
           type: string
           name: string  // formatted display name
           netCost: string  // pre-formatted currency
           totalCost: string
           lineItems: PDFLineItem[]
           warnings: string[]
           incomplete?: boolean
         }
         interface PDFComparisonData {
           heading: string  // vehicle name
           bestOptionName: string
           savingsDescription: string
           scenarios: PDFScenarioData[]
           disclaimers: string[]
           generatedDate: string
         }
         ```
       - Export this interface for use by ExportButton
       - Create ComparisonPDF component that renders:
         - Page 1: Header ("Lease Comparison Summary"), vehicle name, generated date
         - Recommendation section: "Best Move: {bestOptionName}" with savings description
         - For each scenario: Name, net cost, and line items table (label | amount)
         - Mark incomplete scenarios with "(Incomplete)" after name
         - Bottom: disclaimers in small text
       - Use StyleSheet.create for consistent styling:
         - page: padding 30, fontFamily 'Helvetica' (built-in, no font loading needed)
         - heading: fontSize 20, marginBottom 15, color '#0d9488' (teal)
         - sectionTitle: fontSize 14, fontWeight 'bold', marginTop 15, marginBottom 5
         - row: flexDirection 'row', borderBottom '0.5pt solid #e5e5e5', paddingVertical 3
         - label: width '60%', fontSize 10
         - value: width '40%', fontSize 10, textAlign 'right'
         - disclaimer: fontSize 7, color '#666', marginTop 20
       - Keep it simple -- no fancy layout. Prioritize readability and information completeness.
  </action>
  <verify>
    - `npx tsc --noEmit` passes (the component type-checks)
    - File exists with Document, Page structure
  </verify>
  <done>
    ComparisonPDF component renders a clean, readable PDF document with all scenario data, line items, recommendation, and disclaimers. Uses built-in Helvetica font (no loading delays).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ExportButton and wire into ComparisonView</name>
  <files>
    src/components/comparison/ExportButton.tsx
    src/components/comparison/ComparisonView.tsx
  </files>
  <action>
    1. Create src/components/comparison/ExportButton.tsx as 'use client':
       - Import dynamic from 'next/dynamic'
       - Import Button from ui/button and Download icon from lucide-react
       - Import PDFComparisonData type from pdf/comparison-pdf
       - Use state to track showPDF (boolean) -- PDF is only loaded when user clicks
       - Lazy load PDFDownloadLink:
         ```typescript
         const PDFDownloadLink = dynamic(
           () => import('@react-pdf/renderer').then(mod => mod.PDFDownloadLink),
           { ssr: false, loading: () => <span className="text-sm text-muted-foreground">Preparing PDF...</span> }
         )
         ```
       - Also lazy load ComparisonPDF:
         ```typescript
         const ComparisonPDF = dynamic(
           () => import('@/lib/pdf/comparison-pdf').then(mod => mod.ComparisonPDF),
           { ssr: false }
         )
         ```
       - Render flow:
         - Initial state: Button "Export PDF" with Download icon
         - On click: setShowPDF(true)
         - When showPDF is true: render PDFDownloadLink wrapping ComparisonPDF, with fileName="lease-comparison.pdf"
         - The PDFDownloadLink children is a render function that receives { loading }) => shows "Preparing..." or "Download PDF"

       - Props: { data: PDFComparisonData }

    2. Update ComparisonView.tsx:
       - Import ExportButton
       - ComparisonView needs to convert ComparisonData (with Decimal) to PDFComparisonData (with strings)
       - Create a helper function serializeForPDF(data: ComparisonData, heading: string): PDFComparisonData that:
         - Maps each scenario to PDFScenarioData with formatCurrency for amounts
         - Uses formatOptionName for display names
         - Formats disclaimers
         - Sets generatedDate to new Date().toLocaleDateString()
       - Render ExportButton in the header area (next to the heading or in a toolbar):
         - Place it after the MarketValue section, before HeroSummary
         - Or place it as a small button in the top-right corner: `<div className="flex justify-end mb-4"><ExportButton data={pdfData} /></div>`
       - ComparisonView currently receives `data` prop but not vehicle heading. Either:
         a. Pass heading as a new prop from compare/page.tsx, OR
         b. Add leaseHeading prop to ComparisonView
         Choose (a) -- add optional `heading?: string` prop to ComparisonViewProps

       Note: ComparisonView is currently a server component (no 'use client'). ExportButton is a client component. This is fine -- server components can render client components. But the data prop to ExportButton must be serializable. The serializeForPDF helper must run server-side (in ComparisonView) and pass plain objects to ExportButton.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds (no SSR errors from react-pdf)
    - Dev server: clicking "Export PDF" on compare page shows "Preparing..." then "Download PDF" link
    - Downloaded PDF contains all scenario names and costs
  </verify>
  <done>
    ExportButton appears on comparison page. Clicking it lazily loads react-pdf and generates a downloadable PDF. PDF contains vehicle heading, best option recommendation, all 6 scenarios with line items, and disclaimers. Main bundle is not bloated (react-pdf loaded on demand).
  </done>
</task>

</tasks>

<verification>
- Click "Export PDF" on comparison page -> PDF downloads
- PDF includes: heading, recommendation, all scenario costs, line items per scenario, disclaimers, date
- `npm run build` succeeds (no SSR/bundling errors)
- Main page load doesn't fetch react-pdf bundle (lazy loaded only on click)
</verification>

<success_criteria>
- PDF export works end-to-end from button click to downloaded file
- PDF contains complete comparison data (all options, line items, recommendation, disclaimers)
- react-pdf loads lazily (not in main bundle)
- No build errors or SSR issues
</success_criteria>

<output>
After completion, create `.planning/phases/07-polish-export-and-growth/07-05-SUMMARY.md`
</output>
