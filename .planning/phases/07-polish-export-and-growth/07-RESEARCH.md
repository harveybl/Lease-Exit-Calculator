# Phase 7: Polish, Export, and Growth - Research

**Researched:** 2026-01-31
**Domain:** Production polish (PDF export, PWA, accessibility, responsive design, client storage)
**Confidence:** HIGH

## Summary

Phase 7 focuses on five distinct production-readiness domains: PDF export, PWA installability, WCAG 2.1 AA accessibility compliance, mobile-responsive layout, and adding lease transfer as a sixth comparison option. This research identifies the standard stack and patterns for each domain.

For PDF generation, `@react-pdf/renderer` is the React-native approach but requires client-side rendering workarounds with Next.js Server Components. For PWA support, Next.js 16 requires Serwist (not the unmaintained `next-pwa`) due to Turbopack compatibility. Accessibility testing uses `jest-axe` integrated with React Testing Library, plus Lighthouse audits for automated WCAG checks. Responsive design leverages Tailwind's mobile-first breakpoints already in use. IndexedDB with Dexie.js provides client-side storage for GitHub Pages deployment scenarios.

**Primary recommendation:** Use established libraries (react-pdf, Serwist, jest-axe, Dexie) with lazy loading for heavy dependencies. Follow mobile-first Tailwind patterns, semantic HTML-first for accessibility, and Lighthouse-driven PWA development.

## Standard Stack

The established libraries/tools for this domain:

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| @react-pdf/renderer | 4.3.2 | PDF generation with React components | React-first approach, JSX/CSS syntax, 30K+ GitHub stars |
| @serwist/next | Latest | PWA service worker for Next.js 16 | Turbopack compatible, next-pwa successor |
| jest-axe | Latest | Automated accessibility testing | Integrates with React Testing Library, zero false positives |
| axe-core | Latest | WCAG rule engine | 3B+ downloads, 57% automated WCAG coverage |
| dexie | Latest | IndexedDB wrapper | Simplified API, Next.js compatible, widely adopted |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| Lighthouse | Built-in Chrome | PWA/accessibility audits | Verify PWA badge, check WCAG violations |
| next/dynamic | Built-in Next.js | Lazy loading | Reduce bundle size for PDF libraries |
| focus-trap-react | Latest | Focus management | Modal dialogs, keyboard navigation |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| @react-pdf/renderer | jsPDF | jsPDF simpler for basic tables but lacks React component model |
| @react-pdf/renderer | pdfmake | pdfmake JSON-first, good for complex layouts but less React-native |
| Serwist | @ducanh2912/next-pwa | Fork requires --webpack flag with Next.js 16/Turbopack |
| Dexie | localForage | localForage simpler API but less type-safe |
| jest-axe | Manual testing only | Manual catches 40-50% missed by automated, use both |

**Installation:**
```bash
npm install @react-pdf/renderer @serwist/next dexie
npm install -D jest-axe
```

## Architecture Patterns

### Recommended Project Structure
```
src/
├── lib/
│   ├── pdf/                 # PDF generation
│   │   ├── export.ts        # Server action for PDF buffer
│   │   └── templates/       # PDF document components
│   ├── storage/             # Client-side IndexedDB
│   │   └── db.ts            # Dexie database instance
│   └── accessibility/       # ARIA utilities
└── app/
    ├── manifest.ts          # PWA manifest (Next.js 16 typed)
    └── sw.ts                # Custom service worker logic (optional)

public/
├── icons/                   # PWA icons (192x192, 512x512, maskable)
└── workbox-*.js            # Auto-generated by Serwist
```

### Pattern 1: PDF Export with Dynamic Import
**What:** Generate PDF from comparison data without bloating main bundle
**When to use:** User-initiated export action (button click)
**Example:**
```typescript
// Source: https://nextjs.org/docs/pages/guides/lazy-loading
'use client'

import { useState } from 'react'
import dynamic from 'next/dynamic'

// Lazy load PDF library (500KB+ not in main bundle)
const PDFDownloadLink = dynamic(
  () => import('@react-pdf/renderer').then(mod => mod.PDFDownloadLink),
  { ssr: false, loading: () => <span>Preparing PDF...</span> }
)

export function ExportButton({ data }: { data: ComparisonData }) {
  const [showPDF, setShowPDF] = useState(false)

  return (
    <>
      <Button onClick={() => setShowPDF(true)}>Export PDF</Button>
      {showPDF && (
        <PDFDownloadLink document={<ComparisonPDF data={data} />} fileName="lease-comparison.pdf">
          Download
        </PDFDownloadLink>
      )}
    </>
  )
}
```

### Pattern 2: PWA Configuration with Serwist
**What:** Service worker registration and manifest for installability
**When to use:** All production deployments requiring offline support
**Example:**
```typescript
// Source: https://ducanh-next-pwa.vercel.app/docs/next-pwa/getting-started
// next.config.js
const withSerwist = require('@serwist/next').default({
  swSrc: 'app/sw.ts',
  swDest: 'public/sw.js',
})

module.exports = withSerwist({
  // Next.js config
})

// public/manifest.json
{
  "name": "Lease Tracker",
  "short_name": "Lease",
  "icons": [
    { "src": "/icons/icon-192.png", "sizes": "192x192", "type": "image/png" },
    { "src": "/icons/icon-512.png", "sizes": "512x512", "type": "image/png" },
    { "src": "/icons/icon-maskable.png", "sizes": "512x512", "type": "image/png", "purpose": "maskable" }
  ],
  "theme_color": "#0d9488",  // teal primary from Phase 2
  "background_color": "#fafaf7",  // warm off-white from Phase 2
  "display": "standalone",
  "start_url": "/"
}
```

### Pattern 3: Accessibility Testing with jest-axe
**What:** Automated WCAG violation detection in component tests
**When to use:** Every React component with interactive elements or complex layouts
**Example:**
```typescript
// Source: https://github.com/dequelabs/axe-core/blob/develop/doc/examples/jest_react/README.md
import { render } from '@testing-library/react'
import { axe, toHaveNoViolations } from 'jest-axe'

expect.extend(toHaveNoViolations)

it('ComparisonTable should have no accessibility violations', async () => {
  const { container } = render(<ComparisonTable options={mockOptions} />)
  const results = await axe(container)
  expect(results).toHaveNoViolations()
})
```

### Pattern 4: Responsive Table Pattern (Mobile-First)
**What:** Transform comparison table to stacked cards on mobile
**When to use:** Data tables with 4+ columns on mobile screens
**Example:**
```tsx
// Source: https://tailwindcss.com/docs/responsive-design + https://medium.com/design-bootcamp/designing-user-friendly-data-tables-for-mobile-devices-c470c82403ad
export function ComparisonView({ options }: Props) {
  return (
    <>
      {/* Mobile: Stacked cards with progressive disclosure */}
      <div className="lg:hidden space-y-4">
        {options.map(option => (
          <Card key={option.id}>
            <CardHeader>
              <h3>{option.name}</h3>
              <p className="text-2xl font-bold">{formatCurrency(option.total)}</p>
            </CardHeader>
            <Collapsible>
              <CollapsibleTrigger>View Details</CollapsibleTrigger>
              <CollapsibleContent>
                {/* Line items */}
              </CollapsibleContent>
            </Collapsible>
          </Card>
        ))}
      </div>

      {/* Desktop: Full comparison table */}
      <div className="hidden lg:block">
        <table className="w-full">
          {/* Traditional table layout */}
        </table>
      </div>
    </>
  )
}
```

### Pattern 5: IndexedDB for Client-Side Storage
**What:** Persist lease data client-side for GitHub Pages deployment
**When to use:** When deploying to static hosts without database access
**Example:**
```typescript
// Source: https://dexie.org/ + https://webkul.com/blog/how-to-use-indexeddb-dexie-in-nextjs/
// lib/storage/db.ts
'use client'

import Dexie, { type EntityTable } from 'dexie'

interface Lease {
  id: string
  createdAt: Date
  vehicleInfo: object
  // ... other fields
}

// Only initialize in browser
const db = typeof window !== 'undefined'
  ? new Dexie('LeaseTracker') as Dexie & { leases: EntityTable<Lease, 'id'> }
  : null

db?.version(1).stores({
  leases: 'id, createdAt'
})

export { db }
```

### Pattern 6: Keyboard Navigation and Focus Management
**What:** Ensure all interactive elements reachable via keyboard, manage focus traps
**When to use:** Modal dialogs, collapsible sections, complex forms
**Example:**
```tsx
// Source: https://developer.mozilla.org/en-US/docs/Learn_web_development/Core/Frameworks_libraries/React_accessibility
'use client'

import { useRef, useEffect } from 'react'
import FocusTrap from 'focus-trap-react'

export function ComparisonModal({ isOpen, onClose, children }: Props) {
  const closeButtonRef = useRef<HTMLButtonElement>(null)

  // Set focus to close button when modal opens
  useEffect(() => {
    if (isOpen) {
      closeButtonRef.current?.focus()
    }
  }, [isOpen])

  if (!isOpen) return null

  return (
    <FocusTrap>
      <div role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <button
          ref={closeButtonRef}
          onClick={onClose}
          aria-label="Close modal"
        >
          ×
        </button>
        <h2 id="modal-title">{/* ... */}</h2>
        {children}
      </div>
    </FocusTrap>
  )
}
```

### Anti-Patterns to Avoid
- **Server-side rendering PDFDownloadLink:** Causes hydration errors, always use `dynamic` with `ssr: false`
- **Global PDF library import:** 500KB+ bundle impact, lazy load on user action
- **Transparent PWA icons:** iOS/Android fill transparency unpredictably, use solid background
- **ARIA over semantic HTML:** First rule of ARIA: prefer native elements (button, table) over div+role
- **Fixed-width mobile tables:** Never require horizontal scroll for critical data on mobile
- **Color-only indicators:** "Green = savings" fails for color-blind users, add text prefix
- **No focus visible styles:** Keyboard users can't see focused element, ensure `:focus-visible` styles exist

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| PDF generation | Custom canvas/HTML2Canvas pipeline | @react-pdf/renderer | Edge cases: fonts, page breaks, orphan/widow control, PDF metadata |
| Service workers | Manual SW registration/caching | Serwist/Workbox | Edge cases: cache invalidation, version updates, race conditions |
| Accessibility testing | Manual keyboard/screen reader checks only | jest-axe + Lighthouse | Automated catches 57% of WCAG issues, manual catches rest |
| IndexedDB raw API | Direct indexedDB API calls | Dexie.js | Edge cases: versioning, migrations, transactions, Safari quirks |
| Focus trapping | Custom keyboard event handlers | focus-trap-react | Edge cases: nested traps, tab wrapping, initially focused element |
| Color contrast checking | Manual hex comparison | WebAIM contrast checker | Math: WCAG 2.1 relative luminance formula complex, tools do it right |
| Responsive tables | Horizontal scroll on mobile | Card/stack pattern | UX: users struggle with 2D scroll, vertical scroll natural on mobile |

**Key insight:** Production polish domains have mature, battle-tested libraries. Custom solutions miss edge cases discovered over years by thousands of users. Invest time in integration, not reinvention.

## Common Pitfalls

### Pitfall 1: PDF Generation in Server Components
**What goes wrong:** `@react-pdf/renderer` uses browser APIs, fails with "Component is not a constructor" in RSC/server actions
**Why it happens:** React Server Components run in Node.js environment without DOM/Canvas APIs
**How to avoid:** Always use `'use client'` directive for PDF components, lazy load with `next/dynamic` and `ssr: false`
**Warning signs:** Build errors mentioning "document is not defined" or "canvas" in server context

### Pitfall 2: PWA Manifest Theme Color Mismatch
**What goes wrong:** User installs PWA, sees white/default theme instead of brand colors
**Why it happens:** `theme_color` in manifest.json doesn't match `<meta name="theme-color">` in HTML head
**How to avoid:** Use same color value in both manifest.json and Next.js metadata exports, reference design tokens from Phase 2
**Warning signs:** Task switcher shows wrong color, install prompt doesn't match brand

### Pitfall 3: Accessibility Testing False Confidence
**What goes wrong:** jest-axe passes all tests, but screen reader users report broken experience
**Why it happens:** Automated tools catch only 57% of WCAG issues (color contrast, missing labels), miss 40-50% (focus management, logical tab order, dynamic content announcements)
**How to avoid:** Combine jest-axe (automated) + manual keyboard navigation + screen reader testing (VoiceOver/NVDA) + Lighthouse audits
**Warning signs:** Low axe violation count but complex interactions untested manually

### Pitfall 4: Horizontal Scroll on Mobile Tables
**What goes wrong:** Comparison table requires horizontal scrolling on mobile, users miss columns
**Why it happens:** Desktop table structure forced onto mobile without responsive pattern
**How to avoid:** Use stacked card layout on mobile (`lg:hidden` for cards, `hidden lg:block` for table), progressive disclosure with Collapsible
**Warning signs:** Lighthouse flags "content wider than viewport", user testing shows frustration

### Pitfall 5: Color-Only Differentiation
**What goes wrong:** Color-blind users can't distinguish "green credit" vs "red cost" without additional cues
**Why it happens:** Relying solely on color violates WCAG 1.4.1 Use of Color
**How to avoid:** Always pair color with text prefix ("You receive:" for credits from Phase 3), icons, or patterns
**Warning signs:** axe-core flags color contrast, simulator shows indistinguishable elements

### Pitfall 6: Service Worker Cache Staleness
**What goes wrong:** Users see old UI after deploy, hard refresh doesn't help
**Why it happens:** Service worker serves cached assets, doesn't check for updates
**How to avoid:** Serwist auto-generates cache-busting with workbox strategies, add version check prompt for major updates
**Warning signs:** Users report seeing old features after deploy announced

### Pitfall 7: IndexedDB Hydration Issues
**What goes wrong:** `ReferenceError: indexedDB is not defined` during SSR
**Why it happens:** IndexedDB only exists in browser, Next.js tries to run code server-side
**How to avoid:** Guard Dexie initialization with `typeof window !== 'undefined'`, use `'use client'` directive for components using db
**Warning signs:** Build failures or runtime errors mentioning window/indexedDB undefined

### Pitfall 8: Missing Maskable Icon
**What goes wrong:** PWA icon looks cropped on Android adaptive icon backgrounds
**Why it happens:** Android masks icons to various shapes (circle, squircle), icon content extends beyond safe zone
**How to avoid:** Generate maskable icon variant with 40% safe zone radius, add `"purpose": "maskable"` to manifest
**Warning signs:** Icon content cut off on Android home screen

### Pitfall 9: PDF Font Loading Performance
**What goes wrong:** PDF export hangs or times out, especially with custom fonts
**Why it happens:** react-pdf loads fonts synchronously, large font files block rendering
**How to avoid:** Use system fonts for PDFs where possible, pre-register custom fonts once with `Font.register()`, avoid loading fonts per document instance
**Warning signs:** Slow "Preparing PDF" spinner, browser console shows font fetch errors

### Pitfall 10: Keyboard Trap in Modal
**What goes wrong:** Tab key escapes modal dialog, focuses background elements
**Why it happens:** No focus trap, browser's default tab order includes background DOM
**How to avoid:** Use `focus-trap-react` for modals, set `aria-modal="true"` and `role="dialog"`, return focus to trigger element on close
**Warning signs:** Keyboard users can't reach all modal controls, focus disappears into background

## Code Examples

Verified patterns from official sources:

### PDF Document Structure
```tsx
// Source: https://react-pdf.org
import { Document, Page, View, Text, StyleSheet } from '@react-pdf/renderer'

const styles = StyleSheet.create({
  page: { padding: 30 },
  section: { marginBottom: 10 },
  heading: { fontSize: 18, marginBottom: 10 },
  row: { flexDirection: 'row', borderBottom: '1pt solid #ddd', padding: 5 },
  label: { width: '50%', fontSize: 12 },
  value: { width: '50%', fontSize: 12, textAlign: 'right' },
})

export function ComparisonPDF({ data }: { data: ComparisonData }) {
  return (
    <Document>
      <Page size="A4" style={styles.page}>
        <View style={styles.section}>
          <Text style={styles.heading}>Lease Comparison Summary</Text>
        </View>
        {data.options.map(option => (
          <View key={option.id} style={styles.section}>
            <Text>{option.name}</Text>
            {option.lineItems.map(item => (
              <View style={styles.row} key={item.label}>
                <Text style={styles.label}>{item.label}</Text>
                <Text style={styles.value}>{item.value}</Text>
              </View>
            ))}
          </View>
        ))}
      </Page>
    </Document>
  )
}
```

### ARIA Labels for Comparison Table
```tsx
// Source: https://developer.mozilla.org/en-US/docs/Web/Accessibility/ARIA
export function ComparisonTable({ options }: { options: Option[] }) {
  return (
    <table aria-label="Lease option comparison">
      <thead>
        <tr>
          <th scope="col">Option</th>
          <th scope="col">Total Cost</th>
          <th scope="col">Upfront</th>
          <th scope="col">Timeline</th>
        </tr>
      </thead>
      <tbody>
        {options.map(option => (
          <tr key={option.id}>
            <th scope="row">{option.name}</th>
            <td aria-label={`Total cost: ${formatCurrency(option.total)}`}>
              {formatCurrency(option.total)}
            </td>
            <td>{formatCurrency(option.upfront)}</td>
            <td>{option.timeline}</td>
          </tr>
        ))}
      </tbody>
    </table>
  )
}
```

### Serwist Service Worker
```typescript
// Source: https://ducanh-next-pwa.vercel.app/docs/next-pwa/getting-started
// app/sw.ts (optional custom logic)
import { defaultCache } from '@serwist/next/worker'
import type { PrecacheEntry, SerwistGlobalConfig } from 'serwist'
import { Serwist } from 'serwist'

declare global {
  interface WorkerGlobalScope extends SerwistGlobalConfig {
    __SW_MANIFEST: (PrecacheEntry | string)[] | undefined
  }
}

declare const self: ServiceWorkerGlobalScope

const serwist = new Serwist({
  precacheEntries: self.__SW_MANIFEST,
  skipWaiting: true,
  clientsClaim: true,
  navigationPreload: true,
  runtimeCaching: defaultCache,
})

serwist.addEventListeners()
```

### Focus Visible Styles (Tailwind)
```tsx
// Source: https://tailwindcss.com/docs/hover-focus-and-other-states
// Ensure keyboard focus is visible for accessibility
<Button
  className="
    focus:outline-none
    focus-visible:ring-2
    focus-visible:ring-primary
    focus-visible:ring-offset-2
  "
>
  Export PDF
</Button>
```

### Dexie Query Patterns
```typescript
// Source: https://dexie.org/
import { db } from '@/lib/storage/db'

// Add lease
async function saveLease(lease: Lease) {
  await db.leases.add(lease)
}

// Get all leases sorted by date
async function getLeases() {
  return await db.leases.orderBy('createdAt').reverse().toArray()
}

// Update lease
async function updateLease(id: string, changes: Partial<Lease>) {
  await db.leases.update(id, changes)
}

// Delete lease
async function deleteLease(id: string) {
  await db.leases.delete(id)
}
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| next-pwa (shadowwalker) | Serwist | 2024 | next-pwa unmaintained, Serwist supports Turbopack in Next.js 16 |
| jsPDF for React | @react-pdf/renderer | 2018+ | react-pdf enables component-based PDF authoring vs imperative API |
| Manual axe-core setup | jest-axe matcher | 2019+ | jest-axe simplifies integration with RTL, cleaner assertions |
| localStorage for data | IndexedDB via Dexie | 2020+ | IndexedDB handles larger datasets (100MB+), structured queries |
| tabindex="0" everywhere | Semantic HTML + focus-visible | 2021+ | Browsers support :focus-visible, avoid tab stop pollution |
| WCAG 2.0 AA | WCAG 2.1/2.2 AA | 2018/2023 | New criteria: 1.4.10 Reflow, 1.4.11 Non-text Contrast, 2.5.3 Label in Name |

**Deprecated/outdated:**
- **next-pwa (shadowwalker/next-pwa):** Package unmaintained since 2024, use @serwist/next or @ducanh2912/next-pwa fork
- **react-to-pdf via html2canvas:** Poor quality for text/tables, use react-pdf native rendering
- **Chrome-only PWA testing:** Test installability on iOS Safari (different manifest requirements)
- **Color contrast 3:1 for all text:** WCAG AA requires 4.5:1 for normal text, 3:1 only for large text (18pt+)

## Open Questions

Things that couldn't be fully resolved:

1. **Lease transfer cost variability by leasing company**
   - What we know: Transfer fees range $75-$895, marketplace fees $60-$200, state taxes vary
   - What's unclear: No API exists for real-time transfer fee lookup by VIN or leasing company
   - Recommendation: Provide input field for "transfer fee" with tooltip explaining typical range, default to $400 (midpoint)

2. **Next.js 16 static export with Serwist**
   - What we know: Serwist works with Next.js 16 App Router, generates service worker
   - What's unclear: Official docs don't explicitly confirm `output: 'export'` compatibility with Serwist
   - Recommendation: Test static export build, verify sw.js loads on GitHub Pages, fallback to runtime Postgres if issues arise

3. **Screen reader testing coverage**
   - What we know: jest-axe automates 57% of WCAG checks, manual testing needed for rest
   - What's unclear: How much manual testing is "enough" for this project scope
   - Recommendation: Minimum test with VoiceOver (macOS) on Safari and NVDA (Windows) on Chrome, focus on comparison table and form flows

4. **PDF generation with Decimal.js formatting**
   - What we know: Decimal values serialize to strings across RSC boundary (Phase 3)
   - What's unclear: react-pdf performance with 100+ line items across 6 options
   - Recommendation: Pass pre-formatted string values to PDF component, test with maximum data scenario

## Sources

### Primary (HIGH confidence)
- Context7: Next.js, Tailwind CSS (responsive design, lazy loading patterns)
- Official docs: https://react-pdf.org (PDF generation patterns)
- Official docs: https://ducanh-next-pwa.vercel.app/docs/next-pwa/getting-started (Serwist configuration)
- Official docs: https://www.deque.com/axe/axe-core (axe-core capabilities, WCAG support)
- Official docs: https://developer.mozilla.org/en-US/docs/Web/Accessibility/ARIA (ARIA patterns)
- Official docs: https://dexie.org (IndexedDB wrapper patterns)

### Secondary (MEDIUM confidence)
- WebSearch verified: https://medium.com/@ansonch/top-6-open-source-pdf-libraries-for-react-developers-62033fca5fff (PDF library comparison Jan 2025)
- WebSearch verified: https://www.buildwithmatija.com/blog/turn-nextjs-16-app-into-pwa (Next.js 16 PWA guide)
- WebSearch verified: https://oneuptime.com/blog/post/2026-01-15-test-react-accessibility-axe-core/view (jest-axe integration Jan 2026)
- WebSearch verified: https://tailwindcss.com/docs/responsive-design (Tailwind mobile-first approach)
- WebSearch verified: https://medium.com/design-bootcamp/designing-user-friendly-data-tables-for-mobile-devices-c470c82403ad (Mobile table patterns)
- WebSearch verified: https://www.allaccessible.org/blog/color-contrast-accessibility-wcag-guide-2025 (WCAG color contrast 2025)

### Tertiary (LOW confidence)
- WebSearch: Lease transfer fees ($75-$895 range) - multiple sources but no authoritative API, marked for user confirmation
- WebSearch: Next.js static export + Serwist - implied by docs but not explicitly verified, marked for testing

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - All libraries have official docs, active maintenance (react-pdf 4.3.2 released Jan 2026, jest-axe actively maintained, Serwist is official next-pwa successor)
- Architecture: HIGH - Patterns verified from official Next.js docs (lazy loading), react-pdf docs (PDF structure), MDN (ARIA), Dexie docs (IndexedDB)
- Pitfalls: MEDIUM - Common issues documented in GitHub issues, Stack Overflow, and blog posts; some based on general Next.js SSR/CSR patterns

**Research date:** 2026-01-31
**Valid until:** 2026-03-15 (45 days) - PWA standards stable, libraries mature; react-pdf and Serwist may release minor versions
