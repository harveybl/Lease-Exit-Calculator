---
phase: 07-polish-export-and-growth
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/lib/types/scenario.ts
  - src/lib/calculations/scenarios/lease-transfer.ts
  - src/lib/calculations/scenarios/index.ts
  - src/__tests__/lib/calculations/scenarios/lease-transfer.test.ts
autonomous: true

must_haves:
  truths:
    - "Lease transfer scenario produces an itemized cost breakdown with transfer fee, remaining payments, registration, and marketplace fee"
    - "Transfer net cost equals total out-of-pocket minus payments transferred to new lessee"
    - "Warnings fire when transfer fee exceeds $500 or when lease has fewer than 6 months remaining"
  artifacts:
    - path: "src/lib/types/scenario.ts"
      provides: "LeaseTransferResult type and 'lease-transfer' added to ScenarioType union"
      contains: "lease-transfer"
    - path: "src/lib/calculations/scenarios/lease-transfer.ts"
      provides: "evaluateLeaseTransferScenario pure function"
      exports: ["evaluateLeaseTransferScenario"]
    - path: "src/__tests__/lib/calculations/scenarios/lease-transfer.test.ts"
      provides: "Test coverage for lease transfer scenario"
      min_lines: 50
  key_links:
    - from: "src/lib/calculations/scenarios/lease-transfer.ts"
      to: "src/lib/types/scenario.ts"
      via: "import LeaseTransferResult type"
      pattern: "import.*LeaseTransferResult"
    - from: "src/lib/calculations/scenarios/index.ts"
      to: "src/lib/calculations/scenarios/lease-transfer.ts"
      via: "re-export"
      pattern: "export.*evaluateLeaseTransferScenario"
---

<objective>
Build the lease transfer/swap scenario evaluator as the sixth comparison option using TDD.

Purpose: PLSH-05 requires lease transfer as a sixth exit option. The calculation must exist and be tested before it can be wired into the comparison view, timeline, and PDF export. This is a pure-function with defined inputs/outputs -- ideal for TDD.

Output: Tested `evaluateLeaseTransferScenario` function, `LeaseTransferResult` type, and `ScenarioType` union updated to include `'lease-transfer'`.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-polish-export-and-growth/07-RESEARCH.md
@src/lib/types/scenario.ts
@src/lib/calculations/scenarios/return.ts
@src/lib/calculations/scenarios/index.ts
@src/lib/decimal.ts
@src/lib/disclaimers.ts
</context>

<feature>
  <name>Lease Transfer Scenario Evaluator</name>
  <files>
    src/lib/calculations/scenarios/lease-transfer.ts
    src/__tests__/lib/calculations/scenarios/lease-transfer.test.ts
    src/lib/types/scenario.ts
    src/lib/calculations/scenarios/index.ts
  </files>
  <behavior>
    Lease transfer allows the lessee to transfer their lease to a new person, avoiding remaining payments.

    Inputs:
    - transferFee: Decimal (leasing company fee, typically $75-$895)
    - marketplaceFee: Decimal (SwapALease/LeaseTrader listing fee, typically $60-$200)
    - registrationFee: Decimal (new lessee registration/title transfer)
    - remainingPayments: Decimal (total of remaining monthly payments)
    - monthsRemaining: number
    - monthlyPayment: Decimal (for calculating per-month savings)
    - dispositionFee: Decimal (often waived in transfers, but include for safety)
    - incentivePayments: Decimal (payments to sweeten deal for buyer, default 0)

    Output: LeaseTransferResult with:
    - type: 'lease-transfer'
    - totalCost: transferFee + marketplaceFee + registrationFee + incentivePayments
    - netCost: totalCost (the actual out-of-pocket to get out of the lease via transfer)
    - lineItems: itemized breakdown of each fee
    - warnings: high fee warning (>$500 transfer fee), short lease warning (<6 months remaining)
    - disclaimers: transfer approval disclaimer, timeline disclaimer
    - transferFee, marketplaceFee, registrationFee, incentivePayments (scenario-specific fields)
    - paymentsAvoided: remainingPayments (what you save by not paying out the lease)

    Test cases:
    - Standard transfer: $400 transfer fee, $100 marketplace, $150 registration, 18 months remaining at $450/month
      -> totalCost = $650, netCost = $650, paymentsAvoided = $8,100
    - Transfer with incentive: same + $200 incentive -> totalCost = $850, netCost = $850
    - Zero fees: all fees 0 -> totalCost = 0, netCost = 0
    - High fee warning: $600 transfer fee -> warnings includes "Transfer fee exceeds $500"
    - Short lease warning: 4 months remaining -> warnings includes "fewer than 6 months"
    - Line items: exactly 4 items (transfer fee, marketplace fee, registration, incentive) when incentive > 0, 3 when incentive = 0
  </behavior>
  <implementation>
    1. Update ScenarioType union in src/lib/types/scenario.ts to add 'lease-transfer'
    2. Add LeaseTransferResult interface extending ScenarioResult with scenario-specific fields
    3. Create evaluateLeaseTransferScenario function following same pattern as return.ts:
       - Accept params object
       - Build lineItems array (only include incentive line item if > 0)
       - Calculate totalCost as sum of fees + incentive
       - netCost = totalCost
       - paymentsAvoided = remainingPayments
       - Build warnings array conditionally
       - Include DISCLAIMERS.general + a transfer-specific disclaimer
    4. Re-export from scenarios/index.ts
  </implementation>
</feature>

<verification>
- `npm run test -- --run src/__tests__/lib/calculations/scenarios/lease-transfer.test.ts` passes all test cases
- TypeScript compiles: `npx tsc --noEmit` passes
- Existing tests still pass: `npm test` passes
</verification>

<success_criteria>
- ScenarioType includes 'lease-transfer'
- LeaseTransferResult interface exists with transferFee, marketplaceFee, registrationFee, incentivePayments, paymentsAvoided
- evaluateLeaseTransferScenario produces correct totals for standard, incentive, and zero-fee cases
- Warnings fire for high transfer fee (>$500) and short remaining term (<6 months)
- All existing tests pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/07-polish-export-and-growth/07-01-SUMMARY.md`
</output>
