---
phase: 07-polish-export-and-growth
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - next.config.ts
  - src/app/manifest.ts
  - src/app/sw.ts
  - src/app/layout.tsx
  - public/icons/icon-192.png
  - public/icons/icon-512.png
  - public/icons/icon-maskable.png
autonomous: true

must_haves:
  truths:
    - "App can be installed to phone home screen via PWA install prompt"
    - "manifest.json serves correctly with name, icons, theme_color, and display standalone"
    - "Service worker registers and caches app shell for offline access"
  artifacts:
    - path: "src/app/manifest.ts"
      provides: "PWA manifest with app name, icons, theme/background colors"
      exports: ["default"]
    - path: "src/app/sw.ts"
      provides: "Serwist service worker with precaching and runtime caching"
      contains: "serwist"
    - path: "next.config.ts"
      provides: "Next.js config wrapped with withSerwist"
      contains: "withSerwist"
  key_links:
    - from: "next.config.ts"
      to: "src/app/sw.ts"
      via: "Serwist swSrc configuration"
      pattern: "swSrc.*sw"
    - from: "src/app/layout.tsx"
      to: "src/app/manifest.ts"
      via: "Next.js metadata manifest link"
      pattern: "manifest"
---

<objective>
Configure Progressive Web App support so the application is installable on phone home screens and caches the app shell for offline access.

Purpose: PLSH-03 requires PWA installability. Users checking their lease options on their phone should be able to install it as an app-like experience.

Output: Working PWA with manifest, service worker via Serwist, and installability verified via Lighthouse.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-polish-export-and-growth/07-RESEARCH.md
@src/app/layout.tsx
@next.config.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Serwist and configure PWA manifest</name>
  <files>
    package.json
    src/app/manifest.ts
    src/app/layout.tsx
    public/icons/icon-192.png
    public/icons/icon-512.png
    public/icons/icon-maskable.png
  </files>
  <action>
    1. Install Serwist: `npm install @serwist/next` and `npm install -D serwist`

    2. Create src/app/manifest.ts using Next.js typed manifest:
       ```typescript
       import type { MetadataRoute } from 'next'

       export default function manifest(): MetadataRoute.Manifest {
         return {
           name: 'Lease Tracker',
           short_name: 'Lease',
           description: 'Vehicle lease exit option comparison tool',
           start_url: '/',
           display: 'standalone',
           background_color: '#fafaf7',  // warm off-white from Phase 2
           theme_color: '#0d9488',       // teal primary from Phase 2
           icons: [
             { src: '/icons/icon-192.png', sizes: '192x192', type: 'image/png' },
             { src: '/icons/icon-512.png', sizes: '512x512', type: 'image/png' },
             { src: '/icons/icon-maskable.png', sizes: '512x512', type: 'image/png', purpose: 'maskable' },
           ],
         }
       }
       ```

    3. Update src/app/layout.tsx metadata to include theme-color:
       - Add `themeColor: '#0d9488'` to the metadata export
       - This ensures `<meta name="theme-color">` matches manifest

    4. Generate PWA icons:
       - Create simple placeholder icons (teal background with "LT" text) using a canvas script or download from a favicon generator
       - Generate 192x192, 512x512, and 512x512 maskable (with 40% safe zone padding) PNG files
       - Place in public/icons/
       - Use a simple Node.js script with canvas to generate these, OR use placeholder SVG-to-PNG. If canvas is not available, create minimal valid PNG files (even solid teal squares are acceptable for now -- the icons can be refined later)
  </action>
  <verify>
    - `npm run build` succeeds
    - manifest.ts exports correct shape (check /manifest.webmanifest in dev server response)
    - Icons exist in public/icons/ directory
  </verify>
  <done>
    manifest.ts serves app name, icons, and theme colors. Layout metadata includes themeColor. Icon files exist in public/icons/.
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure Serwist service worker and Next.js integration</name>
  <files>
    next.config.ts
    src/app/sw.ts
  </files>
  <action>
    1. Create src/app/sw.ts with Serwist service worker:
       ```typescript
       import { defaultCache } from '@serwist/next/worker'
       import type { PrecacheEntry, SerwistGlobalConfig } from 'serwist'
       import { Serwist } from 'serwist'

       declare global {
         interface WorkerGlobalScope extends SerwistGlobalConfig {
           __SW_MANIFEST: (PrecacheEntry | string)[] | undefined
         }
       }

       declare const self: ServiceWorkerGlobalScope

       const serwist = new Serwist({
         precacheEntries: self.__SW_MANIFEST,
         skipWaiting: true,
         clientsClaim: true,
         navigationPreload: true,
         runtimeCaching: defaultCache,
       })

       serwist.addEventListeners()
       ```

    2. Update next.config.ts to wrap with Serwist:
       ```typescript
       import withSerwistInit from '@serwist/next'

       const withSerwist = withSerwistInit({
         swSrc: 'src/app/sw.ts',
         swDest: 'public/sw.js',
         disable: process.env.NODE_ENV === 'development', // Disable in dev to avoid caching issues
       })

       const nextConfig = {
         // existing config
       }

       export default withSerwist(nextConfig)
       ```

       Note: Check the actual @serwist/next API. The import might be `import { withSerwist } from '@serwist/next'` or a default export. Consult the installed package's types to get the correct import. The `disable` option prevents service worker in development mode which avoids stale cache issues during dev.

    3. Add `public/sw.js` to .gitignore (it's auto-generated by Serwist during build)
       - Also add `public/workbox-*.js` and `public/swe-worker-*.js` if Serwist generates those
  </action>
  <verify>
    - `npm run build` succeeds without errors
    - `public/sw.js` is generated during build
    - Dev server starts: `npm run dev` works (SW disabled in dev)
  </verify>
  <done>
    Service worker is configured via Serwist, auto-generates during build. Next.js config wraps with withSerwist. SW is disabled in development mode. Generated files are gitignored.
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- Production build includes sw.js in public/
- manifest.webmanifest accessible at /_next/... or /manifest.webmanifest
- Dev server starts without errors
</verification>

<success_criteria>
- PWA manifest serves with correct name, icons, theme_color, display: standalone
- Service worker builds and registers in production mode
- No dev server disruption (SW disabled in dev)
- Icons exist at public/icons/ in required sizes
</success_criteria>

<output>
After completion, create `.planning/phases/07-polish-export-and-growth/07-03-SUMMARY.md`
</output>
