---
phase: 07-polish-export-and-growth
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/lib/calculations/evaluate-all.ts
  - src/lib/calculations/timeline.ts
  - src/lib/types/timeline.ts
  - src/components/comparison/OptionsList.tsx
  - src/lib/utils/format-currency.ts
  - src/components/timeline/TimelineChart.tsx
autonomous: true

must_haves:
  truths:
    - "Lease transfer appears as a sixth option card in the comparison view"
    - "Lease transfer appears as a line on the timeline chart"
    - "Transfer option shows 'Needs transfer details' when no transfer fee provided"
  artifacts:
    - path: "src/lib/calculations/evaluate-all.ts"
      provides: "evaluateAllScenarios includes lease transfer as 6th scenario"
      contains: "evaluateLeaseTransferScenario"
    - path: "src/lib/calculations/timeline.ts"
      provides: "Timeline projections include lease transfer"
      contains: "lease-transfer"
    - path: "src/lib/utils/format-currency.ts"
      provides: "formatOptionName handles 'lease-transfer'"
      contains: "lease-transfer"
  key_links:
    - from: "src/lib/calculations/evaluate-all.ts"
      to: "src/lib/calculations/scenarios/lease-transfer.ts"
      via: "import and call evaluateLeaseTransferScenario"
      pattern: "evaluateLeaseTransferScenario"
    - from: "src/lib/calculations/timeline.ts"
      to: "src/lib/calculations/scenarios/lease-transfer.ts"
      via: "import and call in projectScenarioCosts"
      pattern: "evaluateLeaseTransferScenario"
---

<objective>
Wire the lease transfer scenario into the comparison view and timeline chart so it appears as the sixth option alongside the existing five.

Purpose: PLSH-05 requires transfer to appear in the comparison and timeline. The calculation exists from Plan 01; this plan connects it to the UI pipeline.

Output: Updated evaluate-all, timeline, and format utilities so lease transfer flows through the existing component tree without modifying component structure (OptionCard, TimelineChart already handle ScenarioResult generically).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-polish-export-and-growth/07-01-SUMMARY.md
@src/lib/calculations/evaluate-all.ts
@src/lib/calculations/timeline.ts
@src/lib/types/timeline.ts
@src/lib/utils/format-currency.ts
@src/components/comparison/OptionsList.tsx
@src/components/timeline/TimelineChart.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate lease transfer into evaluate-all and format utilities</name>
  <files>
    src/lib/calculations/evaluate-all.ts
    src/lib/utils/format-currency.ts
  </files>
  <action>
    In evaluate-all.ts:
    1. Import evaluateLeaseTransferScenario from scenarios
    2. In evaluateAllScenarios(), add lease transfer evaluation after extension. Use these defaults since DB doesn't capture transfer-specific fields yet:
       - transferFee: new Decimal('400') (midpoint of $75-$895 range)
       - marketplaceFee: new Decimal('100') (typical marketplace listing)
       - registrationFee: new Decimal('150') (typical registration/title)
       - remainingPayments: already calculated
       - monthsRemaining: already calculated
       - monthlyPayment: lease.monthlyPayment
       - dispositionFee: dispositionFee (same variable already in scope)
       - incentivePayments: new Decimal('0')
    3. Mark the transfer result as incomplete (leaseTransferResult.incomplete = true) with warning "Add your transfer details for accurate lease transfer results" -- same pattern as sell-privately without market value
    4. Add leaseTransferResult to the scenarios array (before the sort)
    5. Update ComparisonData interface -- no changes needed, scenarios is already ScenarioResult[]

    In format-currency.ts:
    1. Add 'lease-transfer': 'Lease Transfer' to the formatOptionName mapping (find the existing switch/map and add the case)
  </action>
  <verify>
    - `npx tsc --noEmit` passes (type-checks with new scenario in the array)
    - `npm test` passes (existing evaluate-all tests still work with 6 scenarios)
  </verify>
  <done>
    evaluateAllScenarios returns 6 scenarios including lease-transfer (marked incomplete by default). formatOptionName('lease-transfer') returns 'Lease Transfer'.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate lease transfer into timeline projections</name>
  <files>
    src/lib/calculations/timeline.ts
    src/lib/types/timeline.ts
  </files>
  <action>
    In src/lib/types/timeline.ts:
    1. Add 'lease-transfer' to the MonthlyProjection costs record type (as nullable Decimal like sell-privately)
    2. Add leaseTransfer: number | null to TimelineDataPoint interface

    In src/lib/calculations/timeline.ts:
    1. Import evaluateLeaseTransferScenario from scenarios
    2. In projectScenarioCosts(), add lease transfer evaluation:
       - Use same default fees as evaluate-all ($400 transfer, $100 marketplace, $150 registration)
       - Transfer is always available (unlike extension which is lease-end only)
       - Add 'lease-transfer': leaseTransferResult.netCost to the costs return
    3. In buildTimelineData(), add leaseTransfer to the TimelineDataPoint conversion:
       - leaseTransfer: projection.costs['lease-transfer']?.toDP(2).toNumber() ?? null
    4. Add 'lease-transfer' to the scenarios array in buildTimelineData (always present, like return/buyout)

    Note: The TimelineChart component uses the scenarios array from TimelineSeries to determine which lines to render, and maps scenario types to chart data keys. Verify that the chart component can handle the new 'lease-transfer' key by checking if it uses a dynamic mapping or hardcoded keys. If hardcoded, add 'lease-transfer' -> 'leaseTransfer' mapping and assign chart color --chart-6.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm test` passes
    - Dev server starts without errors: `npm run dev` (check for no runtime errors on timeline page)
  </verify>
  <done>
    Timeline chart displays lease transfer as a sixth line. TimelineDataPoint includes leaseTransfer field. projectScenarioCosts returns lease-transfer cost for each month.
  </done>
</task>

</tasks>

<verification>
- Visit /lease/[id]/compare -- lease transfer appears as 6th option card (marked incomplete with "Needs transfer details")
- Visit /lease/[id]/timeline -- lease transfer line appears on chart
- All tests pass: `npm test`
- TypeScript compiles: `npx tsc --noEmit`
</verification>

<success_criteria>
- Lease transfer is the 6th option in comparison view with correct incomplete state
- Timeline chart shows lease transfer cost curve
- formatOptionName returns "Lease Transfer" for 'lease-transfer'
- No regressions in existing comparison or timeline functionality
</success_criteria>

<output>
After completion, create `.planning/phases/07-polish-export-and-growth/07-02-SUMMARY.md`
</output>
