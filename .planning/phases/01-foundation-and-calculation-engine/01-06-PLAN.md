---
phase: 01-foundation-and-calculation-engine
plan: 06
type: tdd
wave: 3
depends_on: ["01-03", "01-04"]
files_modified:
  - src/lib/calculations/scenarios/early-termination.ts
  - src/lib/calculations/scenarios/extension.ts
  - src/lib/calculations/scenarios/index.ts
  - src/__tests__/lib/calculations/scenarios/early-termination.test.ts
  - src/__tests__/lib/calculations/scenarios/extension.test.ts
autonomous: true

must_haves:
  truths:
    - "evaluateEarlyTerminationScenario produces an itemized breakdown using actuarial method with remaining depreciation, unpaid rent charges, and early termination fee"
    - "Early termination result includes a strong disclaimer that actual payoff varies by lender"
    - "evaluateExtensionScenario calculates month-to-month continuation cost for a specified number of months"
    - "Extension scenario warns that terms may differ from original lease"
    - "Both scenarios return ScenarioResult with lineItems, warnings, and disclaimers"
  artifacts:
    - path: "src/lib/calculations/scenarios/early-termination.ts"
      provides: "Early termination scenario evaluator using actuarial method"
      exports: ["evaluateEarlyTerminationScenario"]
    - path: "src/lib/calculations/scenarios/extension.ts"
      provides: "Month-to-month extension scenario evaluator"
      exports: ["evaluateExtensionScenario"]
    - path: "src/lib/calculations/scenarios/index.ts"
      provides: "Barrel export for all five scenario evaluators"
      exports: ["evaluateReturnScenario", "evaluateBuyoutScenario", "evaluateSellPrivatelyScenario", "evaluateEarlyTerminationScenario", "evaluateExtensionScenario"]
  key_links:
    - from: "src/lib/calculations/scenarios/early-termination.ts"
      to: "src/lib/calculations/depreciation.ts"
      via: "uses calculateDepreciation for remaining depreciation"
      pattern: "import.*depreciation"
    - from: "src/lib/calculations/scenarios/early-termination.ts"
      to: "src/lib/calculations/rent-charge.ts"
      via: "uses calculateRentCharge for unpaid rent charges"
      pattern: "import.*rent-charge"
    - from: "src/lib/calculations/scenarios/index.ts"
      to: "src/lib/calculations/scenarios/*.ts"
      via: "barrel re-export of all scenarios"
      pattern: "export.*from"
---

<objective>
Build and test the final two exit scenario evaluators using TDD: early termination and month-to-month extension. Create the scenarios barrel export to complete the calculation engine.

Purpose: Early termination is the most complex and lender-variable scenario -- it needs strong disclaimers. Extension is the simplest but still needs clear cost projection. With these two plus the three from Plan 05, all five exit scenarios are complete.
Output: Two tested scenario evaluation functions plus a complete barrel export for all five scenarios, completing the Phase 1 calculation engine.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-calculation-engine/01-RESEARCH.md
@.planning/phases/01-foundation-and-calculation-engine/01-01-SUMMARY.md
@.planning/phases/01-foundation-and-calculation-engine/01-03-SUMMARY.md
@.planning/phases/01-foundation-and-calculation-engine/01-04-SUMMARY.md
</context>

<feature>
  <name>Early Termination and Extension Scenario Evaluators</name>
  <files>
    src/lib/calculations/scenarios/early-termination.ts
    src/__tests__/lib/calculations/scenarios/early-termination.test.ts
    src/lib/calculations/scenarios/extension.ts
    src/__tests__/lib/calculations/scenarios/extension.test.ts
    src/lib/calculations/scenarios/index.ts
  </files>
  <behavior>
    All functions use Decimal from `@/lib/decimal`. Return types from `@/lib/types`.

    **evaluateEarlyTerminationScenario(params: { netCapCost: Decimal, residualValue: Decimal, moneyFactor: Decimal, termMonths: number, monthsElapsed: number, monthlyPayment: Decimal, earlyTerminationFee: Decimal, dispositionFee: Decimal }): EarlyTerminationResult**

    Uses the generic actuarial method (Federal Reserve reference):

    Logic:
    - monthsRemaining = termMonths - monthsElapsed
    - Calculate remaining depreciation: total depreciation over remaining months
      remainingDepreciation = calculateDepreciation(netCapCost, residualValue, termMonths) * monthsRemaining
    - Calculate unpaid rent charges: total finance charges over remaining months
      unpaidRentCharges = calculateRentCharge(netCapCost, residualValue, moneyFactor) * monthsRemaining
    - Early termination payoff = residualValue + remainingDepreciation + unpaidRentCharges + earlyTerminationFee + dispositionFee
    - This is a SIMPLIFIED actuarial method. Real lender payoffs may differ significantly.
    - Line items: Residual Value, Remaining Depreciation, Unpaid Rent Charges, Early Termination Fee, Disposition Fee
    - Warnings:
      - "This estimate uses a generic actuarial method. Your actual early termination payoff may differ significantly."
      - "Contact your leasing company directly for an exact payoff quote."
      - If monthsElapsed < 12: "Early termination in the first year typically incurs the highest penalties."
    - Disclaimers: Include earlyTermination disclaimer from disclaimers.ts.
    - type: 'early-termination'

    Cases:
    - Mid-lease termination (month 18 of 36):
      netCapCost=30000, residual=18000, MF=0.00125, term=36, elapsed=18, monthly=393.33, etFee=500, dispFee=395
      depreciation/mo = 333.33, rentCharge/mo = 60
      remainingDepr = 333.33 * 18 = 5999.94
      unpaidRent = 60 * 18 = 1080
      total = 18000 + 5999.94 + 1080 + 500 + 395 = 25974.94

    - Early termination (month 6 of 36):
      Same inputs but elapsed=6, remaining=30
      remainingDepr = 333.33 * 30 = 9999.90
      unpaidRent = 60 * 30 = 1800
      total = 18000 + 9999.90 + 1800 + 500 + 395 = 30694.90
      Should include first-year warning.

    - Near end (month 33 of 36):
      remaining=3
      remainingDepr = 333.33 * 3 = 999.99
      unpaidRent = 60 * 3 = 180
      total = 18000 + 999.99 + 180 + 500 + 395 = 20074.99

    - Zero early termination fee: etFee=0 -> still includes other costs

    **evaluateExtensionScenario(params: { monthlyPayment: Decimal, extensionMonths: number, monthlyTax: Decimal }): ExtensionResult**

    Logic:
    - monthlyExtensionPayment = monthlyPayment (most lessors keep the same payment for month-to-month)
    - totalMonthlyWithTax = monthlyPayment + monthlyTax
    - totalExtensionCost = totalMonthlyWithTax * extensionMonths
    - Line items: Monthly Payment (per month), Monthly Tax, Total per Month, Total Extension Cost
    - Warnings:
      - "Month-to-month extension terms may differ from your original lease agreement."
      - "Your leasing company may change rates or terms during the extension period."
      - If extensionMonths > 6: "Extended lease periods may result in the vehicle falling outside warranty coverage."
    - Disclaimers: Include general disclaimer.
    - type: 'extension'
    - netCost = totalExtensionCost (extending always costs this amount)

    Cases:
    - Short extension (3 months): monthly=393.33, months=3, tax=28.52 -> total=(393.33+28.52)*3 = 1265.55
    - Long extension (12 months): monthly=393.33, months=12, tax=28.52 -> total=5062.20, includes warranty warning
    - No tax: monthly=393.33, months=6, tax=0 -> total=2359.98
    - Single month: monthly=393.33, months=1, tax=28.52 -> total=421.85

    After both scenarios pass, create `src/lib/calculations/scenarios/index.ts`:
    ```typescript
    export { evaluateReturnScenario } from './return';
    export { evaluateBuyoutScenario } from './buyout';
    export { evaluateSellPrivatelyScenario } from './sell-privately';
    export { evaluateEarlyTerminationScenario } from './early-termination';
    export { evaluateExtensionScenario } from './extension';
    ```

    Also update `src/lib/calculations/index.ts` to re-export from scenarios:
    ```typescript
    export * from './scenarios';
    ```
  </behavior>
  <implementation>
    Follow RED-GREEN-REFACTOR for each scenario.

    Order:
    1. early-termination.ts -- most complex, uses depreciation + rent-charge from Plan 03
    2. extension.ts -- simplest scenario, minimal dependencies
    3. scenarios/index.ts -- barrel export after both pass

    Important implementation notes:
    - Early termination MUST import calculateDepreciation and calculateRentCharge from Plan 03's modules (not re-implement)
    - Early termination MUST include the earlyTermination disclaimer from src/lib/disclaimers.ts
    - Extension is intentionally simple -- month-to-month uses the same payment amount

    After all tests pass: `npm run test` should run ALL calculation tests (from Plans 03, 04, 05, and 06) and ALL should pass. Run `npm run test:coverage` to verify 100% coverage across all calculation modules.
  </implementation>
</feature>

<verification>
1. `npm run test` passes with ALL calculation tests green (Plans 03-06, all scenarios)
2. `npm run test:coverage` shows 100% coverage on ALL src/lib/calculations/ files
3. Early termination includes strong lender-specific disclaimer
4. Early termination uses actuarial method composing depreciation + rent charge functions
5. Extension correctly calculates multi-month costs with tax
6. Both scenarios return lineItems, warnings, and disclaimers
7. `src/lib/calculations/scenarios/index.ts` exports all five scenario evaluators
8. `src/lib/calculations/index.ts` re-exports everything (core calcs + scenarios)
</verification>

<success_criteria>
All five exit scenario evaluators are complete: return, buyout, sell-privately, early termination, and extension. Each produces itemized cost breakdowns with line items, warnings, and legal disclaimers. The full calculation engine runs with 100% test coverage. The Phase 1 goal -- "Every financial calculation the product needs exists as a tested, pure TypeScript function" -- is achieved.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-calculation-engine/01-06-SUMMARY.md`
</output>
