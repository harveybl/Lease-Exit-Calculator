---
phase: 01-foundation-and-calculation-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - vitest.config.ts
  - src/lib/decimal.ts
  - src/lib/types/lease.ts
  - src/lib/types/calculation.ts
  - src/lib/types/scenario.ts
  - src/lib/types/index.ts
autonomous: true

must_haves:
  truths:
    - "npm run dev starts a Next.js 16 application without errors"
    - "npm run test executes Vitest and exits with zero failures"
    - "TypeScript types exist for Lease, Calculation, Scenario, and Decimal-based financial primitives"
    - "Decimal.js is configured globally with precision: 20 and ROUND_HALF_UP"
  artifacts:
    - path: "package.json"
      provides: "Project manifest with all Phase 1 dependencies"
      contains: "decimal.js"
    - path: "vitest.config.ts"
      provides: "Test runner configuration with path aliases and coverage thresholds"
      contains: "thresholds"
    - path: "src/lib/decimal.ts"
      provides: "Global Decimal.js configuration"
      contains: "ROUND_HALF_UP"
    - path: "src/lib/types/lease.ts"
      provides: "Lease type definition with all financial fields"
      contains: "interface Lease"
    - path: "src/lib/types/calculation.ts"
      provides: "Calculation result types and financial primitives"
      contains: "interface"
    - path: "src/lib/types/scenario.ts"
      provides: "Scenario evaluation result types for all five exit options"
      contains: "ScenarioResult"
  key_links:
    - from: "src/lib/decimal.ts"
      to: "decimal.js"
      via: "import and configure"
      pattern: "Decimal\\.set"
    - from: "src/lib/types/index.ts"
      to: "src/lib/types/*.ts"
      via: "barrel export"
      pattern: "export.*from"
---

<objective>
Scaffold the Next.js 16 project with TypeScript, install all Phase 1 dependencies (Decimal.js, Drizzle ORM, Neon driver, Vitest), configure the test runner, set up Decimal.js precision, and create shared type definitions for Lease, Calculation, and Scenario.

Purpose: Every subsequent plan depends on the project skeleton, test infrastructure, Decimal.js configuration, and shared types. This is the foundation that enables parallel execution of Plans 02-04 in Wave 2.
Output: A runnable Next.js 16 project with Vitest configured, Decimal.js precision set, and all shared TypeScript types exported.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-calculation-engine/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold Next.js 16 project and install dependencies</name>
  <files>
    package.json
    tsconfig.json
    vitest.config.ts
    .env.example
    .env.local (gitignored)
  </files>
  <action>
    1. Initialize a new Next.js 16 project in the current directory (the repo already exists, so scaffold into it):
       ```
       npx create-next-app@latest . --typescript --tailwind --eslint --app --src-dir --import-alias="@/*" --turbopack --yes
       ```
       If the directory is not empty, allow overwriting or adjust as needed.

    2. Install core dependencies:
       ```
       npm install drizzle-orm @neondatabase/serverless decimal.js
       ```

    3. Install dev dependencies:
       ```
       npm install -D drizzle-kit dotenv vitest @vitest/ui @vitest/coverage-v8
       ```

    4. Create `vitest.config.ts` at project root with this exact configuration:
       ```typescript
       import { defineConfig } from 'vitest/config';
       import path from 'path';

       export default defineConfig({
         test: {
           globals: true,
           environment: 'node',
           include: ['src/**/*.test.ts'],
           coverage: {
             provider: 'v8',
             reporter: ['text', 'html', 'lcov'],
             include: ['src/lib/calculations/**/*.ts'],
             exclude: ['**/*.test.ts', '**/*.spec.ts', '**/index.ts'],
             thresholds: {
               lines: 100,
               functions: 100,
               branches: 100,
               statements: 100,
             },
           },
         },
         resolve: {
           alias: {
             '@': path.resolve(__dirname, './src'),
           },
         },
       });
       ```

    5. Add test scripts to `package.json`:
       ```json
       "test": "vitest run",
       "test:watch": "vitest",
       "test:coverage": "vitest run --coverage",
       "test:ui": "vitest --ui"
       ```

    6. Create `.env.example` with:
       ```
       DATABASE_URL=postgresql://user:password@host/database?sslmode=require
       ```

    7. Create `.env.local` with placeholder DATABASE_URL (this file is already gitignored by Next.js).

    DO NOT install any UI component libraries yet. Phase 1 is calculations-focused.
  </action>
  <verify>
    - `npm run dev` starts without errors (ctrl+c after confirming)
    - `npm run test` executes Vitest (will show "no test files" which is expected)
    - `npx tsc --noEmit` passes with no TypeScript errors
    - `package.json` contains decimal.js, drizzle-orm, @neondatabase/serverless, vitest
  </verify>
  <done>
    Next.js 16 app runs locally, Vitest executes, all Phase 1 dependencies installed, path aliases configured.
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure Decimal.js and create shared type definitions</name>
  <files>
    src/lib/decimal.ts
    src/lib/types/lease.ts
    src/lib/types/calculation.ts
    src/lib/types/scenario.ts
    src/lib/types/index.ts
  </files>
  <action>
    1. Create `src/lib/decimal.ts` -- the single place where Decimal.js is configured:
       ```typescript
       import Decimal from 'decimal.js';

       // Configure Decimal.js for financial precision
       // This MUST be imported before any calculation module
       Decimal.set({
         precision: 20,
         rounding: Decimal.ROUND_HALF_UP,
         toExpNeg: -7,
         toExpPos: 21,
       });

       export { Decimal };
       export type { Decimal as DecimalType };
       ```
       All calculation modules MUST import Decimal from this file (not from 'decimal.js' directly) to guarantee consistent configuration.

    2. Create `src/lib/types/lease.ts` with the Lease interface:
       - `id`: string (UUID)
       - `make`: string
       - `model`: string
       - `year`: number
       - `msrp`: Decimal
       - `netCapCost`: Decimal (negotiated price + fees - down payment)
       - `residualValue`: Decimal (guaranteed end value)
       - `residualPercent`: Decimal (residual as % of MSRP)
       - `moneyFactor`: Decimal (e.g., 0.00125)
       - `termMonths`: number (lease duration)
       - `monthsElapsed`: number (how far into the lease)
       - `monthlyPayment`: Decimal (actual monthly amount before tax)
       - `downPayment`: Decimal (cap cost reduction)
       - `dispositionFee`: Decimal (fee charged on return)
       - `purchaseFee`: Decimal (fee to buy at lease end)
       - `allowedMilesPerYear`: number
       - `overageFeePerMile`: Decimal
       - `currentMileage`: number
       - `mileageDate`: Date (when mileage was recorded)
       - `stateCode`: string (two-letter state code for tax purposes)
       - `startDate`: Date
       - `endDate`: Date
       - `createdAt`: Date
       - `updatedAt`: Date
       Import Decimal from `@/lib/decimal`.

    3. Create `src/lib/types/calculation.ts` with:
       - `MonthlyBreakdown` interface: { depreciation: Decimal, rentCharge: Decimal, monthlyPayment: Decimal, monthlyTax: Decimal, totalMonthly: Decimal }
       - `TotalCostBreakdown` interface: { totalDepreciation: Decimal, totalRentCharges: Decimal, totalPayments: Decimal, totalTax: Decimal, grandTotal: Decimal }
       - `MileageProjection` interface: { currentMileage: number, monthsElapsed: number, termMonths: number, averageMilesPerMonth: number, projectedEndMileage: number, allowedMiles: number, projectedOverage: number, projectedOverageCost: Decimal }
       - `EquityCalculation` interface: { marketValue: Decimal, buyoutCost: Decimal, equity: Decimal, hasPositiveEquity: boolean, lineItems: LineItem[] }
       - `TaxResult` interface: { upfrontTax: Decimal, monthlyTax: Decimal, totalTax: Decimal, timing: 'upfront' | 'monthly' | 'none', stateCode: string }
       - `LineItem` interface: { label: string, amount: Decimal, description: string, type?: 'asset' | 'liability' | 'fee' | 'tax' }

    4. Create `src/lib/types/scenario.ts` with:
       - `ScenarioType` union: 'return' | 'buyout' | 'sell-privately' | 'early-termination' | 'extension'
       - `ScenarioResult` interface: { type: ScenarioType, totalCost: Decimal, netCost: Decimal, lineItems: LineItem[], warnings: string[], disclaimers: string[] }
       - `ReturnScenarioResult` extends ScenarioResult with: { dispositionFee: Decimal, excessMileageCost: Decimal, wearAndTearEstimate: Decimal }
       - `BuyoutScenarioResult` extends ScenarioResult with: { residualValue: Decimal, remainingPayments: Decimal, purchaseFee: Decimal, salesTax: Decimal }
       - `SellPrivatelyResult` extends ScenarioResult with: { estimatedSalePrice: Decimal, payoffAmount: Decimal, netProceeds: Decimal }
       - `EarlyTerminationResult` extends ScenarioResult with: { earlyTerminationFee: Decimal, remainingDepreciation: Decimal, unpaidRentCharges: Decimal }
       - `ExtensionResult` extends ScenarioResult with: { monthlyExtensionPayment: Decimal, extensionMonths: number, totalExtensionCost: Decimal }

    5. Create `src/lib/types/index.ts` that barrel-exports everything:
       ```typescript
       export * from './lease';
       export * from './calculation';
       export * from './scenario';
       ```

    All types that represent money MUST use Decimal (imported from `@/lib/decimal`), never `number`.
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no errors
    - All type files exist and export their interfaces
    - Decimal is imported from `@/lib/decimal` (not directly from 'decimal.js') in type files
    - `src/lib/types/index.ts` re-exports all types
  </verify>
  <done>
    Shared types for Lease (all financial fields), Calculation (breakdowns, projections, equity, tax), and Scenario (all five exit options with specific result shapes) are defined and exported. Decimal.js is configured with precision: 20 and ROUND_HALF_UP. Every monetary field uses Decimal type.
  </done>
</task>

</tasks>

<verification>
1. `npm run dev` starts Next.js 16 without errors
2. `npm run test` runs Vitest (no failures -- no test files yet is OK)
3. `npx tsc --noEmit` compiles with zero errors
4. Decimal.js is configured exactly once in `src/lib/decimal.ts` with precision: 20
5. Types exist: Lease, MonthlyBreakdown, TotalCostBreakdown, MileageProjection, EquityCalculation, TaxResult, LineItem, ScenarioResult, and all five scenario-specific result types
</verification>

<success_criteria>
A Next.js 16 application runs locally with TypeScript, Vitest is configured with 100% coverage thresholds on calculations, Decimal.js is globally configured for financial precision, and all shared type definitions are exported from src/lib/types/index.ts. Plans 02, 03, and 04 can begin without modification.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-calculation-engine/01-01-SUMMARY.md`
</output>
