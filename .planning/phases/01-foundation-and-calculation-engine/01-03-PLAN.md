---
phase: 01-foundation-and-calculation-engine
plan: 03
type: tdd
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/lib/calculations/depreciation.ts
  - src/lib/calculations/rent-charge.ts
  - src/lib/calculations/monthly-payment.ts
  - src/lib/calculations/total-cost.ts
  - src/lib/calculations/utils.ts
  - src/lib/calculations/index.ts
  - src/__tests__/lib/calculations/depreciation.test.ts
  - src/__tests__/lib/calculations/rent-charge.test.ts
  - src/__tests__/lib/calculations/monthly-payment.test.ts
  - src/__tests__/lib/calculations/total-cost.test.ts
  - src/__tests__/lib/calculations/utils.test.ts
autonomous: true

must_haves:
  truths:
    - "calculateDepreciation returns (netCapCost - residual) / term for any valid inputs"
    - "calculateRentCharge returns (netCapCost + residual) * moneyFactor"
    - "calculateMonthlyPayment returns depreciation + rentCharge"
    - "calculateTotalCost returns monthly * term + downPayment for the full lease cost"
    - "moneyFactorToAPR converts correctly (MF * 2400 = APR) and vice versa"
    - "All functions accept and return Decimal instances, never native numbers for money"
    - "Tests verify against real-world lease scenarios with known correct answers"
  artifacts:
    - path: "src/lib/calculations/depreciation.ts"
      provides: "Monthly depreciation fee calculation"
      exports: ["calculateDepreciation"]
    - path: "src/lib/calculations/rent-charge.ts"
      provides: "Monthly rent charge (finance fee) calculation"
      exports: ["calculateRentCharge"]
    - path: "src/lib/calculations/monthly-payment.ts"
      provides: "Total monthly payment before tax"
      exports: ["calculateMonthlyPayment"]
    - path: "src/lib/calculations/total-cost.ts"
      provides: "Total lease cost over full term"
      exports: ["calculateTotalCost"]
    - path: "src/lib/calculations/utils.ts"
      provides: "Money factor â†” APR conversion utilities"
      exports: ["moneyFactorToAPR", "aprToMoneyFactor"]
  key_links:
    - from: "src/lib/calculations/monthly-payment.ts"
      to: "src/lib/calculations/depreciation.ts"
      via: "imports calculateDepreciation"
      pattern: "import.*depreciation"
    - from: "src/lib/calculations/monthly-payment.ts"
      to: "src/lib/calculations/rent-charge.ts"
      via: "imports calculateRentCharge"
      pattern: "import.*rent-charge"
    - from: "src/lib/calculations/total-cost.ts"
      to: "src/lib/calculations/monthly-payment.ts"
      via: "imports calculateMonthlyPayment"
      pattern: "import.*monthly-payment"
---

<objective>
Build and test the core lease calculation functions using TDD: depreciation, rent charge, monthly payment, total cost, and money factor/APR conversion.

Purpose: These are the foundational formulas that every scenario evaluator depends on. Getting these right with verified test cases ensures the entire calculation engine is built on a solid base.
Output: Five tested, pure calculation functions exported from src/lib/calculations/ with 100% test coverage.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-calculation-engine/01-RESEARCH.md
@.planning/phases/01-foundation-and-calculation-engine/01-01-SUMMARY.md
</context>

<feature>
  <name>Core Lease Calculation Functions</name>
  <files>
    src/lib/calculations/depreciation.ts
    src/__tests__/lib/calculations/depreciation.test.ts
    src/lib/calculations/rent-charge.ts
    src/__tests__/lib/calculations/rent-charge.test.ts
    src/lib/calculations/monthly-payment.ts
    src/__tests__/lib/calculations/monthly-payment.test.ts
    src/lib/calculations/total-cost.ts
    src/__tests__/lib/calculations/total-cost.test.ts
    src/lib/calculations/utils.ts
    src/__tests__/lib/calculations/utils.test.ts
    src/lib/calculations/index.ts
  </files>
  <behavior>
    All functions use Decimal from `@/lib/decimal`. All money inputs/outputs are Decimal instances.

    **calculateDepreciation(netCapCost: Decimal, residualValue: Decimal, termMonths: number): Decimal**
    Formula: (netCapCost - residualValue) / termMonths
    Cases:
    - Standard 36mo: (30000 - 18000) / 36 = 333.33 (recurring)
    - Luxury 36mo: (80000 - 56000) / 36 = 666.67 (rounded)
    - Zero depreciation: (25000 - 25000) / 36 = 0
    - Short term 24mo: (30000 - 21000) / 24 = 375

    **calculateRentCharge(netCapCost: Decimal, residualValue: Decimal, moneyFactor: Decimal): Decimal**
    Formula: (netCapCost + residualValue) * moneyFactor
    Cases:
    - Standard: (30000 + 18000) * 0.00125 = 60
    - Luxury: (80000 + 56000) * 0.0008 = 108.80
    - High MF: (30000 + 18000) * 0.003 = 144
    - Zero MF: (30000 + 18000) * 0 = 0

    **calculateMonthlyPayment(netCapCost: Decimal, residualValue: Decimal, moneyFactor: Decimal, termMonths: number): Decimal**
    Formula: depreciation + rentCharge
    Cases:
    - Standard 36mo: 333.33 + 60 = 393.33
    - Luxury 36mo: 666.67 + 108.80 = 775.47
    - Real scenario with decimals: netCapCost=25000.55, residual=12500.27, MF=0.00095, term=36
      depreciation = 347.23, rentCharge = 35.63, monthly = 382.86 (verify exact with Decimal.js)

    **calculateTotalCost(monthlyPayment: Decimal, termMonths: number, downPayment: Decimal, totalTax: Decimal): Decimal**
    Formula: (monthlyPayment * termMonths) + downPayment + totalTax
    Cases:
    - Standard: (393.33 * 36) + 2000 + 0 = 16159.88
    - With tax: (393.33 * 36) + 2000 + 1500 = 17659.88
    - Zero down: (393.33 * 36) + 0 + 0 = 14159.88

    **moneyFactorToAPR(moneyFactor: Decimal): Decimal**
    Formula: moneyFactor * 2400
    Cases:
    - 0.00125 -> 3.0
    - 0.0008 -> 1.92
    - 0.003 -> 7.2
    - 0.00001 -> 0.024

    **aprToMoneyFactor(apr: Decimal): Decimal**
    Formula: apr / 2400
    Cases:
    - 3.0 -> 0.00125
    - 1.92 -> 0.0008
    - 7.2 -> 0.003
    - 0.024 -> 0.00001

    Edge cases for ALL functions:
    - Very large values (Decimal('999999.99'))
    - Very small money factors (Decimal('0.00001'))
    - Precision preservation (no floating-point drift)
    - All return Decimal instances (not numbers)

    After all functions pass, create `src/lib/calculations/index.ts` barrel export.
  </behavior>
  <implementation>
    Follow RED-GREEN-REFACTOR cycle:

    **RED:** Write test file first. Import from the source module (which doesn't exist yet). Define all test cases from the behavior section above. Run `npm run test` -- tests must FAIL (module not found).

    **GREEN:** Create the source module. Implement the function using Decimal from `@/lib/decimal`. Run `npm run test` -- tests must PASS.

    **REFACTOR:** Review implementation. If any improvements are obvious (DRY, naming), apply them. Run `npm run test` -- tests must still PASS.

    Order of implementation:
    1. utils.ts (moneyFactorToAPR, aprToMoneyFactor) -- simplest, no dependencies
    2. depreciation.ts -- standalone formula
    3. rent-charge.ts -- standalone formula
    4. monthly-payment.ts -- depends on depreciation + rent-charge
    5. total-cost.ts -- depends on monthly-payment
    6. index.ts -- barrel export after all pass

    After all tests pass: `npm run test:coverage` must show 100% coverage on src/lib/calculations/.
  </implementation>
</feature>

<verification>
1. `npm run test` passes with all core calculation tests green
2. `npm run test:coverage` shows 100% line/branch/function/statement coverage on calculation files
3. Test cases include real-world lease scenarios (not just round numbers)
4. All functions import Decimal from `@/lib/decimal` (not from 'decimal.js')
5. All monetary returns are Decimal instances verified with `toBeInstanceOf(Decimal)`
6. Edge cases tested: zero values, very small money factors, large amounts
</verification>

<success_criteria>
Five pure calculation functions (depreciation, rent charge, monthly payment, total cost, MF/APR conversion) are implemented, fully tested with real-world scenarios, and achieve 100% test coverage. They form the foundation for all scenario evaluators in Plans 05 and 06.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-calculation-engine/01-03-SUMMARY.md`
</output>
