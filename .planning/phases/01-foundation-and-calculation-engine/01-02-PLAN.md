---
phase: 01-foundation-and-calculation-engine
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/lib/db/schema.ts
  - src/lib/db/client.ts
  - src/lib/db/custom-types.ts
  - drizzle.config.ts
  - src/app/page.tsx
  - src/components/disclaimers/LegalDisclaimer.tsx
  - src/lib/disclaimers.ts
autonomous: true
user_setup:
  - service: neon
    why: "Serverless Postgres database for lease storage"
    env_vars:
      - name: DATABASE_URL
        source: "Neon Dashboard -> Project -> Connection Details -> Connection string (with pooling)"

must_haves:
  truths:
    - "Drizzle schema defines a leases table with all financial fields using numeric columns"
    - "drizzle-kit generate produces a valid SQL migration file"
    - "Legal disclaimer text renders on the application home page before any calculation output area"
    - "Custom Decimal.js â†” PostgreSQL numeric type converts correctly in both directions"
  artifacts:
    - path: "src/lib/db/schema.ts"
      provides: "Drizzle ORM schema for leases table"
      contains: "pgTable"
    - path: "src/lib/db/client.ts"
      provides: "Database client connecting to Neon Postgres"
      contains: "neon"
    - path: "src/lib/db/custom-types.ts"
      provides: "Custom Drizzle type mapping Decimal.js to PostgreSQL numeric"
      contains: "customType"
    - path: "drizzle.config.ts"
      provides: "Drizzle Kit configuration for migrations"
      contains: "defineConfig"
    - path: "src/components/disclaimers/LegalDisclaimer.tsx"
      provides: "Legal disclaimer banner component"
      contains: "disclaimer"
    - path: "src/lib/disclaimers.ts"
      provides: "Disclaimer text constants"
      contains: "DISCLAIMER"
  key_links:
    - from: "src/lib/db/schema.ts"
      to: "src/lib/db/custom-types.ts"
      via: "import decimal custom type"
      pattern: "import.*custom-types"
    - from: "src/lib/db/client.ts"
      to: "@neondatabase/serverless"
      via: "neon driver connection"
      pattern: "neon\\("
    - from: "src/app/page.tsx"
      to: "src/components/disclaimers/LegalDisclaimer.tsx"
      via: "renders disclaimer component"
      pattern: "<LegalDisclaimer"
---

<objective>
Create the Drizzle ORM database schema for lease storage with a custom Decimal.js type, configure the Neon Postgres client, generate the initial migration, and add legal disclaimer copy to the application's home page.

Purpose: The database schema enables lease persistence (required by Phase 2), and disclaimers must appear before any calculation output per FOUND-04. Both are independent of the calculation engine and can be built in parallel with TDD calculation plans.
Output: A leases table schema with Decimal-backed monetary columns, a working DB client, a generated migration, and disclaimer text rendered on the home page.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-calculation-engine/01-RESEARCH.md
@.planning/phases/01-foundation-and-calculation-engine/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Drizzle ORM schema, custom Decimal type, and database client</name>
  <files>
    src/lib/db/custom-types.ts
    src/lib/db/schema.ts
    src/lib/db/client.ts
    drizzle.config.ts
  </files>
  <action>
    1. Create `src/lib/db/custom-types.ts` with a custom Drizzle type that maps Decimal.js to PostgreSQL numeric:
       ```typescript
       import { customType } from 'drizzle-orm/pg-core';
       import { Decimal } from '@/lib/decimal';

       export const decimalNumber = customType<{
         data: Decimal;
         driverData: string;
         config: { precision?: number; scale?: number };
       }>({
         dataType(config) {
           const precision = config?.precision ?? 10;
           const scale = config?.scale ?? 2;
           return `numeric(${precision}, ${scale})`;
         },
         toDriver(value: Decimal): string {
           return value.toFixed();
         },
         fromDriver(value: string): Decimal {
           return new Decimal(value);
         },
       });
       ```

    2. Create `src/lib/db/schema.ts` defining the leases table. Map every monetary field from the Lease type to a decimalNumber column. Use appropriate precision/scale:
       - Standard money fields (msrp, netCapCost, residualValue, monthlyPayment, downPayment, dispositionFee, purchaseFee): `precision: 10, scale: 2`
       - Money factor: `precision: 10, scale: 6` (money factors are tiny, e.g., 0.00125)
       - Residual percent: `precision: 5, scale: 2`
       - Overage fee per mile: `precision: 6, scale: 4` (e.g., $0.25 per mile)
       Include all non-monetary fields: id (uuid, primary key, defaultRandom), make, model, year, termMonths, monthsElapsed, allowedMilesPerYear, currentMileage, mileageDate, stateCode, startDate, endDate, createdAt (defaultNow), updatedAt (defaultNow).
       Use `pgTable('leases', { ... })`.

    3. Create `src/lib/db/client.ts`:
       ```typescript
       import { neon } from '@neondatabase/serverless';
       import { drizzle } from 'drizzle-orm/neon-http';
       import * as schema from './schema';

       const sql = neon(process.env.DATABASE_URL!);
       export const db = drizzle(sql, { schema });
       ```

    4. Create `drizzle.config.ts` at project root:
       ```typescript
       import { defineConfig } from 'drizzle-kit';

       export default defineConfig({
         schema: './src/lib/db/schema.ts',
         out: './drizzle/migrations',
         dialect: 'postgresql',
         dbCredentials: {
           url: process.env.DATABASE_URL!,
         },
       });
       ```

    5. Generate the initial migration:
       ```bash
       npx drizzle-kit generate
       ```
       Verify a SQL file is created in `drizzle/migrations/` containing CREATE TABLE leases with numeric columns.

    DO NOT run `drizzle-kit migrate` or `drizzle-kit push` -- the user needs to set up the Neon database first. Just generate the migration SQL.
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no errors
    - `npx drizzle-kit generate` produces a migration file in `drizzle/migrations/`
    - Migration SQL contains `numeric(10, 2)` for money columns and `numeric(10, 6)` for money factor
    - `src/lib/db/schema.ts` imports the custom decimal type from custom-types.ts
  </verify>
  <done>
    Drizzle schema defines leases table with all fields from the Lease type, custom Decimal.js type handles PostgreSQL numeric conversion, DB client connects to Neon, and migration SQL is generated (not applied -- user must configure DATABASE_URL first).
  </done>
</task>

<task type="auto">
  <name>Task 2: Draft legal disclaimers and integrate into UI shell</name>
  <files>
    src/lib/disclaimers.ts
    src/components/disclaimers/LegalDisclaimer.tsx
    src/app/page.tsx
  </files>
  <action>
    1. Create `src/lib/disclaimers.ts` with disclaimer text constants:
       ```typescript
       export const DISCLAIMERS = {
         general: `This tool provides estimates for informational purposes only. It is not financial, legal, or tax advice. Actual costs may vary based on your specific lease agreement, lender policies, and local regulations. Always consult your lease contract and contact your leasing company for exact figures.`,
         earlyTermination: `Early termination calculations use a generic actuarial method. Actual payoff amounts vary significantly by lender (Toyota Financial, GM Financial, Honda Financial, etc.) and may differ from estimates shown here. Contact your leasing company directly for your exact early termination payoff amount.`,
         tax: `Tax calculations are estimates based on state-level rules. Local municipality taxes, special district taxes, and recent rate changes may not be reflected. Consult a tax professional or your local DMV for exact tax obligations.`,
         marketValue: `Market value estimates are user-provided or derived from third-party sources. Actual sale prices depend on vehicle condition, local market demand, and negotiation. These figures should not be relied upon for financial decisions without independent verification.`,
         mileage: `Mileage projections assume a constant driving rate based on current usage. Seasonal variations, lifestyle changes, and other factors may cause actual end-of-lease mileage to differ significantly from projections.`,
       } as const;

       export type DisclaimerKey = keyof typeof DISCLAIMERS;
       ```

    2. Create `src/components/disclaimers/LegalDisclaimer.tsx` as a React Server Component:
       ```tsx
       import { DISCLAIMERS, type DisclaimerKey } from '@/lib/disclaimers';

       interface LegalDisclaimerProps {
         types?: DisclaimerKey[];
         className?: string;
       }

       export function LegalDisclaimer({
         types = ['general'],
         className = '',
       }: LegalDisclaimerProps) {
         return (
           <div
             role="alert"
             aria-label="Legal disclaimer"
             className={`rounded-lg border border-amber-200 bg-amber-50 p-4 text-sm text-amber-800 ${className}`}
           >
             <p className="mb-1 font-semibold">Important Notice</p>
             {types.map((type) => (
               <p key={type} className="mt-2">
                 {DISCLAIMERS[type]}
               </p>
             ))}
           </div>
         );
       }
       ```

    3. Update `src/app/page.tsx` to render the LegalDisclaimer component prominently at the top of the page, ABOVE any future calculation output area. Replace the default Next.js boilerplate with a minimal layout:
       ```tsx
       import { LegalDisclaimer } from '@/components/disclaimers/LegalDisclaimer';

       export default function Home() {
         return (
           <main className="mx-auto max-w-4xl px-4 py-8">
             <h1 className="mb-6 text-3xl font-bold">Lease Tracker</h1>
             <LegalDisclaimer types={['general']} />
             <section className="mt-8">
               <p className="text-gray-600">
                 Calculation results will appear here.
               </p>
             </section>
           </main>
         );
       }
       ```

    The disclaimer MUST appear before any calculation output area on the page. This satisfies FOUND-04.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run dev` shows the disclaimer banner on the home page
    - Disclaimer text includes the general notice about estimates and informational purposes
    - The disclaimer component has `role="alert"` and `aria-label` for accessibility
    - Disclaimer appears ABOVE the "Calculation results will appear here" placeholder
  </verify>
  <done>
    Legal disclaimer copy is drafted for all five contexts (general, early termination, tax, market value, mileage). The LegalDisclaimer component renders on the home page above any calculation output area. Disclaimer is accessible (role="alert", aria-label).
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors (schema + disclaimer + types all compile)
2. `npx drizzle-kit generate` has produced a migration file with the leases table
3. Migration SQL contains numeric columns for all monetary fields
4. `npm run dev` shows the home page with a visible disclaimer banner
5. Disclaimer text appears BEFORE any calculation output area
6. `src/lib/db/client.ts` connects to Neon Postgres via the serverless driver
</verification>

<success_criteria>
The leases database schema is defined with Decimal.js-backed numeric columns, a migration file is generated, the Neon client is configured, and legal disclaimer text renders on the home page before any calculation output. The database is ready to receive migrations once the user configures DATABASE_URL.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-calculation-engine/01-02-SUMMARY.md`
</output>
