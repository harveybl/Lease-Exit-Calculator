---
phase: 01-foundation-and-calculation-engine
plan: 04
type: tdd
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/lib/calculations/mileage.ts
  - src/lib/calculations/equity.ts
  - src/lib/calculations/tax.ts
  - src/lib/calculations/tax-rules.ts
  - src/__tests__/lib/calculations/mileage.test.ts
  - src/__tests__/lib/calculations/equity.test.ts
  - src/__tests__/lib/calculations/tax.test.ts
autonomous: true

must_haves:
  truths:
    - "projectMileage returns correct end-of-lease mileage projection based on current usage rate"
    - "projectMileage calculates overage cost only when projected mileage exceeds allowance"
    - "calculateEquity returns positive equity when market value exceeds buyout cost, negative otherwise"
    - "calculateEquity produces a line-item breakdown with asset and liability entries"
    - "calculateLeaseTax correctly distinguishes upfront-tax states (TX, NY) from monthly-tax states (CA) from no-tax states (OR)"
    - "Tax rules cover top 15 US states by population"
    - "Unsupported state codes throw a descriptive error"
  artifacts:
    - path: "src/lib/calculations/mileage.ts"
      provides: "Mileage projection and overage cost calculation"
      exports: ["projectMileage"]
    - path: "src/lib/calculations/equity.ts"
      provides: "Lease equity calculation with line-item breakdown"
      exports: ["calculateEquity"]
    - path: "src/lib/calculations/tax.ts"
      provides: "State-aware lease tax calculation"
      exports: ["calculateLeaseTax"]
    - path: "src/lib/calculations/tax-rules.ts"
      provides: "State tax rule lookup table for top 15 states"
      exports: ["STATE_TAX_RULES", "StateTaxRule", "TaxTiming"]
  key_links:
    - from: "src/lib/calculations/tax.ts"
      to: "src/lib/calculations/tax-rules.ts"
      via: "imports STATE_TAX_RULES"
      pattern: "import.*tax-rules"
    - from: "src/lib/calculations/equity.ts"
      to: "src/lib/types/calculation.ts"
      via: "returns EquityCalculation type"
      pattern: "EquityCalculation"
    - from: "src/lib/calculations/mileage.ts"
      to: "src/lib/types/calculation.ts"
      via: "returns MileageProjection type"
      pattern: "MileageProjection"
---

<objective>
Build and test mileage projection, equity calculation, and state-aware tax calculation using TDD.

Purpose: Mileage projection drives the return scenario (excess mileage charges). Equity drives the sell-privately and buyout scenarios. Tax calculation affects every scenario's total cost. These three independent calculations enable all five scenario evaluators in Wave 3.
Output: Three tested calculation modules with a state tax rule lookup table covering top 15 US states.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-calculation-engine/01-RESEARCH.md
@.planning/phases/01-foundation-and-calculation-engine/01-01-SUMMARY.md
</context>

<feature>
  <name>Mileage, Equity, and Tax Calculations</name>
  <files>
    src/lib/calculations/mileage.ts
    src/__tests__/lib/calculations/mileage.test.ts
    src/lib/calculations/equity.ts
    src/__tests__/lib/calculations/equity.test.ts
    src/lib/calculations/tax.ts
    src/lib/calculations/tax-rules.ts
    src/__tests__/lib/calculations/tax.test.ts
  </files>
  <behavior>
    All functions use Decimal from `@/lib/decimal`. Return types match interfaces from `@/lib/types`.

    **projectMileage(params: { currentMileage: number, monthsElapsed: number, termMonths: number, allowedMilesPerYear: number, overageFeePerMile: Decimal }): MileageProjection**

    Formula:
    - averageMilesPerMonth = currentMileage / monthsElapsed
    - projectedEndMileage = round(averageMilesPerMonth * termMonths)
    - allowedMiles = allowedMilesPerYear * (termMonths / 12)
    - projectedOverage = max(0, projectedEndMileage - allowedMiles)
    - projectedOverageCost = projectedOverage * overageFeePerMile

    Cases:
    - On track: 10000 miles at 12 months, 36mo term, 12000/yr allowed -> projected 30000, allowed 36000, overage 0, cost $0
    - Over pace: 15000 miles at 12 months, 36mo term, 12000/yr allowed -> projected 45000, allowed 36000, overage 9000, cost $2250 at $0.25/mi
    - Under pace: 8000 miles at 12 months, 36mo term, 12000/yr allowed -> projected 24000, allowed 36000, overage 0, cost $0
    - Early in lease: 3000 miles at 3 months, 36mo term, 10000/yr allowed -> projected 36000, allowed 30000, overage 6000, cost $1500 at $0.25/mi
    - Edge case: monthsElapsed=0 should handle gracefully (return 0 projection or throw meaningful error)

    **calculateEquity(marketValue: Decimal, residualValue: Decimal, remainingPayments: Decimal, buyoutFee: Decimal): EquityCalculation**

    Formula:
    - buyoutCost = residualValue + remainingPayments + buyoutFee
    - equity = marketValue - buyoutCost
    - hasPositiveEquity = equity > 0

    Cases:
    - Positive equity: market=28000, residual=18000, remaining=3933 (10mo*393.33), fee=300 -> buyout=22233, equity=+5767
    - Negative equity: market=15000, residual=18000, remaining=3933, fee=300 -> buyout=22233, equity=-7233
    - Break even: market=22233, residual=18000, remaining=3933, fee=300 -> equity=0
    - Zero remaining: market=28000, residual=18000, remaining=0, fee=300 -> equity=9700

    Must return lineItems array with 4 entries: market value (asset), residual (liability), remaining payments (liability), buyout fee (liability).

    **calculateLeaseTax(stateCode: string, monthlyPayment: Decimal, termMonths: number, capCostReduction?: Decimal): TaxResult**

    Tax rules data in tax-rules.ts covers top 15 states by population:
    - CA: monthly, 7.25%, applies to down payment
    - TX: upfront, 6.25%
    - FL: monthly, 6.00%
    - NY: upfront, 4.00% (for leases over 1 year)
    - PA: monthly, 6.00%
    - IL: monthly, 6.25%
    - OH: monthly, 5.75%
    - GA: upfront (Title Ad Valorem Tax -- simplified to 6.6% of fair market value; for Phase 1, approximate as 6.6% of total payments)
    - NC: upfront (Highway Use Tax, 3% of total payments)
    - MI: monthly, 6.00%
    - NJ: monthly, 6.625%
    - VA: monthly, 4.15%
    - WA: monthly, 6.50%
    - AZ: monthly, 5.60%
    - OR: none, 0% (Oregon has no sales tax)

    Cases (upfront state -- TX):
    - monthlyPayment=393.33, term=36 -> totalPayments=14159.88, upfrontTax=884.99, monthlyTax=0

    Cases (monthly state -- CA):
    - monthlyPayment=393.33, term=36, capCostReduction=2000 -> monthlyTax=28.52, totalFromMonthly=1026.60, upfrontOnDown=145.00, totalTax=1171.60

    Cases (no-tax state -- OR):
    - monthlyPayment=393.33, term=36 -> upfrontTax=0, monthlyTax=0, totalTax=0

    Cases (unsupported state):
    - stateCode='XX' -> throws Error with message including 'XX'

    Edge cases:
    - CA with no cap cost reduction (omitted parameter): upfrontTax=0, monthlyTax calculated normally
    - Zero monthly payment: all taxes = 0
  </behavior>
  <implementation>
    Follow RED-GREEN-REFACTOR for each module.

    Order:
    1. mileage.ts -- standalone, no dependencies on other calcs
    2. equity.ts -- standalone, returns EquityCalculation type
    3. tax-rules.ts -- data file with STATE_TAX_RULES Record and types
    4. tax.ts -- uses tax-rules.ts lookup table

    For tax-rules.ts, cite LeaseGuide.com as the source in code comments. Note that rates and rules are approximate and should be verified -- include a comment with the research date (2026-01-28).

    After all pass, update `src/lib/calculations/index.ts` to export these new functions.

    Run `npm run test:coverage` -- all new files must have 100% coverage.
  </implementation>
</feature>

<verification>
1. `npm run test` passes with all mileage, equity, and tax tests green
2. `npm run test:coverage` shows 100% coverage on new calculation files
3. Mileage projection correctly handles on-track, over-pace, and under-pace scenarios
4. Equity calculation correctly identifies positive and negative equity with line items
5. Tax calculation produces different results for TX (upfront), CA (monthly), and OR (none)
6. Unsupported state code throws a descriptive error
7. All 15 state tax rules are present in tax-rules.ts
</verification>

<success_criteria>
Mileage projection, equity calculation, and state-aware tax calculation are implemented, fully tested, and produce correct results for real-world scenarios. The state tax rule table covers top 15 US states. These functions are ready to be consumed by scenario evaluators in Wave 3.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-calculation-engine/01-04-SUMMARY.md`
</output>
