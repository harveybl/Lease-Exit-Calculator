---
phase: 01-foundation-and-calculation-engine
plan: 05
type: tdd
wave: 3
depends_on: ["01-03", "01-04"]
files_modified:
  - src/lib/calculations/scenarios/return.ts
  - src/lib/calculations/scenarios/buyout.ts
  - src/lib/calculations/scenarios/sell-privately.ts
  - src/__tests__/lib/calculations/scenarios/return.test.ts
  - src/__tests__/lib/calculations/scenarios/buyout.test.ts
  - src/__tests__/lib/calculations/scenarios/sell-privately.test.ts
autonomous: true

must_haves:
  truths:
    - "evaluateReturnScenario produces an itemized breakdown with disposition fee, excess mileage cost, and wear-and-tear estimate"
    - "evaluateBuyoutScenario produces an itemized breakdown with residual value, remaining payments, purchase fee, and sales tax"
    - "evaluateSellPrivatelyScenario produces net proceeds showing payoff amount, estimated sale price, and cash flow"
    - "All three scenario functions return ScenarioResult with lineItems, warnings, and disclaimers arrays"
    - "Scenarios integrate with tax calculation for state-aware tax amounts"
    - "Scenarios integrate with mileage projection for excess mileage charges"
  artifacts:
    - path: "src/lib/calculations/scenarios/return.ts"
      provides: "Return-at-lease-end scenario evaluator"
      exports: ["evaluateReturnScenario"]
    - path: "src/lib/calculations/scenarios/buyout.ts"
      provides: "Lease buyout scenario evaluator"
      exports: ["evaluateBuyoutScenario"]
    - path: "src/lib/calculations/scenarios/sell-privately.ts"
      provides: "Private sale scenario evaluator"
      exports: ["evaluateSellPrivatelyScenario"]
  key_links:
    - from: "src/lib/calculations/scenarios/return.ts"
      to: "src/lib/calculations/mileage.ts"
      via: "uses projectMileage for excess mileage cost"
      pattern: "import.*mileage"
    - from: "src/lib/calculations/scenarios/buyout.ts"
      to: "src/lib/calculations/tax.ts"
      via: "uses calculateLeaseTax for purchase tax"
      pattern: "import.*tax"
    - from: "src/lib/calculations/scenarios/sell-privately.ts"
      to: "src/lib/calculations/equity.ts"
      via: "uses calculateEquity for net proceeds"
      pattern: "import.*equity"
---

<objective>
Build and test three exit scenario evaluators using TDD: return at lease end, buyout, and sell privately. Each produces an itemized cost breakdown with every fee line item, warnings, and legal disclaimers.

Purpose: These three scenarios represent the most common lease exit decisions. They integrate the core calculations (depreciation, mileage, equity, tax) from Plans 03 and 04 into actionable financial evaluations that will be displayed side-by-side in the comparison view (Phase 3).
Output: Three scenario evaluation functions that return complete ScenarioResult objects with line-item breakdowns.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-calculation-engine/01-RESEARCH.md
@.planning/phases/01-foundation-and-calculation-engine/01-01-SUMMARY.md
@.planning/phases/01-foundation-and-calculation-engine/01-03-SUMMARY.md
@.planning/phases/01-foundation-and-calculation-engine/01-04-SUMMARY.md
</context>

<feature>
  <name>Return, Buyout, and Sell-Privately Scenario Evaluators</name>
  <files>
    src/lib/calculations/scenarios/return.ts
    src/__tests__/lib/calculations/scenarios/return.test.ts
    src/lib/calculations/scenarios/buyout.ts
    src/__tests__/lib/calculations/scenarios/buyout.test.ts
    src/lib/calculations/scenarios/sell-privately.ts
    src/__tests__/lib/calculations/scenarios/sell-privately.test.ts
  </files>
  <behavior>
    All functions use Decimal from `@/lib/decimal`. All return types extend ScenarioResult from `@/lib/types`.

    **evaluateReturnScenario(params: { dispositionFee: Decimal, currentMileage: number, monthsElapsed: number, termMonths: number, allowedMilesPerYear: number, overageFeePerMile: Decimal, wearAndTearEstimate: Decimal, remainingPayments: Decimal }): ReturnScenarioResult**

    Logic:
    - Call projectMileage to get projected excess mileage cost
    - Total cost = remaining payments + disposition fee + excess mileage cost + wear-and-tear estimate
    - Line items: Remaining Payments, Disposition Fee, Excess Mileage (projected), Wear and Tear Estimate
    - Warnings: If overage > 0, warn about excess mileage. If wearAndTearEstimate > 0, warn this is user-estimated.
    - Disclaimers: Include mileage projection disclaimer.
    - type: 'return'

    Cases:
    - Clean return (no penalties): dispositionFee=395, mileage on track, no wear -> total = remainingPayments + 395
    - Over mileage: 15000 mi at 12mo, 36mo term, 12000/yr allowed, $0.25/mi -> projected overage cost=$2250 added to total
    - With wear estimate: wearAndTearEstimate=500 -> adds $500 line item with warning
    - Zero remaining payments (at lease end): remainingPayments=0 -> total is just fees

    **evaluateBuyoutScenario(params: { residualValue: Decimal, monthlyPayment: Decimal, monthsRemaining: number, purchaseFee: Decimal, stateCode: string }): BuyoutScenarioResult**

    Logic:
    - remainingPayments = monthlyPayment * monthsRemaining
    - Calculate sales tax on residual value using calculateLeaseTax (buyout tax applies to purchase price = residual)
      Note: For buyout, tax is typically on the residual value, not on lease payments. Use a simplified calculation: residualValue * state tax rate. If state is 'none' timing, tax = 0.
    - totalCost = residualValue + remainingPayments + purchaseFee + salesTax
    - Line items: Residual Value (buyout price), Remaining Payments, Purchase Fee, Sales Tax
    - Warnings: If monthsRemaining > 0, warn that remaining payments are required before or at buyout.
    - Disclaimers: Include tax disclaimer.
    - type: 'buyout'

    Cases:
    - End-of-lease buyout (TX): residual=18000, monthly=393.33, remaining=0, fee=300, state=TX -> tax=1125 (18000*0.0625), total=19425
    - Mid-lease buyout (CA): residual=18000, monthly=393.33, remaining=10mo, fee=300, state=CA -> remaining=3933.30, tax=1305 (18000*0.0725), total=23538.30
    - No-tax state (OR): residual=18000, monthly=393.33, remaining=0, fee=300, state=OR -> tax=0, total=18300

    **evaluateSellPrivatelyScenario(params: { estimatedSalePrice: Decimal, residualValue: Decimal, monthlyPayment: Decimal, monthsRemaining: number, purchaseFee: Decimal, stateCode: string }): SellPrivatelyResult**

    Logic:
    - First must buy out the lease (same cost as buyout scenario)
    - payoffAmount = residualValue + remaining payments + purchaseFee + buyout tax
    - netProceeds = estimatedSalePrice - payoffAmount
    - If netProceeds > 0: positive cash flow (profit)
    - If netProceeds < 0: need to bring money to close (loss)
    - Line items: Estimated Sale Price (asset), Lease Buyout Cost (liability, = payoffAmount), Net Proceeds (positive or negative)
    - Expand buyout into sub-line-items: Residual Value, Remaining Payments, Purchase Fee, Buyout Tax
    - Warnings: If net < 0, warn user needs to cover the difference. If remaining > 0, warn about timing (must buy out first, then sell).
    - Disclaimers: Include market value disclaimer.
    - type: 'sell-privately'
    - totalCost = if netProceeds > 0, the cost is the payoff amount (they get money back). Use netCost field: negative netProceeds means cost to user.
      Set totalCost = payoffAmount, netCost = payoffAmount.minus(estimatedSalePrice) (positive = cost, negative = profit).

    Cases:
    - Profitable sale (TX): salePrice=28000, residual=18000, remaining=0, fee=300, state=TX -> payoff=19425 (including tax), netProceeds=+8575
    - Loss sale: salePrice=15000, residual=18000, remaining=0, fee=300, state=TX -> payoff=19425, netProceeds=-4425
    - Mid-lease sale (CA): salePrice=28000, residual=18000, monthly=393.33, remaining=6mo, fee=300, state=CA -> payoff includes remaining payments + CA tax

    After all scenarios pass, update `src/lib/calculations/index.ts` to export scenario functions.
  </behavior>
  <implementation>
    Follow RED-GREEN-REFACTOR for each scenario module.

    Order:
    1. return.ts -- depends on mileage projection (from Plan 04)
    2. buyout.ts -- depends on tax calculation (from Plan 04)
    3. sell-privately.ts -- depends on buyout logic + equity concept

    For each:
    - RED: Write tests with all cases above. Import from source module. Run tests -- must fail.
    - GREEN: Implement the evaluator function. Import from Plan 03/04 calculation modules. Run tests -- must pass.
    - REFACTOR: Clean up if needed. Tests must still pass.

    Important: These scenario evaluators COMPOSE the lower-level functions from Plans 03 and 04. They should NOT re-implement formulas -- they should call calculateLeaseTax, projectMileage, etc.

    Run `npm run test:coverage` after all three pass.
  </implementation>
</feature>

<verification>
1. `npm run test` passes with all scenario tests green
2. `npm run test:coverage` shows 100% coverage on scenario files
3. Return scenario correctly integrates mileage projection for excess charges
4. Buyout scenario correctly integrates tax calculation for state-specific tax
5. Sell-privately scenario correctly computes net proceeds (profit or loss)
6. All three scenarios return lineItems, warnings, and disclaimers arrays
7. Each scenario result has the correct `type` field ('return', 'buyout', 'sell-privately')
</verification>

<success_criteria>
Three exit scenario evaluators (return, buyout, sell-privately) produce itemized cost breakdowns with every fee line item, integrate state-aware tax and mileage calculations, and include appropriate warnings and legal disclaimers. All tests pass with 100% coverage.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-calculation-engine/01-05-SUMMARY.md`
</output>
