---
phase: 05-authentication-and-multi-lease
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/app/layout.tsx
  - src/middleware.ts
  - src/app/(auth)/sign-in/[[...sign-in]]/page.tsx
  - src/app/(auth)/sign-up/[[...sign-up]]/page.tsx
  - .env.local
autonomous: false
user_setup:
  - service: clerk
    why: "Authentication provider for user accounts"
    env_vars:
      - name: NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY
        source: "Clerk Dashboard -> API Keys -> Publishable key"
      - name: CLERK_SECRET_KEY
        source: "Clerk Dashboard -> API Keys -> Secret key"
    dashboard_config:
      - task: "Create a Clerk application"
        location: "https://dashboard.clerk.com -> Create application"
      - task: "Enable email + Google sign-in methods"
        location: "Clerk Dashboard -> User & Authentication -> Email, Phone, Username"

must_haves:
  truths:
    - "ClerkProvider wraps the entire application in root layout"
    - "Middleware protects /lease routes and redirects unauthenticated users to sign-in"
    - "Sign-in and sign-up pages render Clerk pre-built components"
    - "Webhook routes are excluded from middleware protection"
  artifacts:
    - path: "src/middleware.ts"
      provides: "Route protection via clerkMiddleware"
      contains: "clerkMiddleware"
    - path: "src/app/layout.tsx"
      provides: "ClerkProvider wrapping application"
      contains: "ClerkProvider"
    - path: "src/app/(auth)/sign-in/[[...sign-in]]/page.tsx"
      provides: "Clerk sign-in page"
      contains: "SignIn"
    - path: "src/app/(auth)/sign-up/[[...sign-up]]/page.tsx"
      provides: "Clerk sign-up page"
      contains: "SignUp"
  key_links:
    - from: "src/middleware.ts"
      to: "Clerk authentication service"
      via: "clerkMiddleware with createRouteMatcher"
      pattern: "createRouteMatcher.*lease"
    - from: "src/app/layout.tsx"
      to: "@clerk/nextjs"
      via: "ClerkProvider component"
      pattern: "ClerkProvider"
---

<objective>
Install Clerk, wrap the app with ClerkProvider, configure middleware for route protection, and create sign-in/sign-up pages.

Purpose: This is the authentication foundation. Every subsequent plan depends on Clerk being installed and middleware protecting routes.
Output: Working Clerk authentication with sign-in/sign-up pages and middleware-based route protection.
</objective>

<execution_context>
@/Users/brandonharvey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brandonharvey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-authentication-and-multi-lease/05-RESEARCH.md
@src/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Clerk and create auth infrastructure</name>
  <files>
    package.json
    src/app/layout.tsx
    src/middleware.ts
    .env.local
  </files>
  <action>
    1. Install dependencies:
       ```bash
       npm install @clerk/nextjs svix
       ```

    2. Create `.env.local` with placeholder Clerk keys (user will fill in real values):
       ```
       NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_PLACEHOLDER
       CLERK_SECRET_KEY=sk_test_PLACEHOLDER
       NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
       NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up
       NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/lease
       NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/lease
       CLERK_WEBHOOK_SIGNING_SECRET=whsec_PLACEHOLDER
       ```

    3. Update `src/app/layout.tsx`:
       - Import `ClerkProvider` from `@clerk/nextjs`
       - Wrap `<html>` inside `<ClerkProvider>`
       - Keep existing metadata, globals.css import, and body structure

    4. Create `src/middleware.ts` (at src root, NOT app directory):
       - Import `clerkMiddleware` and `createRouteMatcher` from `@clerk/nextjs/server`
       - Define `isProtectedRoute` matcher for `/lease(.*)` paths
       - In the middleware callback, call `await auth.protect()` when `isProtectedRoute(req)` matches
       - Export Next.js config matcher that excludes static files and includes api/trpc routes
       - IMPORTANT: Do NOT protect `/api/webhooks(.*)` routes (webhooks must be publicly accessible)
       - IMPORTANT: Do NOT protect `/sign-in(.*)` or `/sign-up(.*)` routes

    Decision: Direct to sign-in (no landing/marketing page). The current home page at `/` will remain public as an entry point, but `/lease/*` routes are protected.
  </action>
  <verify>
    - `npm ls @clerk/nextjs` shows installed version
    - `npm ls svix` shows installed version
    - `src/middleware.ts` exists and contains `clerkMiddleware`
    - `src/app/layout.tsx` contains `ClerkProvider`
    - `.env.local` exists with placeholder keys
  </verify>
  <done>Clerk is installed, ClerkProvider wraps the app, middleware protects /lease routes, and env vars are templated</done>
</task>

<task type="auto">
  <name>Task 2: Create sign-in and sign-up pages</name>
  <files>
    src/app/(auth)/sign-in/[[...sign-in]]/page.tsx
    src/app/(auth)/sign-up/[[...sign-up]]/page.tsx
  </files>
  <action>
    1. Create `src/app/(auth)/sign-in/[[...sign-in]]/page.tsx`:
       - Import `SignIn` from `@clerk/nextjs`
       - Render `<SignIn />` centered on screen using flexbox (min-h-screen, items-center, justify-center)
       - Use the warm background from existing design (`bg-background`)

    2. Create `src/app/(auth)/sign-up/[[...sign-up]]/page.tsx`:
       - Import `SignUp` from `@clerk/nextjs`
       - Render `<SignUp />` centered on screen using same layout pattern

    The `[[...sign-in]]` catch-all route pattern is required by Clerk for handling multi-step auth flows (email verification, MFA, etc.).

    Decision: Use Clerk's pre-built `<SignIn />` and `<SignUp />` components (not custom forms). These provide production-ready accessibility, MFA support, social providers, and email verification out of the box.
    Decision: Enable email + Google sign-in methods (configured in Clerk dashboard, not in code).
  </action>
  <verify>
    - `src/app/(auth)/sign-in/[[...sign-in]]/page.tsx` exists and imports `SignIn` from `@clerk/nextjs`
    - `src/app/(auth)/sign-up/[[...sign-up]]/page.tsx` exists and imports `SignUp` from `@clerk/nextjs`
  </verify>
  <done>Sign-in and sign-up pages exist using Clerk pre-built components with centered layout</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Configure Clerk environment variables</action>
  <instructions>
    1. Go to https://dashboard.clerk.com and create a new application (or use existing)
    2. Enable "Email" and "Google" sign-in methods under User & Authentication
    3. Copy the Publishable Key and Secret Key from API Keys
    4. Edit `.env.local` and replace the PLACEHOLDER values:
       - `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_YOUR_KEY`
       - `CLERK_SECRET_KEY=sk_test_YOUR_KEY`
       (Leave CLERK_WEBHOOK_SIGNING_SECRET as PLACEHOLDER for now - Plan 03 will configure webhooks)
    5. Verify the dev server starts: `npm run dev`
  </instructions>
  <resume-signal>Type "configured" when Clerk keys are set in .env.local and dev server runs</resume-signal>
</task>

</tasks>

<verification>
- `npm run build` succeeds (or at minimum `npm run dev` starts without Clerk config errors)
- Visiting `/sign-in` shows Clerk sign-in UI
- Visiting `/lease` redirects to `/sign-in` when not authenticated
- Visiting `/` (home page) works without authentication
</verification>

<success_criteria>
Clerk is installed and configured. ClerkProvider wraps the app. Middleware protects /lease routes. Sign-in and sign-up pages render Clerk components. Unauthenticated users are redirected from protected routes.
</success_criteria>

<output>
After completion, create `.planning/phases/05-authentication-and-multi-lease/05-01-SUMMARY.md`
</output>
