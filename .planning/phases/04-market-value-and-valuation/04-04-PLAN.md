---
phase: 04-market-value-and-valuation
plan: 04
type: execute
wave: 3
depends_on: [04-03]
files_modified:
  - src/components/comparison/MarketValueBanner.tsx
  - src/components/comparison/MarketValueDisplay.tsx
  - src/components/comparison/EquityDisplay.tsx

autonomous: true

must_haves:
  truths:
    - "When no market value exists, a prominent CTA banner appears saying 'Add your vehicle's market value for accurate results'"
    - "When market value exists, it displays the value, source label, last-updated relative time, and an edit button"
    - "Staleness warning appears for values older than 30 days"
    - "Inline edit saves market value via server action and comparison recalculates immediately"
    - "Equity display shows 'Your vehicle has $X in positive/negative equity' when market value exists"
    - "Educational popover on banner includes links to KBB, Edmunds, Carvana with tip about trade-in value"
  artifacts:
    - path: "src/components/comparison/MarketValueBanner.tsx"
      provides: "CTA banner for missing market value with inline entry form"
      min_lines: 40
    - path: "src/components/comparison/MarketValueDisplay.tsx"
      provides: "Display with value, source, staleness, edit capability"
      min_lines: 60
    - path: "src/components/comparison/EquityDisplay.tsx"
      provides: "Equity callout card"
      min_lines: 20
  key_links:
    - from: "src/components/comparison/MarketValueBanner.tsx"
      to: "src/app/lease/actions.ts"
      via: "createMarketValue server action"
      pattern: "createMarketValue"
    - from: "src/components/comparison/MarketValueDisplay.tsx"
      to: "src/app/lease/actions.ts"
      via: "createMarketValue for updates"
      pattern: "createMarketValue"
---

<objective>
Build the three standalone market value UI components: CTA banner when no value exists, display with inline edit when value exists, and equity callout card.

Purpose: Creates the visual components users interact with for market value entry and display. These components are self-contained and testable before integration.
Output: Three new components (MarketValueBanner, MarketValueDisplay, EquityDisplay) ready for integration in Plan 05.
</objective>

<execution_context>
@/Users/brandonharvey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brandonharvey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/04-market-value-and-valuation/04-CONTEXT.md
@.planning/phases/04-market-value-and-valuation/04-03-SUMMARY.md
@src/components/comparison/ComparisonView.tsx
@src/components/comparison/HeroSummary.tsx
@src/app/lease/actions.ts
@src/lib/utils/staleness.ts
@src/lib/validations/market-value-schema.ts
@src/lib/utils/format-currency.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: MarketValueBanner and MarketValueDisplay components</name>
  <files>
    src/components/comparison/MarketValueBanner.tsx
    src/components/comparison/MarketValueDisplay.tsx
  </files>
  <action>
    **1. Create MarketValueBanner.tsx (client component):**

    This is a "use client" component shown when no market value exists. It includes:
    - A prominent card with teal/primary border (similar to HeroSummary's border-2 border-primary pattern)
    - Heading: "Add Your Vehicle's Market Value"
    - Subtext: "Get accurate results for buyout and sell-privately options"
    - An inline form with:
      - Dollar-prefixed input field for value (follow the absolute-positioned $ prefix pattern from Phase 2)
      - Submit button ("Save")
    - Educational Popover (Info icon) with:
      - "Where to look up your vehicle's value:"
      - Links: KBB (https://www.kbb.com/whats-my-car-worth/), Edmunds (https://www.edmunds.com/appraisal/), Carvana (https://www.carvana.com/sell-my-car)
      - Tip: "Use the trade-in value for the most conservative estimate"
    - On submit:
      - Validate with marketValueSchema
      - Call `createMarketValue(leaseId, { value })` server action
      - Use `useTransition` for pending state (disable button, show loading)
      - On success, the page revalidates automatically (server action calls revalidatePath)

    Props: `{ leaseId: string }`

    Follow existing patterns:
    - Popover from Phase 2 ([02-02] decision)
    - Info icon from lucide-react
    - Card from shadcn/ui
    - useTransition for server action pending state

    **2. Create MarketValueDisplay.tsx (client component):**

    This is a "use client" component shown when market value exists. It includes:
    - Display mode (default):
      - Value in large text: "$25,000" (use formatCurrency)
      - Source label in muted text: "Your estimate"
      - Relative time: "Updated 5 days ago" (use checkValueStaleness)
      - Edit button (pencil icon from lucide-react)
      - Staleness warning (if applicable): amber text with AlertCircle icon + message from checkValueStaleness
      - Accuracy disclaimer: "Market values are estimates and may vary by condition, location, and market conditions."
    - Edit mode (toggled by edit button):
      - Dollar-prefixed input pre-filled with current value
      - Save button (Check icon) and Cancel button (X icon)
      - Disabled during save (useTransition)
      - On save: call `createMarketValue(leaseId, { value: newValue })` -- this creates a NEW record (history preserved)
      - On cancel: reset to display mode

    Props: `{ leaseId: string; marketValue: { value: Decimal | string | number; sourceLabel: string | null; createdAt: Date; source: string } }`

    Handle RSC serialization: marketValue.value may arrive as string from server component ([03-04] decision). Convert to number for display with `Number(marketValue.value)`.

    Educational Popover with same KBB/Edmunds/Carvana links as the banner (for updating).
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Both components are "use client" directives
    - MarketValueBanner renders with input, submit, and educational popover
    - MarketValueDisplay renders value, source, relative time, edit button
    - Both call createMarketValue server action
  </verify>
  <done>
    - MarketValueBanner shows CTA with inline entry form and educational links
    - MarketValueDisplay shows current value with inline edit, staleness, disclaimer
    - Both handle loading states with useTransition
    - Both use existing shadcn/ui components (Card, Input, Button, Popover)
  </done>
</task>

<task type="auto">
  <name>Task 2: EquityDisplay component</name>
  <files>
    src/components/comparison/EquityDisplay.tsx
  </files>
  <action>
    **Create EquityDisplay.tsx (server component -- no interactivity needed):**

    A compact card showing the equity position:
    - When equity is positive: "Your vehicle has $3,200 in positive equity" (green/primary text)
    - When equity is negative: "Your vehicle has -$1,500 in negative equity" (red/destructive text)
    - When equity is zero or near-zero (within $50): "Your vehicle has approximately no equity"
    - Brief explanation: "Equity = market value minus what you owe to buy out the lease"
    - Use formatCurrency for amounts
    - Compact design: single line with small explanatory text below

    Props: `{ equity: { amount: Decimal | string | number; isPositive: boolean } }`

    Handle RSC serialization of Decimal values (accept Decimal | string | number per [03-04] decision).
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - EquityDisplay renders correctly for positive equity (green styling)
    - EquityDisplay renders correctly for negative equity (red/destructive styling)
    - EquityDisplay renders correctly for near-zero equity
  </verify>
  <done>
    - EquityDisplay component shows equity position with clear positive/negative styling
    - Handles all three states: positive, negative, near-zero
    - Uses formatCurrency for consistent number formatting
    - Accepts serialized Decimal values from server components
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes for all three new components
- All components follow existing patterns (shadcn/ui, lucide-react icons, useTransition)
- MarketValueBanner and MarketValueDisplay both import and call createMarketValue
- EquityDisplay handles all equity states (positive, negative, near-zero)
</verification>

<success_criteria>
- Three standalone components created and type-check cleanly
- Banner has CTA form with educational popover
- Display has inline edit with staleness warning
- Equity shows positive/negative with appropriate styling
- Components are ready for integration in Plan 05
</success_criteria>

<output>
After completion, create `.planning/phases/04-market-value-and-valuation/04-04-SUMMARY.md`
</output>
