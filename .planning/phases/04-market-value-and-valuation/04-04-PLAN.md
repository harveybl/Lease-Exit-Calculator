---
phase: 04-market-value-and-valuation
plan: 04
type: execute
wave: 3
depends_on: [04-03]
files_modified:
  - src/components/comparison/MarketValueBanner.tsx
  - src/components/comparison/MarketValueDisplay.tsx
  - src/components/comparison/EquityDisplay.tsx
  - src/components/comparison/ComparisonView.tsx
  - src/components/comparison/HeroSummary.tsx

autonomous: false

must_haves:
  truths:
    - "When no market value exists, a prominent CTA banner appears saying 'Add your vehicle's market value for accurate results'"
    - "When market value exists, it displays the value, source label, last-updated relative time, and an edit button"
    - "Staleness warning appears for values older than 30 days"
    - "Inline edit saves market value via server action and comparison recalculates immediately"
    - "Equity display shows 'Your vehicle has $X in positive/negative equity' when market value exists"
    - "Educational popover on banner includes links to KBB, Edmunds, Carvana with tip about trade-in value"
    - "Incomplete scenarios show an 'incomplete' badge or message instead of ranking"
  artifacts:
    - path: "src/components/comparison/MarketValueBanner.tsx"
      provides: "CTA banner for missing market value with inline entry form"
      min_lines: 40
    - path: "src/components/comparison/MarketValueDisplay.tsx"
      provides: "Display with value, source, staleness, edit capability"
      min_lines: 60
    - path: "src/components/comparison/EquityDisplay.tsx"
      provides: "Equity callout card"
      min_lines: 20
    - path: "src/components/comparison/ComparisonView.tsx"
      provides: "Updated to include market value components"
      contains: "MarketValueBanner"
    - path: "src/components/comparison/HeroSummary.tsx"
      provides: "Updated with equity information"
      contains: "equity"
  key_links:
    - from: "src/components/comparison/MarketValueBanner.tsx"
      to: "src/app/lease/actions.ts"
      via: "createMarketValue server action"
      pattern: "createMarketValue"
    - from: "src/components/comparison/MarketValueDisplay.tsx"
      to: "src/app/lease/actions.ts"
      via: "createMarketValue for updates"
      pattern: "createMarketValue"
    - from: "src/components/comparison/ComparisonView.tsx"
      to: "MarketValueBanner|MarketValueDisplay"
      via: "conditional rendering based on marketValue prop"
      pattern: "marketValue.*MarketValue"
---

<objective>
Build the market value UI components for the comparison page: CTA banner when no value exists, display with inline edit when value exists, equity callout, staleness warning, and educational content.

Purpose: This is what the user sees and interacts with. The banner drives market value entry; the display shows current value with edit capability; equity display makes the "why" behind recommendations clear.
Output: Four new components integrated into ComparisonView and HeroSummary.
</objective>

<execution_context>
@/Users/brandonharvey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brandonharvey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/04-market-value-and-valuation/04-CONTEXT.md
@.planning/phases/04-market-value-and-valuation/04-03-SUMMARY.md
@src/components/comparison/ComparisonView.tsx
@src/components/comparison/HeroSummary.tsx
@src/components/comparison/OptionCard.tsx
@src/app/lease/actions.ts
@src/lib/utils/staleness.ts
@src/lib/validations/market-value-schema.ts
@src/lib/utils/format-currency.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: MarketValueBanner and MarketValueDisplay components</name>
  <files>
    src/components/comparison/MarketValueBanner.tsx
    src/components/comparison/MarketValueDisplay.tsx
  </files>
  <action>
    **1. Create MarketValueBanner.tsx (client component):**

    This is a "use client" component shown when no market value exists. It includes:
    - A prominent card with teal/primary border (similar to HeroSummary's border-2 border-primary pattern)
    - Heading: "Add Your Vehicle's Market Value"
    - Subtext: "Get accurate results for buyout and sell-privately options"
    - An inline form with:
      - Dollar-prefixed input field for value (follow the absolute-positioned $ prefix pattern from Phase 2)
      - Submit button ("Save")
    - Educational Popover (Info icon) with:
      - "Where to look up your vehicle's value:"
      - Links: KBB (https://www.kbb.com/whats-my-car-worth/), Edmunds (https://www.edmunds.com/appraisal/), Carvana (https://www.carvana.com/sell-my-car)
      - Tip: "Use the trade-in value for the most conservative estimate"
    - On submit:
      - Validate with marketValueSchema
      - Call `createMarketValue(leaseId, { value })` server action
      - Use `useTransition` for pending state (disable button, show loading)
      - On success, the page revalidates automatically (server action calls revalidatePath)

    Props: `{ leaseId: string }`

    Follow existing patterns:
    - Popover from Phase 2 ([02-02] decision)
    - Info icon from lucide-react
    - Card from shadcn/ui
    - useTransition for server action pending state

    **2. Create MarketValueDisplay.tsx (client component):**

    This is a "use client" component shown when market value exists. It includes:
    - Display mode (default):
      - Value in large text: "$25,000" (use formatCurrency)
      - Source label in muted text: "Your estimate"
      - Relative time: "Updated 5 days ago" (use checkValueStaleness)
      - Edit button (pencil icon from lucide-react)
      - Staleness warning (if applicable): amber text with AlertCircle icon + message from checkValueStaleness
      - Accuracy disclaimer: "Market values are estimates and may vary by condition, location, and market conditions."
    - Edit mode (toggled by edit button):
      - Dollar-prefixed input pre-filled with current value
      - Save button (Check icon) and Cancel button (X icon)
      - Disabled during save (useTransition)
      - On save: call `createMarketValue(leaseId, { value: newValue })` -- this creates a NEW record (history preserved)
      - On cancel: reset to display mode

    Props: `{ leaseId: string; marketValue: { value: Decimal | string | number; sourceLabel: string | null; createdAt: Date; source: string } }`

    Handle RSC serialization: marketValue.value may arrive as string from server component ([03-04] decision). Convert to number for display with `Number(marketValue.value)`.

    Educational Popover with same KBB/Edmunds/Carvana links as the banner (for updating).
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Both components are "use client" directives
    - MarketValueBanner renders with input, submit, and educational popover
    - MarketValueDisplay renders value, source, relative time, edit button
    - Both call createMarketValue server action
  </verify>
  <done>
    - MarketValueBanner shows CTA with inline entry form and educational links
    - MarketValueDisplay shows current value with inline edit, staleness, disclaimer
    - Both handle loading states with useTransition
    - Both use existing shadcn/ui components (Card, Input, Button, Popover)
  </done>
</task>

<task type="auto">
  <name>Task 2: EquityDisplay component and integration</name>
  <files>
    src/components/comparison/EquityDisplay.tsx
    src/components/comparison/ComparisonView.tsx
    src/components/comparison/HeroSummary.tsx
  </files>
  <action>
    **1. Create EquityDisplay.tsx (server component -- no interactivity needed):**

    A compact card showing the equity position:
    - When equity is positive: "Your vehicle has $3,200 in positive equity" (green/primary text)
    - When equity is negative: "Your vehicle has -$1,500 in negative equity" (red/destructive text)
    - When equity is zero or near-zero (within $50): "Your vehicle has approximately no equity"
    - Brief explanation: "Equity = market value minus what you owe to buy out the lease"
    - Use formatCurrency for amounts
    - Compact design: single line with small explanatory text below

    Props: `{ equity: { amount: Decimal | string | number; isPositive: boolean } }`

    Handle RSC serialization of Decimal values (accept Decimal | string | number per [03-04] decision).

    **2. Update ComparisonView.tsx:**

    Replace the placeholder comment from Plan 03 with actual component rendering:

    ```tsx
    {/* Market value entry/display - above hero summary */}
    {marketValue ? (
      <MarketValueDisplay leaseId={leaseId} marketValue={marketValue} />
    ) : (
      <MarketValueBanner leaseId={leaseId} />
    )}
    ```

    Place this ABOVE the HeroSummary. The market value section should be the first thing users see on the comparison page.

    Add imports for MarketValueBanner and MarketValueDisplay.

    Pass equity data from ComparisonData to HeroSummary:
    ```tsx
    <HeroSummary data={data} />
    ```
    (equity is already in ComparisonData from Plan 02)

    Handle incomplete scenarios in OptionsList: if a scenario has `incomplete: true`, the OptionCard should show a muted "Incomplete - add market value" message instead of the rank badge. Check if OptionCard needs updates for this -- if the `incomplete` flag exists on ScenarioResult, add conditional rendering.

    Update OptionCard (if needed) to show incomplete state:
    - Instead of rank number badge, show a muted "?" or "Needs market value" indicator
    - Muted styling (opacity-60 or similar) for incomplete scenario cards

    **3. Update HeroSummary.tsx:**

    Add equity display below the savings description when equity data exists:

    ```tsx
    {data.equity && (
      <EquityDisplay equity={data.equity} />
    )}
    ```

    Place it within the CardContent, after the mini totals grid.

    Also update the incomplete handling: if data.hasMarketValue is false, add a subtle note in the hero:
    "Some options are estimates â€” add your market value for complete results"
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds
    - ComparisonView conditionally renders banner vs display based on marketValue prop
    - EquityDisplay renders correctly for positive and negative equity
    - HeroSummary shows equity when available
    - Incomplete scenarios show appropriate visual treatment
  </verify>
  <done>
    - EquityDisplay component shows equity position with clear positive/negative styling
    - ComparisonView integrates all market value components
    - HeroSummary includes equity callout
    - Incomplete scenarios are visually distinct from complete ones
    - Market value section appears above hero summary
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 4 market value integration:
    1. Database schema for market_values table with history tracking
    2. Valuation provider interface for future API extensibility
    3. Evaluation logic updated to use real market value (not residual placeholder)
    4. Server actions for creating/fetching market values
    5. CTA banner when no market value exists (with educational links)
    6. Inline display and edit when market value exists
    7. Equity display showing positive/negative equity
    8. Staleness warning for values older than 30 days
    9. Incomplete scenario handling for equity-dependent options
  </what-built>
  <how-to-verify>
    1. Start the dev server: `npm run dev`
    2. Navigate to an existing lease comparison page (e.g., /lease/{id}/compare)
    3. **No market value state:**
       - Verify a prominent banner appears: "Add Your Vehicle's Market Value"
       - Click the info icon to see educational popover with KBB/Edmunds/Carvana links
       - Verify sell-privately option shows as incomplete/needs market value
    4. **Add a market value:**
       - Enter a value (e.g., 28000) in the banner input and click Save
       - Verify the comparison results update immediately
       - Verify the banner is replaced by a display showing the value, "Your estimate", and "Updated today"
       - Verify sell-privately option is now fully calculated
       - Verify equity display shows positive or negative equity
    5. **Edit the market value:**
       - Click the edit (pencil) icon on the market value display
       - Change the value and save
       - Verify results recalculate immediately
    6. **Overall UX:**
       - Check that the layout looks clean and consistent with the rest of the comparison page
       - Verify the market value section appears above the hero summary
       - Check mobile responsiveness (resize browser)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- All components render correctly for both states (no market value, has market value)
- Server actions create/fetch market values correctly
- Comparison results update immediately on market value save
- Equity display shows correct positive/negative amounts
- Staleness warning appears for old values
- Incomplete scenarios have visual treatment
- No TypeScript errors, build succeeds
</verification>

<success_criteria>
- User can enter market value from comparison page via prominent CTA banner
- Entered value immediately updates comparison results
- Market value display shows value, source, last updated time, and accuracy disclaimer
- Equity is displayed prominently when market value exists
- Educational popover includes lookup links (KBB, Edmunds, Carvana)
- Incomplete scenarios clearly distinguished from complete ones
- Human verification confirms working end-to-end flow
</success_criteria>

<output>
After completion, create `.planning/phases/04-market-value-and-valuation/04-04-SUMMARY.md`
</output>
