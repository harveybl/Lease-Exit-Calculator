---
phase: 04-market-value-and-valuation
plan: 05
type: execute
wave: 4
depends_on: [04-04]
files_modified:
  - src/components/comparison/ComparisonView.tsx
  - src/components/comparison/HeroSummary.tsx
  - src/components/comparison/OptionCard.tsx

autonomous: false

must_haves:
  truths:
    - "ComparisonView renders MarketValueBanner when marketValue is null, MarketValueDisplay when present"
    - "Market value section appears above the HeroSummary in the page layout"
    - "EquityDisplay appears in HeroSummary when data.equity exists"
    - "HeroSummary shows 'Some options are estimates' note when data.hasMarketValue is false"
    - "Incomplete scenarios show a muted '?' badge instead of rank number in OptionCard"
    - "Incomplete scenario cards have muted opacity styling"
    - "Human verifies full end-to-end flow: no market value -> add value -> edit value"
  artifacts:
    - path: "src/components/comparison/ComparisonView.tsx"
      provides: "Updated to include MarketValueBanner/Display conditional rendering"
      contains: "MarketValueBanner"
    - path: "src/components/comparison/HeroSummary.tsx"
      provides: "Updated with equity information and incomplete data note"
      contains: "EquityDisplay"
    - path: "src/components/comparison/OptionCard.tsx"
      provides: "Updated to handle incomplete scenarios with muted '?' badge"
      contains: "incomplete"
  key_links:
    - from: "src/components/comparison/ComparisonView.tsx"
      to: "MarketValueBanner|MarketValueDisplay"
      via: "conditional rendering based on marketValue prop"
      pattern: "marketValue.*MarketValue"
    - from: "src/components/comparison/HeroSummary.tsx"
      to: "src/components/comparison/EquityDisplay.tsx"
      via: "renders EquityDisplay when equity exists"
      pattern: "EquityDisplay"
    - from: "src/components/comparison/OptionCard.tsx"
      to: "ScenarioResult.incomplete"
      via: "conditional badge rendering"
      pattern: "incomplete"
---

<objective>
Integrate the market value components (from Plan 04) into the comparison page layout, update OptionCard for incomplete scenarios, and verify the full end-to-end flow with a human checkpoint.

Purpose: Wires the standalone components into the live page. Without this, the components exist but are not rendered. The OptionCard update ensures incomplete scenarios are visually distinct.
Output: ComparisonView, HeroSummary, and OptionCard updated. Human-verified end-to-end market value flow.
</objective>

<execution_context>
@/Users/brandonharvey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brandonharvey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/04-market-value-and-valuation/04-CONTEXT.md
@.planning/phases/04-market-value-and-valuation/04-04-SUMMARY.md
@src/components/comparison/ComparisonView.tsx
@src/components/comparison/HeroSummary.tsx
@src/components/comparison/OptionCard.tsx
@src/components/comparison/MarketValueBanner.tsx
@src/components/comparison/MarketValueDisplay.tsx
@src/components/comparison/EquityDisplay.tsx
@src/lib/types/scenario.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire components into ComparisonView, HeroSummary, and OptionCard</name>
  <files>
    src/components/comparison/ComparisonView.tsx
    src/components/comparison/HeroSummary.tsx
    src/components/comparison/OptionCard.tsx
  </files>
  <action>
    **1. Update ComparisonView.tsx:**

    Replace the placeholder comment from Plan 03 with actual component rendering:

    ```tsx
    {/* Market value entry/display - above hero summary */}
    {marketValue ? (
      <MarketValueDisplay leaseId={leaseId} marketValue={marketValue} />
    ) : (
      <MarketValueBanner leaseId={leaseId} />
    )}
    ```

    Place this ABOVE the HeroSummary. The market value section should be the first thing users see on the comparison page.

    Add imports for MarketValueBanner and MarketValueDisplay.

    Pass equity data from ComparisonData to HeroSummary:
    ```tsx
    <HeroSummary data={data} />
    ```
    (equity is already in ComparisonData from Plan 02)

    **2. Update HeroSummary.tsx:**

    Add equity display below the savings description when equity data exists:

    ```tsx
    {data.equity && (
      <EquityDisplay equity={data.equity} />
    )}
    ```

    Place it within the CardContent, after the mini totals grid.

    Add import for EquityDisplay.

    Also add incomplete handling: if data.hasMarketValue is false, render a subtle muted note:
    "Some options are estimates -- add your market value for complete results"

    **3. Update OptionCard.tsx for incomplete scenarios:**

    Add `incomplete?: boolean` to the OptionCard props interface (or read it from the scenario data passed to the card).

    Make these concrete changes:
    - Add `incomplete?: boolean` to OptionCardProps
    - When `incomplete` is true:
      - Render a muted "?" badge instead of the rank number badge (same badge shape, but with `bg-muted text-muted-foreground` instead of the rank color)
      - Apply `opacity-60` to the card wrapper
      - Show a brief inline message: "Needs market value" in muted text below the scenario name
    - When `incomplete` is false or undefined: render normally (no change to existing behavior)

    In the parent component that renders OptionCards (OptionsList or ComparisonView), pass the `incomplete` flag from `ScenarioResult.incomplete` to each OptionCard.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds (catches RSC/client boundary issues)
    - Manually verify: MarketValueBanner renders on comparison page when no market value exists for the lease (check the dev server at `/lease/{id}/compare`)
    - Manually verify: EquityDisplay appears in HeroSummary when data.equity is present (requires a market value to be saved)
    - Manually verify: OptionCard shows muted "?" badge and `opacity-60` styling for scenarios where `incomplete: true` (visible when no market value exists for sell-privately scenario)
    - Manually verify: OptionCard shows normal rank badge for complete scenarios (e.g., return-lease, which is always complete)
  </verify>
  <done>
    - ComparisonView conditionally renders MarketValueBanner (no value) or MarketValueDisplay (has value) above HeroSummary
    - HeroSummary renders EquityDisplay when equity data exists
    - HeroSummary shows "Some options are estimates" note when hasMarketValue is false
    - OptionCard renders muted "?" badge with opacity-60 for incomplete scenarios
    - OptionCard renders normal rank badge for complete scenarios
    - All three files updated and type-check cleanly
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 4 market value integration:
    1. Database schema for market_values table with history tracking
    2. Valuation provider interface for future API extensibility
    3. Evaluation logic updated to use real market value (not residual placeholder)
    4. Server actions for creating/fetching market values
    5. CTA banner when no market value exists (with educational links)
    6. Inline display and edit when market value exists
    7. Equity display showing positive/negative equity
    8. Staleness warning for values older than 30 days
    9. Incomplete scenario handling with muted "?" badge in OptionCard
  </what-built>
  <how-to-verify>
    1. Start the dev server: `npm run dev`
    2. Navigate to an existing lease comparison page (e.g., /lease/{id}/compare)
    3. **No market value state:**
       - Verify a prominent banner appears: "Add Your Vehicle's Market Value"
       - Click the info icon to see educational popover with KBB/Edmunds/Carvana links
       - Verify sell-privately option shows as incomplete with muted "?" badge and reduced opacity
       - Verify complete scenarios (e.g., return-lease) still show normal rank badges
    4. **Add a market value:**
       - Enter a value (e.g., 28000) in the banner input and click Save
       - Verify the comparison results update immediately
       - Verify the banner is replaced by a display showing the value, "Your estimate", and "Updated today"
       - Verify sell-privately option is now fully calculated with a real rank badge
       - Verify equity display shows positive or negative equity in the HeroSummary
    5. **Edit the market value:**
       - Click the edit (pencil) icon on the market value display
       - Change the value and save
       - Verify results recalculate immediately
    6. **Overall UX:**
       - Check that the layout looks clean and consistent with the rest of the comparison page
       - Verify the market value section appears above the hero summary
       - Check mobile responsiveness (resize browser)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- All components render correctly for both states (no market value, has market value)
- Comparison results update immediately on market value save
- Equity display shows correct positive/negative amounts in HeroSummary
- Incomplete scenarios show muted "?" badge in OptionCard
- No TypeScript errors, build succeeds
</verification>

<success_criteria>
- Market value components integrated into comparison page layout
- OptionCard handles incomplete scenarios with muted visual treatment
- HeroSummary includes equity callout and incomplete data note
- Human verification confirms working end-to-end flow
</success_criteria>

<output>
After completion, create `.planning/phases/04-market-value-and-valuation/04-05-SUMMARY.md`
</output>
