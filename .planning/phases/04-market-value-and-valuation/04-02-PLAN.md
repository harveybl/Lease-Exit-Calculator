---
phase: 04-market-value-and-valuation
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/lib/calculations/evaluate-all.ts
  - src/lib/types/scenario.ts
  - src/__tests__/lib/calculations/evaluate-all.test.ts

autonomous: true

must_haves:
  truths:
    - "evaluateAllScenarios accepts an optional estimatedSalePrice parameter"
    - "When estimatedSalePrice is provided, sell-privately scenario uses it instead of residualValue"
    - "When estimatedSalePrice is null/undefined, sell-privately and buyout scenarios are marked incomplete"
    - "getComparisonData returns a hasMarketValue flag and equity information when market value is present"
    - "Incomplete scenarios are excluded from best-option ranking"
  artifacts:
    - path: "src/lib/calculations/evaluate-all.ts"
      provides: "Updated evaluateAllScenarios and getComparisonData with market value support"
      exports: ["evaluateAllScenarios", "getComparisonData", "ComparisonData"]
    - path: "src/lib/types/scenario.ts"
      provides: "ScenarioResult with optional incomplete flag"
      contains: "incomplete"
    - path: "src/__tests__/lib/calculations/evaluate-all.test.ts"
      provides: "Tests for market value handling in evaluation"
  key_links:
    - from: "src/lib/calculations/evaluate-all.ts"
      to: "evaluateSellPrivatelyScenario"
      via: "estimatedSalePrice parameter"
      pattern: "estimatedSalePrice"
    - from: "src/lib/calculations/evaluate-all.ts"
      to: "ComparisonData"
      via: "hasMarketValue and equity fields"
      pattern: "hasMarketValue|equity"
---

<objective>
Update the evaluation orchestrator to accept a real market value (instead of using residualValue as placeholder) and handle missing market value gracefully by marking equity-dependent scenarios as incomplete.

Purpose: This is the critical calculation logic change that makes market value meaningful. Without this, entering a market value has no effect on comparisons.
Output: Updated evaluateAllScenarios and getComparisonData with market value parameter, incomplete scenario handling, and equity information. TDD with full test coverage.
</objective>

<execution_context>
@/Users/brandonharvey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brandonharvey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/04-market-value-and-valuation/04-CONTEXT.md
@src/lib/calculations/evaluate-all.ts
@src/lib/types/scenario.ts
@src/lib/calculations/scenarios/sell-privately.ts
@src/lib/calculations/scenarios/buyout.ts
@src/lib/calculations/equity.ts
@src/lib/decimal.ts
</context>

<feature>
  <name>Market value integration in evaluation orchestrator</name>
  <files>
    src/lib/calculations/evaluate-all.ts
    src/lib/types/scenario.ts
    src/__tests__/lib/calculations/evaluate-all.test.ts
  </files>
  <behavior>
    **ScenarioResult type update:**
    - Add optional `incomplete?: boolean` field to ScenarioResult interface
    - When incomplete=true, the scenario is shown but cannot be ranked as "best option"

    **evaluateAllScenarios changes:**
    - Add optional `estimatedSalePrice?: Decimal` parameter (separate from lease)
    - When `estimatedSalePrice` is provided:
      - Pass it to evaluateSellPrivatelyScenario (replaces residualValue placeholder)
      - Scenarios proceed normally
    - When `estimatedSalePrice` is null/undefined:
      - Sell-privately scenario result gets `incomplete: true` flag
      - Add a warning: "Add your vehicle's market value for accurate sell-privately results"
      - Still evaluate with residualValue as a conservative placeholder (so the scenario shows up, but marked incomplete)
    - Sorting: incomplete scenarios sort LAST regardless of netCost

    **getComparisonData changes:**
    - Add optional `estimatedSalePrice?: Decimal` parameter, pass through to evaluateAllScenarios
    - Add to ComparisonData interface:
      - `hasMarketValue: boolean`
      - `equity?: { amount: Decimal; isPositive: boolean }` (only when market value provided)
    - When computing equity: equity = estimatedSalePrice - buyoutResult.totalCost
    - Best option: skip incomplete scenarios when picking bestOption
    - savingsVsReturn: use only complete scenarios for comparison

    **Test cases (RED phase):**
    1. With market value provided: sell-privately uses provided price, not residualValue
    2. Without market value: sell-privately has `incomplete: true`
    3. Without market value: incomplete scenarios sort last
    4. Without market value: bestOption is not an incomplete scenario
    5. With market value: equity is calculated correctly (positive case)
    6. With market value: equity is calculated correctly (negative case)
    7. ComparisonData.hasMarketValue reflects whether value was provided
  </behavior>
  <implementation>
    **RED:** Write failing tests first covering all 7 cases above. Use a mock lease object with known values.

    **GREEN:** Implement the changes:
    1. Add `incomplete?: boolean` to ScenarioResult in scenario.ts
    2. Update evaluateAllScenarios signature to accept `estimatedSalePrice?: Decimal`
    3. When estimatedSalePrice is undefined, mark sell-privately as incomplete and add warning
    4. Update sort: incomplete scenarios sort after complete ones (use a comparator that checks incomplete first, then netCost)
    5. Update getComparisonData to accept estimatedSalePrice, compute equity, set hasMarketValue
    6. bestOption = first non-incomplete scenario from sorted list

    **REFACTOR:** Clean up any duplication between the with/without market value code paths. Ensure the existing comment "Phase 4 will add market value entry" is removed and replaced with the real logic.
  </implementation>
</feature>

<verification>
- `npm test -- --run src/__tests__/lib/calculations/evaluate-all.test.ts` passes all cases
- `npx tsc --noEmit` passes
- Existing tests in other calculation files still pass
- Coverage on evaluate-all.ts remains at 100%
</verification>

<success_criteria>
- evaluateAllScenarios accepts optional estimatedSalePrice
- Missing market value marks sell-privately as incomplete
- Incomplete scenarios sort last and are excluded from bestOption
- ComparisonData includes hasMarketValue and equity fields
- All test cases pass with correct assertions
</success_criteria>

<output>
After completion, create `.planning/phases/04-market-value-and-valuation/04-02-SUMMARY.md`
</output>
