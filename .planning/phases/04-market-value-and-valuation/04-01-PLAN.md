---
phase: 04-market-value-and-valuation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/db/schema.ts
  - src/lib/validations/market-value-schema.ts
  - src/lib/services/valuation/provider.ts
  - src/lib/services/valuation/manual-provider.ts
  - src/lib/services/valuation/index.ts
  - src/lib/utils/staleness.ts

autonomous: true

must_haves:
  truths:
    - "market_values table exists in Drizzle schema with leaseId FK, value (Decimal), source, sourceLabel, timestamps"
    - "ValuationProvider interface defines getMarketValue method with standard params"
    - "ManualValuationProvider implements the interface"
    - "Zod schema validates market value input with positive number, source enum, optional sourceLabel"
    - "Staleness utility detects values older than 30 days and returns relative time string"
  artifacts:
    - path: "src/lib/db/schema.ts"
      provides: "marketValues table definition with relations"
      contains: "marketValues"
    - path: "src/lib/services/valuation/provider.ts"
      provides: "ValuationProvider interface and ValuationResult type"
      exports: ["ValuationProvider", "ValuationResult"]
    - path: "src/lib/services/valuation/manual-provider.ts"
      provides: "ManualValuationProvider class"
      exports: ["ManualValuationProvider"]
    - path: "src/lib/services/valuation/index.ts"
      provides: "Barrel export for valuation services"
    - path: "src/lib/validations/market-value-schema.ts"
      provides: "Zod schema for market value form"
      exports: ["marketValueSchema", "MarketValueFormData"]
    - path: "src/lib/utils/staleness.ts"
      provides: "checkValueStaleness utility"
      exports: ["checkValueStaleness"]
  key_links:
    - from: "src/lib/db/schema.ts"
      to: "leases table"
      via: "foreign key reference"
      pattern: "references.*leases\\.id"
    - from: "src/lib/services/valuation/manual-provider.ts"
      to: "src/lib/services/valuation/provider.ts"
      via: "implements interface"
      pattern: "implements ValuationProvider"
---

<objective>
Create the data layer for market value tracking: database schema, provider interface for future extensibility, validation schema, and staleness detection utility.

Purpose: Establishes the foundation that all other Phase 4 plans build on -- the table, types, validation, and provider abstraction.
Output: Drizzle schema with market_values table, ValuationProvider interface + ManualValuationProvider, Zod validation schema, staleness utility. Migration generated.
</objective>

<execution_context>
@/Users/brandonharvey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brandonharvey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-market-value-and-valuation/04-CONTEXT.md
@.planning/phases/04-market-value-and-valuation/04-RESEARCH.md
@src/lib/db/schema.ts
@src/lib/db/custom-types.ts
@src/lib/db/client.ts
@src/lib/validations/lease-schema.ts
@src/lib/decimal.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database schema and provider interface</name>
  <files>
    src/lib/db/schema.ts
    src/lib/services/valuation/provider.ts
    src/lib/services/valuation/manual-provider.ts
    src/lib/services/valuation/index.ts
  </files>
  <action>
    **1. Add market_values table to schema.ts:**

    Add a `marketValues` pgTable to the existing `src/lib/db/schema.ts` file (append, don't replace existing leases table). Use the existing `decimalNumber` custom type for the value field.

    ```typescript
    export const marketValues = pgTable('market_values', {
      id: uuid('id').primaryKey().defaultRandom(),
      leaseId: uuid('lease_id').notNull().references(() => leases.id, { onDelete: 'cascade' }),
      value: decimalNumber('value', { precision: 10, scale: 2 }).notNull(),
      source: varchar('source', { length: 50 }).notNull(), // 'manual', 'kbb', 'edmunds', 'carvana'
      sourceLabel: varchar('source_label', { length: 100 }),
      sourceMetadata: text('source_metadata'), // JSON for future API data
      createdAt: timestamp('created_at', { mode: 'date', precision: 3 }).notNull().defaultNow(),
      updatedAt: timestamp('updated_at', { mode: 'date', precision: 3 })
        .notNull()
        .defaultNow()
        .$onUpdate(() => new Date()),
    });
    ```

    Add imports for `text` and `relations` from drizzle-orm. Add Drizzle relations:

    ```typescript
    import { relations } from 'drizzle-orm';

    export const leasesRelations = relations(leases, ({ many }) => ({
      marketValues: many(marketValues),
    }));

    export const marketValuesRelations = relations(marketValues, ({ one }) => ({
      lease: one(leases, {
        fields: [marketValues.leaseId],
        references: [leases.id],
      }),
    }));
    ```

    Export types: `MarketValue` (inferSelect) and `NewMarketValue` (inferInsert).

    **2. Create ValuationProvider interface:**

    Create `src/lib/services/valuation/provider.ts`:
    - Import Decimal from `@/lib/decimal`
    - Define `ValuationResult` interface: `{ value: Decimal; source: string; sourceLabel: string; confidence?: 'high' | 'medium' | 'low'; metadata?: Record<string, unknown> }`
    - Define `ValuationProvider` interface: `{ readonly name: string; getMarketValue(params: { make?: string; model?: string; year?: number; mileage: number; zipCode?: string }): Promise<ValuationResult | null> }`

    **3. Create ManualValuationProvider:**

    Create `src/lib/services/valuation/manual-provider.ts`:
    - Implements `ValuationProvider` with `name = 'manual'`
    - `getMarketValue()` returns `null` (manual doesn't auto-fetch)
    - Add `createManualEntry(value: number): ValuationResult` method that wraps a number into a ValuationResult with source='manual' and sourceLabel='Your estimate'
    - Use `new Decimal(value.toString())` for value conversion

    **4. Create barrel export:**

    Create `src/lib/services/valuation/index.ts` exporting all public types and classes:
    - `ValuationResult`, `ValuationProvider` from provider.ts
    - `ManualValuationProvider` from manual-provider.ts
    - `getValuationProvider(source: string): ValuationProvider` factory function (switch on source, default to ManualValuationProvider)

    **5. Generate migration:**

    Run `npx drizzle-kit generate` to create the migration for the new market_values table. Do NOT run `npx drizzle-kit migrate` (DB migration is handled separately).
  </action>
  <verify>
    - `npx tsc --noEmit` passes (type checks)
    - `npx drizzle-kit generate` succeeds and creates a migration file in drizzle/migrations/
    - Verify schema.ts exports: `MarketValue`, `NewMarketValue`, `marketValues`, `leasesRelations`, `marketValuesRelations`
    - Verify provider.ts exports: `ValuationProvider`, `ValuationResult`
    - Verify manual-provider.ts: `ManualValuationProvider` class implements `ValuationProvider`
  </verify>
  <done>
    - market_values table schema exists with all fields (id, leaseId, value, source, sourceLabel, sourceMetadata, timestamps)
    - Foreign key cascade delete from leases
    - Drizzle relations defined for one-to-many leases→marketValues
    - ValuationProvider interface and ManualValuationProvider class exist
    - Migration SQL generated
  </done>
</task>

<task type="auto">
  <name>Task 2: Validation schema and staleness utility</name>
  <files>
    src/lib/validations/market-value-schema.ts
    src/lib/utils/staleness.ts
  </files>
  <action>
    **1. Create market value Zod schema:**

    Create `src/lib/validations/market-value-schema.ts` following the pattern in `lease-schema.ts`:

    ```typescript
    import { z } from 'zod';

    export const marketValueSchema = z.object({
      value: z.coerce
        .number()
        .positive({ message: 'Market value must be a positive number' })
        .max(500000, { message: 'Market value seems unusually high. Please verify.' }),
      source: z.enum(['manual', 'kbb', 'edmunds', 'carvana']).default('manual'),
      sourceLabel: z.string()
        .max(100, { message: 'Source label must be 100 characters or less' })
        .optional(),
    });

    export type MarketValueFormData = z.infer<typeof marketValueSchema>;
    ```

    Use `z.coerce` for the value field (consistent with [02-01] decision). Max of 500,000 is reasonable for vehicle values.

    **2. Create staleness detection utility:**

    Create `src/lib/utils/staleness.ts`:

    ```typescript
    const STALE_THRESHOLD_DAYS = 30;

    export function checkValueStaleness(updatedAt: Date): {
      isStale: boolean;
      message: string;
      relativeTime: string;
      daysSinceUpdate: number;
    } {
      const now = new Date();
      const diffMs = now.getTime() - updatedAt.getTime();
      const daysSinceUpdate = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      const isStale = daysSinceUpdate > STALE_THRESHOLD_DAYS;

      return {
        isStale,
        daysSinceUpdate,
        message: isStale
          ? 'Your market value may be outdated — consider updating'
          : '',
        relativeTime: formatRelativeTime(daysSinceUpdate),
      };
    }
    ```

    Implement `formatRelativeTime(days: number): string` using native logic (no date-fns needed for this simple case):
    - 0 days → "today"
    - 1 day → "yesterday"
    - 2-6 days → "X days ago"
    - 7-13 days → "1 week ago"
    - 14-29 days → "X weeks ago"
    - 30-59 days → "1 month ago"
    - 60+ days → "X months ago"

    This avoids adding date-fns as a dependency for a simple relative time calculation.

    Export `STALE_THRESHOLD_DAYS` as a named constant for tests.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Manually verify the Zod schema: `marketValueSchema.parse({ value: '25000' })` should succeed
    - Verify staleness function: `checkValueStaleness(new Date())` returns `{ isStale: false, relativeTime: 'today' }`
    - Verify staleness function: `checkValueStaleness(new Date(Date.now() - 31 * 86400000))` returns `{ isStale: true }`
  </verify>
  <done>
    - Zod schema validates market value input (positive number, source enum, optional label)
    - Staleness utility returns isStale=true for values older than 30 days
    - Relative time formatting works without external dependencies
    - Both files export their types correctly
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes for all new and modified files
- Migration file exists in drizzle/migrations/
- All exports resolve correctly (no circular dependencies)
- Provider interface is generic enough for future KBB/Edmunds integration
</verification>

<success_criteria>
- market_values table defined in Drizzle schema with proper types and relations
- ValuationProvider interface + ManualValuationProvider implementation exist
- Zod validation schema for market value input
- Staleness utility detects 30-day threshold
- Migration generated (not applied)
</success_criteria>

<output>
After completion, create `.planning/phases/04-market-value-and-valuation/04-01-SUMMARY.md`
</output>
