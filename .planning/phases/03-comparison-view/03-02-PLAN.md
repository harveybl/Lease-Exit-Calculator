---
phase: 03-comparison-view
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/comparison/HeroSummary.tsx
  - src/components/comparison/LineItemsBreakdown.tsx
  - src/components/comparison/OptionCard.tsx
  - src/components/comparison/OptionsList.tsx
  - src/components/comparison/ComparisonView.tsx
autonomous: true

must_haves:
  truths:
    - "Hero card displays best option name, its net cost, and savings vs. returning"
    - "All five options appear in a ranked vertical list ordered by net cost ascending"
    - "Each option row shows rank badge, option name, and net cost before expanding"
    - "Expanding an option reveals grouped line items with category headers"
    - "Positive amounts (credits/equity) display with green color AND descriptive text label"
    - "Mini option totals row in hero card shows all five option costs for quick comparison"
    - "Tie note appears when top two options are within $100"
  artifacts:
    - path: "src/components/comparison/HeroSummary.tsx"
      provides: "Top snapshot card with best option, savings, caveat, tie note, and mini totals"
      exports: ["HeroSummary"]
    - path: "src/components/comparison/LineItemsBreakdown.tsx"
      provides: "Grouped cost breakdown with category headers, educational tooltips, and totals/credits/net summary"
      exports: ["LineItemsBreakdown"]
    - path: "src/components/comparison/OptionCard.tsx"
      provides: "Single option row with rank badge, collapsible cost breakdown"
      exports: ["OptionCard"]
    - path: "src/components/comparison/OptionsList.tsx"
      provides: "Ranked vertical list of all five OptionCards"
      exports: ["OptionsList"]
    - path: "src/components/comparison/ComparisonView.tsx"
      provides: "Page-level orchestrator composing HeroSummary + OptionsList"
      exports: ["ComparisonView"]
  key_links:
    - from: "src/components/comparison/ComparisonView.tsx"
      to: "src/components/comparison/HeroSummary.tsx"
      via: "renders HeroSummary with ComparisonData"
      pattern: "import.*HeroSummary"
    - from: "src/components/comparison/ComparisonView.tsx"
      to: "src/components/comparison/OptionsList.tsx"
      via: "renders OptionsList with sorted scenarios"
      pattern: "import.*OptionsList"
    - from: "src/components/comparison/OptionCard.tsx"
      to: "src/components/ui/collapsible.tsx"
      via: "uses Collapsible for expand/collapse (NOT Accordion)"
      pattern: "import.*Collapsible"
    - from: "src/components/comparison/LineItemsBreakdown.tsx"
      to: "src/lib/utils/format-currency.ts"
      via: "formats all Decimal amounts for display"
      pattern: "import.*formatCurrency"
---

<objective>
Build the five React components that compose the comparison view: a hero summary card, a ranked options list, individual option cards with collapsible breakdowns, and a line-items breakdown with grouped categories.

Purpose: These components translate the calculated scenario data into the visual comparison interface that is the product's core value proposition.
Output: Five components in src/components/comparison/ that accept ComparisonData and render the full comparison view.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-comparison-view/03-CONTEXT.md
@.planning/phases/03-comparison-view/03-RESEARCH.md
@.planning/phases/03-comparison-view/03-01-SUMMARY.md
@src/lib/types/scenario.ts
@src/lib/types/calculation.ts
@src/lib/calculations/evaluate-all.ts
@src/lib/utils/format-currency.ts
@src/components/ui/card.tsx
@src/components/ui/collapsible.tsx
@src/components/ui/badge.tsx
@src/components/ui/popover.tsx
@src/components/ui/button.tsx
@src/lib/utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LineItemsBreakdown and OptionCard components</name>
  <files>
    src/components/comparison/LineItemsBreakdown.tsx
    src/components/comparison/OptionCard.tsx
  </files>
  <action>
    **LineItemsBreakdown.tsx:**

    Create a component that accepts `{ lineItems: LineItem[] }` from `@/lib/types/calculation`.

    1. Group line items by their `type` field ('liability', 'fee', 'tax', 'asset', or undefined as 'other'). Use `reduce` to group into `Record<string, LineItem[]>`.

    2. Define category labels map:
       - `liability` -> "Lease Costs"
       - `fee` -> "Fees"
       - `tax` -> "Taxes"
       - `asset` -> "Credits & Equity"
       - `other` -> "Other"

    3. Define display order: `['liability', 'fee', 'tax', 'asset', 'other']`. Render categories in this order. Skip empty categories.

    4. For each category, render:
       - Category heading: `<h4>` with `text-sm font-semibold text-muted-foreground uppercase tracking-wide mb-2`
       - Each line item as a flex row (justify-between) showing:
         - Left: item label + a Popover tooltip trigger (small info icon from lucide-react `Info` icon, size 14) that shows `item.description` on click. Use the same Popover component pattern from Phase 2.
         - Right: formatted amount using `formatCurrency(item.amount)`. If category is 'asset', add `text-green-600 dark:text-green-400` AND prefix the amount with "You receive: " to meet accessibility requirement (don't rely on color alone).

    5. After all categories, render a summary section separated by a border-top:
       - "Total costs: $X" -- sum of all non-asset line items
       - "Total credits: $Y" -- sum of all asset line items (only show if > 0)
       - "Net: $Z" -- bold, larger text. This is the scenario's netCost (pass as a separate prop).

    Use `formatCurrency` from `@/lib/utils/format-currency`. Use `cn` from `@/lib/utils` for conditional classes.

    **OptionCard.tsx:**

    Create a component that accepts `{ scenario: ScenarioResult; rank: number; isFirst: boolean }`.

    1. Use `Card` from `@/components/ui/card` as the container.
    2. If `isFirst` (rank 1), add a visual distinction: `border-primary border-2` on the Card (accent border for the best option).
    3. `CardHeader` contains a flex row:
       - Left side: `Badge` component showing `#{rank}`. For rank 1, use `variant="default"` (filled). For all others, use `variant="outline"`.
       - Next to badge: `CardTitle` with `formatOptionName(scenario.type)` from `@/lib/utils/format-currency`.
       - Right side: Net cost in large font `text-xl font-bold` using `formatCurrency(scenario.netCost)`.
    4. Below the header, add a `Collapsible` (NOT Accordion) for the cost breakdown:
       - `CollapsibleTrigger` wraps a `Button variant="ghost"` with full width, showing "View cost breakdown" text and a `ChevronDown` icon from lucide-react that rotates 180deg when open (use `cn("transition-transform duration-200", open && "rotate-180")`).
       - `CollapsibleContent` contains `<CardContent>` wrapping `<LineItemsBreakdown lineItems={scenario.lineItems} netCost={scenario.netCost} />`.
    5. If `scenario.warnings.length > 0`, show warnings below the breakdown in a muted box: `bg-amber-50 dark:bg-amber-950 border border-amber-200 dark:border-amber-800 rounded-md p-3`. Each warning as a `<p>` with `text-sm text-amber-800 dark:text-amber-200`.
    6. Use `useState` for the Collapsible open state (controlled mode).

    Mark component as `"use client"` since it uses useState.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Both files export their named components
    - OptionCard.tsx contains "use client" directive
    - OptionCard.tsx imports from Collapsible (not Accordion)
  </verify>
  <done>
    LineItemsBreakdown groups line items by category with headers, shows credits in green with "You receive:" label, and displays total costs / total credits / net summary. OptionCard shows rank badge + name + net cost with a Collapsible breakdown using independent expand/collapse (not Accordion).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create HeroSummary, OptionsList, and ComparisonView components</name>
  <files>
    src/components/comparison/HeroSummary.tsx
    src/components/comparison/OptionsList.tsx
    src/components/comparison/ComparisonView.tsx
  </files>
  <action>
    **HeroSummary.tsx:**

    Create a component accepting `ComparisonData` from `@/lib/calculations/evaluate-all`.

    1. Use `Card` with `border-2 border-primary` for visual emphasis. Add `mb-6 md:mb-8` for spacing below.
    2. `CardHeader`:
       - `CardTitle` with `text-xl md:text-2xl font-bold`: Show "Best Move: {formatOptionName(bestOption.type)}"
       - `CardDescription` with direct financial tone:
         - If `bestOption.type === 'return'`: "Returning is your best option right now"
         - If `savingsVsReturn` > 0: "{formatOptionName(bestOption.type)} saves {formatCurrency(savingsVsReturn)} vs. returning"
         - If `savingsVsReturn` <= 0 and `bestOption.type !== 'return'`: "{formatOptionName(bestOption.type)} costs {formatCurrency(savingsVsReturn.abs())} more than returning"
    3. If `tie.isTie`, show a tie note below the description: a muted box (`bg-muted p-3 rounded-md text-sm text-muted-foreground mt-2`) with text: "{formatOptionName(tiedOptions[0])} and {formatOptionName(tiedOptions[1])} are within $100 -- either is a strong choice"
    4. Add a brief practical caveat in the hero card when the best option is sell-privately: `text-sm text-muted-foreground mt-1` saying "Requires finding a buyer". For early-termination: "Contact your leasing company for exact payoff". Otherwise, no caveat.
    5. `CardContent`: Mini option totals row. Use a responsive grid: `grid grid-cols-2 gap-3 sm:grid-cols-3 md:flex md:justify-between`. Each option shows:
       - Small label: `text-xs text-muted-foreground mb-1` with `formatOptionName(opt.type)`
       - Value: `font-semibold text-sm md:text-base` with `formatCurrency(opt.netCost)`
       - For the best option, add `text-primary font-bold` to distinguish it in the mini totals

    **OptionsList.tsx:**

    Create a component accepting `{ scenarios: ScenarioResult[] }` (already sorted ascending by netCost).

    1. Render a `div` with `space-y-4 md:space-y-6` containing one `OptionCard` per scenario.
    2. Pass `rank={index + 1}` and `isFirst={index === 0}` to each OptionCard.
    3. Map over scenarios maintaining sort order (do NOT re-sort here).

    This is a simple server component (no "use client" needed -- it just composes OptionCards).

    **ComparisonView.tsx:**

    Create a page-level orchestrator accepting `{ data: ComparisonData }`.

    1. Renders a container `div` with `max-w-4xl mx-auto px-4 py-8`.
    2. First child: `<HeroSummary>` with the full ComparisonData.
    3. Second child: `<OptionsList scenarios={data.scenarios} />`.
    4. Third child: A disclaimers section at the bottom. Collect unique disclaimers from all scenarios (deduplicate). Render in a `border-t mt-8 pt-6` section with `text-xs text-muted-foreground space-y-2`. Each disclaimer as a `<p>`.
    5. This is a server component (no "use client" -- it just composes children).
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - All three files export their named components
    - ComparisonView.tsx does NOT have "use client" (server component)
    - HeroSummary.tsx imports ComparisonData from evaluate-all.ts
  </verify>
  <done>
    HeroSummary shows best option with savings text, tie note, caveat, and mini totals row. OptionsList renders the ranked vertical list. ComparisonView orchestrates both plus a deduplicated disclaimers section. The comparison view is fully composable and ready to be wired into a page route.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- all five component files type-check
2. `ls src/components/comparison/{HeroSummary,LineItemsBreakdown,OptionCard,OptionsList,ComparisonView}.tsx` -- all five files exist
3. Grep for "Accordion" in src/components/comparison/ -- should return 0 results (Collapsible used instead)
4. Grep for "use client" in OptionCard.tsx -- present (client component with useState)
5. Grep for "use client" in ComparisonView.tsx -- absent (server component)
6. Grep for "You receive" in LineItemsBreakdown.tsx -- accessibility label paired with green color
7. Grep for "formatCurrency" in all comparison components -- currency formatting used consistently
</verification>

<success_criteria>
- Five components render the complete comparison view when given ComparisonData
- Hero card shows best option, savings vs. return, optional tie note, optional caveat, and mini totals
- Ranked list shows all five options with rank badges, names, and net costs
- Each option expands independently (Collapsible, not Accordion) to show grouped line items
- Line items grouped by category (Lease Costs, Fees, Taxes, Credits & Equity) with clear headers
- Green text for credits always accompanied by "You receive:" text label (accessibility)
- Each breakdown shows total costs, total credits, and net at the bottom
- Mobile-first responsive layout (unprefixed = mobile, md:/lg: = larger)
</success_criteria>

<output>
After completion, create `.planning/phases/03-comparison-view/03-02-SUMMARY.md`
</output>
