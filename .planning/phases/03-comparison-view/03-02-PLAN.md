---
phase: 03-comparison-view
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/comparison/LineItemsBreakdown.tsx
  - src/components/comparison/OptionCard.tsx
autonomous: true

must_haves:
  truths:
    - "Each option row shows rank badge, option name, and net cost before expanding"
    - "Expanding an option reveals grouped line items with category headers"
    - "Positive amounts (credits/equity) display with green color AND descriptive text label"
  artifacts:
    - path: "src/components/comparison/LineItemsBreakdown.tsx"
      provides: "Grouped cost breakdown with category headers, educational tooltips, and totals/credits/net summary"
      exports: ["LineItemsBreakdown"]
    - path: "src/components/comparison/OptionCard.tsx"
      provides: "Single option row with rank badge, collapsible cost breakdown"
      exports: ["OptionCard"]
  key_links:
    - from: "src/components/comparison/OptionCard.tsx"
      to: "src/components/ui/collapsible.tsx"
      via: "uses Collapsible for expand/collapse (NOT Accordion)"
      pattern: "import.*Collapsible"
    - from: "src/components/comparison/LineItemsBreakdown.tsx"
      to: "src/lib/utils/format-currency.ts"
      via: "formats all Decimal amounts for display"
      pattern: "import.*formatCurrency"
    - from: "src/components/comparison/LineItemsBreakdown.tsx"
      to: "src/components/ui/popover.tsx"
      via: "uses Popover for educational tooltips on line items (installed in Phase 2)"
      pattern: "import.*Popover"
---

<objective>
Build the two leaf-level React components for the comparison view: a line-items breakdown with grouped categories and educational tooltips, and an option card with rank badge and collapsible cost details.

Purpose: These foundation components are the building blocks that orchestrator components (HeroSummary, OptionsList, ComparisonView) will compose into the full comparison page.
Output: Two components in src/components/comparison/ â€” LineItemsBreakdown and OptionCard.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-comparison-view/03-CONTEXT.md
@.planning/phases/03-comparison-view/03-RESEARCH.md
@.planning/phases/03-comparison-view/03-01-SUMMARY.md
@src/lib/types/scenario.ts
@src/lib/types/calculation.ts
@src/lib/calculations/evaluate-all.ts
@src/lib/utils/format-currency.ts
@src/components/ui/card.tsx
@src/components/ui/collapsible.tsx
@src/components/ui/badge.tsx
@src/components/ui/popover.tsx
@src/components/ui/button.tsx
@src/lib/utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LineItemsBreakdown component</name>
  <files>
    src/components/comparison/LineItemsBreakdown.tsx
  </files>
  <action>
    Create a component that accepts `{ lineItems: LineItem[], netCost: Decimal }` where `LineItem` is from `@/lib/types/calculation` and `Decimal` from `@/lib/decimal`.

    1. Group line items by their `type` field ('liability', 'fee', 'tax', 'asset', or undefined as 'other'). Use `reduce` to group into `Record<string, LineItem[]>`.

    2. Define category labels map:
       - `liability` -> "Lease Costs"
       - `fee` -> "Fees"
       - `tax` -> "Taxes"
       - `asset` -> "Credits & Equity"
       - `other` -> "Other"

    3. Define display order: `['liability', 'fee', 'tax', 'asset', 'other']`. Render categories in this order. Skip empty categories.

    4. For each category, render:
       - Category heading: `<h4>` with `text-sm font-semibold text-muted-foreground uppercase tracking-wide mb-2`
       - Each line item as a flex row (justify-between) showing:
         - Left: item label + a Popover tooltip trigger (small info icon from lucide-react `Info` icon, size 14) that shows `item.description` on click. Use the Popover component from `@/components/ui/popover` (already installed in Phase 2, see 02-01-SUMMARY.md -- no additional installation needed).
         - Right: formatted amount using `formatCurrency(item.amount)`. If category is 'asset', add `text-green-600 dark:text-green-400` AND prefix the amount with "You receive: " to meet accessibility requirement (don't rely on color alone).

    5. After all categories, render a summary section separated by a border-top:
       - "Total costs: $X" -- sum of all non-asset line items
       - "Total credits: $Y" -- sum of all asset line items (only show if > 0)
       - "Net: $Z" -- bold, larger text. This is the scenario's netCost (pass as a separate prop).

    Use `formatCurrency` from `@/lib/utils/format-currency`. Use `cn` from `@/lib/utils` for conditional classes.

    Mark as `"use client"` since Popover interactions require client-side rendering.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `grep -q 'export.*LineItemsBreakdown' src/components/comparison/LineItemsBreakdown.tsx` confirms export
    - Grep for "You receive" in LineItemsBreakdown.tsx -- accessibility label paired with green color
    - Grep for "Popover" in LineItemsBreakdown.tsx -- uses Popover for tooltips
  </verify>
  <done>
    LineItemsBreakdown groups line items by category with headers, shows credits in green with "You receive:" label, uses Popover for educational tooltips, and displays total costs / total credits / net summary.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create OptionCard component</name>
  <files>
    src/components/comparison/OptionCard.tsx
  </files>
  <action>
    Create a component that accepts `{ scenario: ScenarioResult; rank: number; isFirst: boolean }`.

    1. Use `Card` from `@/components/ui/card` as the container.
    2. If `isFirst` (rank 1), add a visual distinction: `border-primary border-2` on the Card (accent border for the best option).
    3. `CardHeader` contains a flex row:
       - Left side: `Badge` component showing `#{rank}`. For rank 1, use `variant="default"` (filled). For all others, use `variant="outline"`.
       - Next to badge: `CardTitle` with `formatOptionName(scenario.type)` from `@/lib/utils/format-currency`.
       - Right side: Net cost in large font `text-xl font-bold` using `formatCurrency(scenario.netCost)`.
    4. Below the header, add a `Collapsible` (NOT Accordion) for the cost breakdown:
       - `CollapsibleTrigger` wraps a `Button variant="ghost"` with full width, showing "View cost breakdown" text and a `ChevronDown` icon from lucide-react that rotates 180deg when open (use `cn("transition-transform duration-200", open && "rotate-180")`).
       - `CollapsibleContent` contains `<CardContent>` wrapping `<LineItemsBreakdown lineItems={scenario.lineItems} netCost={scenario.netCost} />`.
    5. If `scenario.warnings.length > 0`, show warnings below the breakdown in a muted box: `bg-amber-50 dark:bg-amber-950 border border-amber-200 dark:border-amber-800 rounded-md p-3`. Each warning as a `<p>` with `text-sm text-amber-800 dark:text-amber-200`.
    6. Use `useState` for the Collapsible open state (controlled mode).

    Mark component as `"use client"` since it uses useState.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `grep -q 'export.*OptionCard' src/components/comparison/OptionCard.tsx` confirms export
    - OptionCard.tsx contains "use client" directive
    - OptionCard.tsx imports from Collapsible (not Accordion)
  </verify>
  <done>
    OptionCard shows rank badge + name + net cost with a Collapsible breakdown using independent expand/collapse (not Accordion). Best option has accent border. Warnings display in amber box.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- both component files type-check
2. `ls src/components/comparison/{LineItemsBreakdown,OptionCard}.tsx` -- both files exist
3. Grep for "Accordion" in src/components/comparison/ -- should return 0 results (Collapsible used instead)
4. Grep for "use client" in OptionCard.tsx -- present (client component with useState)
5. Grep for "You receive" in LineItemsBreakdown.tsx -- accessibility label paired with green color
6. Grep for "formatCurrency" in both comparison components -- currency formatting used consistently
</verification>

<success_criteria>
- LineItemsBreakdown groups line items by category with clear headers and educational tooltips
- OptionCard shows rank badge, option name, net cost, and collapsible breakdown
- Each option expands independently (Collapsible, not Accordion)
- Green text for credits always accompanied by "You receive:" text label (accessibility)
- Each breakdown shows total costs, total credits, and net at the bottom
</success_criteria>

<output>
After completion, create `.planning/phases/03-comparison-view/03-02-SUMMARY.md`
</output>
