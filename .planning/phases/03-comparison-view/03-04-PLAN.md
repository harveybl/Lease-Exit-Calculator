---
phase: 03-comparison-view
plan: 04
type: execute
wave: 4
depends_on: ["03-03"]
files_modified:
  - src/app/lease/[id]/compare/page.tsx
  - src/app/lease/[id]/compare/loading.tsx
  - src/components/lease/LeaseCard.tsx
autonomous: false

must_haves:
  truths:
    - "Navigating to /lease/[id]/compare loads the lease from the database and displays the full comparison view"
    - "LeaseCard on the lease list page has a link or button to navigate to the comparison view"
    - "A loading skeleton appears while the comparison page fetches data"
    - "If the lease ID is invalid or not found, the page shows a meaningful error state"
  artifacts:
    - path: "src/app/lease/[id]/compare/page.tsx"
      provides: "Server component page that fetches lease and renders ComparisonView"
      exports: ["default"]
    - path: "src/app/lease/[id]/compare/loading.tsx"
      provides: "Skeleton loading state with placeholder cards"
      exports: ["default"]
    - path: "src/components/lease/LeaseCard.tsx"
      provides: "Updated lease card with Compare link"
  key_links:
    - from: "src/app/lease/[id]/compare/page.tsx"
      to: "src/app/lease/actions.ts"
      via: "fetches lease using getLease(id)"
      pattern: "getLease"
    - from: "src/app/lease/[id]/compare/page.tsx"
      to: "src/lib/calculations/evaluate-all.ts"
      via: "calls getComparisonData(lease) to run all scenarios"
      pattern: "getComparisonData"
    - from: "src/app/lease/[id]/compare/page.tsx"
      to: "src/components/comparison/ComparisonView.tsx"
      via: "renders ComparisonView with comparison data"
      pattern: "import.*ComparisonView"
    - from: "src/components/lease/LeaseCard.tsx"
      to: "/lease/[id]/compare"
      via: "Link component navigating to comparison route"
      pattern: "compare"
---

<objective>
Wire the comparison view into the Next.js routing system: create the comparison page route that fetches a lease and renders the full comparison, add a loading skeleton, and update LeaseCard with navigation to the comparison view.

Purpose: This completes the data-to-UI pipeline. Users can navigate from their lease list to a comparison view showing all five options ranked with cost breakdowns.
Output: Working /lease/[id]/compare route with loading state, and a "Compare Options" link on each LeaseCard.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-comparison-view/03-CONTEXT.md
@.planning/phases/03-comparison-view/03-01-SUMMARY.md
@.planning/phases/03-comparison-view/03-02-SUMMARY.md
@.planning/phases/03-comparison-view/03-03-SUMMARY.md
@src/app/lease/actions.ts
@src/lib/calculations/evaluate-all.ts
@src/components/comparison/ComparisonView.tsx
@src/components/lease/LeaseCard.tsx
@src/components/ui/card.tsx
@src/components/ui/button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create comparison page route with loading state and LeaseCard navigation</name>
  <files>
    src/app/lease/[id]/compare/page.tsx
    src/app/lease/[id]/compare/loading.tsx
    src/components/lease/LeaseCard.tsx
  </files>
  <action>
    **src/app/lease/[id]/compare/page.tsx:**

    Create a Next.js server component page:

    1. Export metadata: `{ title: "Compare Options | Lease Tracker", description: "Side-by-side comparison of your lease exit options." }`

    2. Accept `params: Promise<{ id: string }>` (Next.js 16 dynamic route params are async).

    3. In the component body:
       - Await params: `const { id } = await params;`
       - Call `getLease(id)` from `@/app/lease/actions` to fetch the lease.
       - If lease is null, call `notFound()` from `next/navigation` to trigger the 404 page.
       - Call `getComparisonData(lease)` from `@/lib/calculations/evaluate-all` to compute all scenarios.
       - Render a page layout:
         - A back navigation link at top: `<Link href="/lease">` with a `ChevronLeft` icon and "Back to Leases" text, styled as muted text.
         - A page heading showing the lease name: `<h1>` with "{year} {make} {model}" if available, or "Lease Comparison" as fallback. Use `text-2xl md:text-3xl font-bold mb-6`.
         - `<ComparisonView data={comparisonData} />`

    4. This is a server component -- no "use client" directive.

    **src/app/lease/[id]/compare/loading.tsx:**

    Create a loading skeleton:

    1. Render the same container layout as the main page (`max-w-4xl mx-auto px-4 py-8`).
    2. A skeleton hero card: `Card` with `animate-pulse` containing:
       - Title placeholder: `div` with `h-8 bg-muted rounded w-64 mb-2`
       - Description placeholder: `div` with `h-5 bg-muted rounded w-96 mb-4`
       - Mini totals: 5 placeholder blocks in a flex row
    3. Five skeleton option cards below: each is a `Card` with `animate-pulse` containing:
       - Badge placeholder + title placeholder + cost placeholder in a row

    **src/components/lease/LeaseCard.tsx:**

    Read the existing LeaseCard component and ADD a "Compare Options" link/button. Do NOT rewrite the component -- add to it.

    Add a `Link` (from `next/link`) to `/lease/${lease.id}/compare` styled as a secondary button or prominent link. Use the `BarChart3` icon from lucide-react next to the text "Compare Options".

    Place it alongside any existing action buttons (edit, delete). If there's a flex row of actions, add it there. If not, add an appropriate action area.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `ls src/app/lease/\[id\]/compare/page.tsx src/app/lease/\[id\]/compare/loading.tsx` -- both exist
    - Grep for "getLease" in page.tsx -- fetches lease data
    - Grep for "getComparisonData" in page.tsx -- runs comparison engine
    - Grep for "compare" in LeaseCard.tsx -- navigation link present
    - Grep for "notFound" in page.tsx -- handles missing lease
  </verify>
  <done>
    /lease/[id]/compare route fetches the lease, runs all five scenario calculations, and renders ComparisonView. Loading skeleton shows during data fetch. LeaseCard has a "Compare Options" link. Invalid lease IDs trigger 404.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete comparison view for Phase 3 — hero summary card with best option and savings text, ranked vertical list of all five exit options, expandable cost breakdowns per option, and navigation from lease list.
  </what-built>
  <how-to-verify>
    1. Run `npm run dev` and open http://localhost:3000/lease
    2. Verify a "Compare Options" button/link appears on each lease card
    3. Click "Compare Options" on a lease — you should see the comparison page
    4. **Hero card (top):** Verify it shows:
       - Best option name (e.g., "Best Move: Sell Privately" or "Best Move: Return Vehicle")
       - Savings text (e.g., "Saves $X,XXX vs. returning")
       - Mini totals row showing all 5 option costs
    5. **Ranked list:** Verify all 5 options appear ranked best-to-worst:
       - Each shows rank badge (#1, #2, etc.), option name, and net cost
       - #1 option has visual emphasis (accent border or similar)
    6. **Expand a breakdown:** Click "View cost breakdown" on any option:
       - Verify line items are grouped by category (Lease Costs, Fees, Taxes, Credits & Equity)
       - Verify credits/equity items show green text with "You receive:" label
       - Verify bottom shows Total costs / Total credits / Net summary
    7. **Expand multiple:** Open 2+ breakdowns simultaneously (they should NOT collapse each other — Collapsible, not Accordion behavior)
    8. **Mobile:** Resize browser to phone width — verify layout remains usable (no horizontal scrolling)
    9. **Back navigation:** Click "Back to Leases" — returns to lease list
    10. **Loading state:** Hard refresh the comparison page — briefly see skeleton cards
  </how-to-verify>
  <resume-signal>Type "approved" or describe any visual/functional issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. Navigate to /lease/[id]/compare for a saved lease -- full comparison view renders
2. All five options visible with correct rank ordering (lowest netCost = #1)
3. Hero card shows best option, savings vs. return, and mini totals
4. Expanding multiple option breakdowns works simultaneously
5. Line items grouped by category with accessible color + text labels
6. Back navigation works
7. Loading skeleton appears during page load
8. Invalid lease ID shows 404 page
</verification>

<success_criteria>
- /lease/[id]/compare displays the complete comparison view for any saved lease
- LeaseCard has a visible "Compare Options" link
- Loading skeleton appears while data loads
- 404 page shown for invalid lease IDs
- User verifies visual quality and functional correctness at checkpoint
</success_criteria>

<output>
After completion, create `.planning/phases/03-comparison-view/03-04-SUMMARY.md`
</output>
