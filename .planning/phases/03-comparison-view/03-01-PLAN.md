---
phase: 03-comparison-view
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/utils/format-currency.ts
  - src/lib/calculations/evaluate-all.ts
  - src/components/ui/card.tsx
  - src/components/ui/collapsible.tsx
  - src/components/ui/badge.tsx
autonomous: true

must_haves:
  truths:
    - "formatCurrency converts Decimal to localized USD string with $ prefix and two decimal places"
    - "evaluateAllScenarios accepts a lease DB record and returns all five ScenarioResult objects sorted by netCost ascending"
    - "Tie detection identifies when top two options are within $100 of each other"
    - "shadcn Card, Collapsible, and Badge components are installed and importable"
  artifacts:
    - path: "src/lib/utils/format-currency.ts"
      provides: "Currency formatting utility wrapping Intl.NumberFormat"
      exports: ["formatCurrency"]
    - path: "src/lib/calculations/evaluate-all.ts"
      provides: "Orchestrator that runs all five scenario evaluators and returns sorted, ranked results"
      exports: ["evaluateAllScenarios", "checkForTie"]
    - path: "src/components/ui/card.tsx"
      provides: "shadcn Card component with CardHeader, CardTitle, CardContent, CardDescription, CardFooter"
    - path: "src/components/ui/collapsible.tsx"
      provides: "shadcn Collapsible component with CollapsibleTrigger, CollapsibleContent"
    - path: "src/components/ui/badge.tsx"
      provides: "shadcn Badge component with variant support"
  key_links:
    - from: "src/lib/calculations/evaluate-all.ts"
      to: "src/lib/calculations/scenarios/index.ts"
      via: "imports all five scenario evaluators"
      pattern: "import.*from.*scenarios"
    - from: "src/lib/calculations/evaluate-all.ts"
      to: "src/lib/types/scenario.ts"
      via: "uses ScenarioResult and ScenarioType types"
      pattern: "ScenarioResult"
    - from: "src/lib/utils/format-currency.ts"
      to: "src/lib/decimal.ts"
      via: "accepts Decimal type for conversion"
      pattern: "import.*Decimal.*from.*decimal"
---

<objective>
Create the data layer for the comparison view: a currency formatting utility, a scenario orchestration function that maps lease data to all five calculation engines and returns sorted results, and install the shadcn/ui components needed for the comparison UI.

Purpose: Downstream UI components need sorted scenario results and consistent currency formatting. This plan provides the data contract the UI consumes.
Output: format-currency.ts, evaluate-all.ts, three new shadcn UI components installed.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-comparison-view/03-CONTEXT.md
@.planning/phases/03-comparison-view/03-RESEARCH.md
@src/lib/types/scenario.ts
@src/lib/types/calculation.ts
@src/lib/types/lease.ts
@src/lib/calculations/scenarios/index.ts
@src/lib/calculations/scenarios/return.ts
@src/lib/calculations/scenarios/buyout.ts
@src/lib/calculations/scenarios/sell-privately.ts
@src/lib/calculations/scenarios/early-termination.ts
@src/lib/calculations/scenarios/extension.ts
@src/lib/db/schema.ts
@src/lib/decimal.ts
@src/lib/disclaimers.ts
@src/app/lease/actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install shadcn UI components and create currency formatter</name>
  <files>
    src/components/ui/card.tsx
    src/components/ui/collapsible.tsx
    src/components/ui/badge.tsx
    src/lib/utils/format-currency.ts
  </files>
  <action>
    Install three shadcn/ui components needed for the comparison view:
    ```bash
    npx shadcn@latest add card collapsible badge
    ```

    Then create `src/lib/utils/format-currency.ts`:

    Create a `formatCurrency` function that:
    1. Accepts a `Decimal` from `@/lib/decimal`
    2. Converts to `Number()` only at the display boundary
    3. Uses `new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2, maximumFractionDigits: 2 })` for formatting
    4. Returns a string like "$1,234.56"
    5. Reuse the same `Intl.NumberFormat` instance (module-level constant, not created per call)

    Also export a `formatOptionName` function that maps `ScenarioType` values to human-readable names:
    - 'return' -> 'Return Vehicle'
    - 'buyout' -> 'Buy Out Lease'
    - 'sell-privately' -> 'Sell Privately'
    - 'early-termination' -> 'Early Termination'
    - 'extension' -> 'Keep Paying (Extend)'

    Import `ScenarioType` from `@/lib/types/scenario`.
  </action>
  <verify>
    - `ls src/components/ui/card.tsx src/components/ui/collapsible.tsx src/components/ui/badge.tsx` all exist
    - `npx tsc --noEmit` passes (format-currency.ts type-checks)
  </verify>
  <done>
    Three shadcn components installed. formatCurrency converts Decimal to "$X,XXX.XX" string. formatOptionName maps all five ScenarioType values to display names.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create scenario orchestrator with sorted results and tie detection</name>
  <files>src/lib/calculations/evaluate-all.ts</files>
  <action>
    Create `src/lib/calculations/evaluate-all.ts` containing:

    **1. `evaluateAllScenarios` function:**

    Accepts a lease record matching the Drizzle `Lease` select type from `@/lib/db/schema.ts` (the type returned by `db.select().from(leases)`). This is `typeof leases.$inferSelect`.

    Maps the lease DB record to parameters for each of the five scenario evaluators. Handle nullable DB fields with sensible defaults:
    - `dispositionFee`: use `lease.dispositionFee ?? new Decimal('0')`
    - `purchaseFee`: use `lease.purchaseFee ?? new Decimal('0')`
    - `monthsElapsed`: use `lease.monthsElapsed ?? 0`
    - `monthsRemaining`: calculate as `lease.termMonths - (lease.monthsElapsed ?? 0)`
    - `remainingPayments` (for return scenario): `lease.monthlyPayment.mul(monthsRemaining)`
    - `wearAndTearEstimate`: default to `new Decimal('0')` (not captured in DB yet)
    - `stateCode`: use `lease.stateCode ?? 'CA'` (default to CA if not provided)
    - `netCapCost`: use `lease.netCapCost ?? lease.residualValue` (fallback)
    - `moneyFactor`: use `lease.moneyFactor ?? new Decimal('0.001')` (fallback)
    - `estimatedSalePrice` for sell-privately: use `lease.residualValue` as a placeholder (actual market value comes in Phase 4). Add a comment: `// Phase 4 will add market value entry; using residual as placeholder`
    - `extensionMonths`: default to `6` (common extension period)
    - `monthlyTax`: default to `new Decimal('0')` (simplified; full tax calc is already in each scenario)
    - `earlyTerminationFee`: default to `new Decimal('0')` (not captured in DB yet)

    Call all five evaluators:
    ```typescript
    import {
      evaluateReturnScenario,
      evaluateBuyoutScenario,
      evaluateSellPrivatelyScenario,
      evaluateEarlyTerminationScenario,
      evaluateExtensionScenario,
    } from '@/lib/calculations/scenarios';
    ```

    Return type: `ScenarioResult[]` sorted by `netCost` ascending using `a.netCost.comparedTo(b.netCost)`.

    **2. `checkForTie` function:**

    Accepts `ScenarioResult[]` (already sorted). Returns `{ isTie: boolean; tiedOptions: ScenarioType[] }`.

    Logic: If the first two results' netCost difference is `<= new Decimal('100')`, return `isTie: true` with both types.

    **3. Type export:**

    Export a `ComparisonData` interface:
    ```typescript
    export interface ComparisonData {
      scenarios: ScenarioResult[];
      bestOption: ScenarioResult;
      returnOption: ScenarioResult;
      savingsVsReturn: Decimal;
      tie: { isTie: boolean; tiedOptions: ScenarioType[] };
    }
    ```

    Add a `getComparisonData` function that calls `evaluateAllScenarios`, finds the return option, calculates savings vs return (`returnOption.netCost.minus(bestOption.netCost)`), checks for tie, and returns a `ComparisonData` object.

    Import `Decimal` from `@/lib/decimal` (not 'decimal.js'). Import types from `@/lib/types`.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - File exports: evaluateAllScenarios, checkForTie, getComparisonData, ComparisonData
  </verify>
  <done>
    evaluateAllScenarios maps a lease DB record to all five scenario evaluators and returns results sorted by netCost ascending. checkForTie detects when top two options are within $100. getComparisonData bundles everything the UI needs into a single object. All functions use Decimal for precision -- Number conversion only happens in format-currency.ts at display time.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- all new files type-check
2. `ls src/components/ui/{card,collapsible,badge}.tsx` -- shadcn components installed
3. `ls src/lib/utils/format-currency.ts src/lib/calculations/evaluate-all.ts` -- new files exist
4. Grep for `import.*from.*@/lib/decimal` in both new files -- Decimal imported from canonical path
5. Grep for `comparedTo` in evaluate-all.ts -- sorting uses Decimal comparison, not Number conversion
</verification>

<success_criteria>
- formatCurrency('1234.56') produces "$1,234.56"
- evaluateAllScenarios accepts a lease DB record and returns exactly 5 ScenarioResult objects
- Results are sorted by netCost ascending (lowest cost first)
- checkForTie returns isTie: true when top two are within $100
- All code uses Decimal from @/lib/decimal, never from 'decimal.js' directly
- shadcn Card, Collapsible, Badge components installed and importable
</success_criteria>

<output>
After completion, create `.planning/phases/03-comparison-view/03-01-SUMMARY.md`
</output>
