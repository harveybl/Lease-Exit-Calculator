---
phase: 06-timeline-and-smart-recommendations
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - package.json
  - src/components/ui/chart.tsx
  - src/components/timeline/TimelineChart.tsx
  - src/components/timeline/TimelineTooltip.tsx
  - src/components/timeline/InflectionMarkers.tsx
autonomous: true

must_haves:
  truths:
    - "Recharts and shadcn/ui chart component are installed and available"
    - "TimelineChart renders a multi-line chart with one line per scenario"
    - "Hovering any month shows a tooltip with cost breakdown for all scenarios"
    - "Crossover points are visually marked on the chart"
  artifacts:
    - path: "src/components/ui/chart.tsx"
      provides: "shadcn/ui chart components (ChartContainer, ChartTooltip, ChartTooltipContent)"
      exports: ["ChartContainer", "ChartTooltip", "ChartTooltipContent", "ChartConfig"]
    - path: "src/components/timeline/TimelineChart.tsx"
      provides: "Main timeline chart with multi-line scenario curves"
      exports: ["TimelineChart"]
      min_lines: 40
    - path: "src/components/timeline/TimelineTooltip.tsx"
      provides: "Custom tooltip showing cost breakdown per month"
      exports: ["TimelineTooltip"]
    - path: "src/components/timeline/InflectionMarkers.tsx"
      provides: "Visual markers for crossover points on the chart"
      exports: ["InflectionMarkers"]
  key_links:
    - from: "src/components/timeline/TimelineChart.tsx"
      to: "src/components/ui/chart.tsx"
      via: "uses ChartContainer, ChartTooltip"
      pattern: "import.*from.*components/ui/chart"
    - from: "src/components/timeline/TimelineChart.tsx"
      to: "src/lib/types/timeline.ts"
      via: "accepts TimelineDataPoint[] as data prop"
      pattern: "TimelineDataPoint"
    - from: "src/components/timeline/TimelineChart.tsx"
      to: "recharts"
      via: "uses LineChart, Line, XAxis, YAxis"
      pattern: "import.*from.*recharts"
---

<objective>
Install Recharts + shadcn/ui chart component and build the timeline visualization components.

Purpose: These are the visual building blocks for the timeline feature. The chart components consume the TimelineDataPoint[] data from Plan 01 and render interactive multi-line charts with tooltips and crossover markers.

Output: Installed recharts dependency, shadcn/ui chart component, and three custom timeline components ready to be wired into a page.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-timeline-and-smart-recommendations/06-RESEARCH.md
@.planning/phases/06-timeline-and-smart-recommendations/06-01-SUMMARY.md

@src/lib/types/timeline.ts
@src/lib/types/scenario.ts
@src/lib/utils/format-currency.ts
@src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Recharts and shadcn/ui chart component</name>
  <files>package.json, src/components/ui/chart.tsx</files>
  <action>
    1. Run `npx shadcn@latest add chart` to install the shadcn/ui chart component. This should install recharts as a dependency and create src/components/ui/chart.tsx.

    2. After installation, verify recharts is in package.json dependencies. If shadcn installs recharts v2.x, manually upgrade: `npm install recharts@latest` to get v3.6.0+.

    3. Verify the chart component exists at src/components/ui/chart.tsx and exports ChartContainer, ChartTooltip, ChartTooltipContent, and ChartConfig.

    4. Add chart color CSS variables to the theme if shadcn didn't add them automatically. The chart component needs --chart-1 through --chart-5 CSS variables. Check src/app/globals.css. If missing, add them in the :root and .dark sections:
      --chart-1: 195 85% 45%;    (teal -- matches project primary)
      --chart-2: 25 95% 53%;     (warm orange)
      --chart-3: 142 72% 42%;    (green)
      --chart-4: 280 65% 60%;    (purple)
      --chart-5: 350 80% 55%;    (red)

    IMPORTANT: Do NOT modify existing CSS variables. Only add --chart-N if they are missing.
  </action>
  <verify>
    Run `npm ls recharts` to confirm recharts is installed.
    Check that src/components/ui/chart.tsx exists.
    Run `npx tsc --noEmit` to verify no TypeScript errors.
  </verify>
  <done>recharts v3.6.0+ in package.json, src/components/ui/chart.tsx exists with ChartContainer/ChartTooltip exports, chart CSS variables defined.</done>
</task>

<task type="auto">
  <name>Task 2: Build TimelineChart, TimelineTooltip, and InflectionMarkers components</name>
  <files>
    src/components/timeline/TimelineChart.tsx
    src/components/timeline/TimelineTooltip.tsx
    src/components/timeline/InflectionMarkers.tsx
  </files>
  <action>
    Create three client components in src/components/timeline/:

    **TimelineChart.tsx** ("use client"):
    - Props: { data: TimelineDataPoint[], crossovers?: CrossoverPoint[], className?: string }
    - Import LineChart, Line, XAxis, YAxis, CartesianGrid, ReferenceDot from "recharts"
    - Import ChartContainer, ChartTooltip from "@/components/ui/chart"
    - Import TimelineTooltip and InflectionMarkers
    - Define chartConfig satisfies ChartConfig mapping each scenario to a label + color:
      - return: "Return Vehicle", color hsl(var(--chart-1))
      - buyout: "Buy Out Lease", color hsl(var(--chart-2))
      - sellPrivately: "Sell Privately", color hsl(var(--chart-3))
      - earlyTermination: "Early Termination", color hsl(var(--chart-4))
      - extension: "Keep Paying", color hsl(var(--chart-5))
    - Render inside ChartContainer with className="min-h-[400px] w-full" and config={chartConfig}
    - LineChart with accessibilityLayer prop, data={data}, margin={{ top: 20, right: 20, bottom: 20, left: 20 }}
    - CartesianGrid vertical={false}
    - XAxis dataKey="month", label "Months from now", tickLine={false}, axisLine={false}
    - YAxis tickFormatter={(value) => formatCurrency(value)} (abbreviated, e.g. "$12K" for thousands)
      - Actually, use a simple formatter: `(v: number) => '$' + (v >= 1000 ? (v/1000).toFixed(0) + 'K' : v.toFixed(0))`
    - ChartTooltip with content={<TimelineTooltip />}
    - One <Line> per scenario:
      - dataKey matching the scenario key in TimelineDataPoint
      - type="monotone", stroke using var(--color-{key}), strokeWidth={2}, dot={false}
      - connectNulls={false} so null values create gaps in the line (not connected)
    - If crossovers provided, render <InflectionMarkers crossovers={crossovers} data={data} />

    **TimelineTooltip.tsx** ("use client"):
    - Props: standard Recharts tooltip props { active?, payload?, label? }
    - If not active or no payload, return null
    - Display header: "Today" if label === 0, otherwise "Month {label}"
    - For each payload entry (each scenario line that has data at this point):
      - Show colored dot (entry.color), scenario display name (from chartConfig or formatOptionName), and formatted cost (formatCurrency)
    - Sort entries by value ascending (cheapest first) for easy comparison
    - Style with rounded-lg border bg-background p-3 shadow-md (matches project card style)

    **InflectionMarkers.tsx** ("use client"):
    - Props: { crossovers: CrossoverPoint[], data: TimelineDataPoint[] }
    - For each crossover, render a Recharts ReferenceDot at the crossover month on the Y value of the scenario that became cheapest
    - Use a small diamond or circle marker with a distinct color (e.g., foreground color)
    - Include a Recharts Label with the crossover message (abbreviated -- just the month, e.g., "Flip")
    - Keep it simple -- detailed crossover info is in the recommendation summary, not cluttering the chart

    IMPORTANT: All three are "use client" components since Recharts requires client-side rendering.
    IMPORTANT: Do NOT use ResponsiveContainer directly -- ChartContainer from shadcn/ui handles responsive sizing.
    IMPORTANT: formatCurrency is imported from '@/lib/utils/format-currency', NOT from '@/lib/utils'.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify no TypeScript errors.
    Verify all three files exist and export their named components.
  </verify>
  <done>TimelineChart renders a multi-line Recharts LineChart with themed colors, TimelineTooltip shows per-month cost breakdown on hover, InflectionMarkers places visual markers at crossover points. All compile without errors.</done>
</task>

</tasks>

<verification>
1. `npm ls recharts` shows recharts v3.6.0+
2. `npx tsc --noEmit` passes with no errors
3. src/components/ui/chart.tsx exists
4. src/components/timeline/TimelineChart.tsx exports TimelineChart
5. src/components/timeline/TimelineTooltip.tsx exports TimelineTooltip
6. src/components/timeline/InflectionMarkers.tsx exports InflectionMarkers
</verification>

<success_criteria>
- Recharts installed at v3.6.0+
- shadcn/ui chart component installed with ChartContainer, ChartTooltip exports
- Chart CSS variables (--chart-1 through --chart-5) defined
- TimelineChart accepts TimelineDataPoint[] and renders 5 scenario lines
- TimelineTooltip shows formatted costs sorted cheapest-first on hover
- InflectionMarkers renders markers at crossover months
- All TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/06-timeline-and-smart-recommendations/06-03-SUMMARY.md`
</output>
