---
phase: 06-timeline-and-smart-recommendations
plan: 04
type: execute
wave: 3
depends_on: ["06-02", "06-03"]
files_modified:
  - src/components/timeline/RecommendationSummary.tsx
  - src/app/lease/[id]/timeline/page.tsx
  - src/app/lease/[id]/timeline/loading.tsx
  - src/app/lease/[id]/compare/page.tsx
autonomous: false

must_haves:
  truths:
    - "User can navigate to /lease/{id}/timeline and see the interactive cost chart"
    - "Hovering any month on the chart shows cost breakdown for all options"
    - "Crossover points are identified and labeled on the chart"
    - "A recommendation summary shows best option today vs whether waiting helps"
    - "Timeline page is accessible from the comparison page"
  artifacts:
    - path: "src/app/lease/[id]/timeline/page.tsx"
      provides: "RSC timeline page that fetches lease data and renders chart"
      exports: ["default"]
      min_lines: 30
    - path: "src/components/timeline/RecommendationSummary.tsx"
      provides: "Recommendation card showing best-now vs wait advice"
      exports: ["RecommendationSummary"]
      min_lines: 25
  key_links:
    - from: "src/app/lease/[id]/timeline/page.tsx"
      to: "src/lib/calculations/timeline.ts"
      via: "calls buildTimelineData with lease data"
      pattern: "buildTimelineData"
    - from: "src/app/lease/[id]/timeline/page.tsx"
      to: "src/lib/recommendations/crossover-detection.ts"
      via: "calls detectCrossovers with timeline data"
      pattern: "detectCrossovers"
    - from: "src/app/lease/[id]/timeline/page.tsx"
      to: "src/lib/recommendations/decision-window.ts"
      via: "calls generateRecommendation with timeline data"
      pattern: "generateRecommendation"
    - from: "src/app/lease/[id]/timeline/page.tsx"
      to: "src/components/timeline/TimelineChart.tsx"
      via: "renders TimelineChart with data and crossovers"
      pattern: "TimelineChart"
    - from: "src/app/lease/[id]/timeline/page.tsx"
      to: "src/app/lease/actions.ts"
      via: "fetches lease with getLease"
      pattern: "getLease"
---

<objective>
Wire everything together: build the timeline page (RSC), recommendation summary component, add navigation from the comparison page, and verify the complete feature visually.

Purpose: This is the integration plan that connects the calculation engine (Plan 01), recommendation logic (Plan 02), and chart components (Plan 03) into a working user-facing feature. The timeline page follows the exact same RSC pattern as the existing comparison page.

Output: A working /lease/{id}/timeline route showing an interactive cost chart with crossover markers and a recommendation summary.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-timeline-and-smart-recommendations/06-RESEARCH.md
@.planning/phases/06-timeline-and-smart-recommendations/06-01-SUMMARY.md
@.planning/phases/06-timeline-and-smart-recommendations/06-02-SUMMARY.md
@.planning/phases/06-timeline-and-smart-recommendations/06-03-SUMMARY.md

@src/app/lease/[id]/compare/page.tsx
@src/app/lease/actions.ts
@src/lib/calculations/timeline.ts
@src/lib/recommendations/crossover-detection.ts
@src/lib/recommendations/decision-window.ts
@src/components/timeline/TimelineChart.tsx
@src/lib/types/timeline.ts
@src/lib/utils/format-currency.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build RecommendationSummary component and timeline page</name>
  <files>
    src/components/timeline/RecommendationSummary.tsx
    src/app/lease/[id]/timeline/page.tsx
    src/app/lease/[id]/timeline/loading.tsx
  </files>
  <action>
    **RecommendationSummary.tsx** (server or client component -- no interactivity needed, can be server):
    - Props: { recommendation: RecommendationResult, crossovers: CrossoverPoint[] }
    - Render a Card (from shadcn/ui) with:
      - Header: "Recommendation" with a TrendingUp icon from lucide-react
      - Primary message: recommendation.message in bold text
      - If shouldWait:
        - Show "Best today: {formatOptionName(bestNow.scenario)} at {formatCurrency(bestNow.cost)}"
        - Show "Better option: {formatOptionName(bestOverall.scenario)} at {formatCurrency(bestOverall.cost)} in month {bestOverall.month}"
        - Show "Potential savings: {formatCurrency(savings)}" in green text
      - If not shouldWait:
        - Show "Best option: {formatOptionName(bestNow.scenario)} at {formatCurrency(bestNow.cost)}"
        - Show "Waiting won't improve your outcome" in muted text
      - If crossovers exist, show "Key inflection points:" followed by crossover messages as a bulleted list
    - Style with project conventions: Card component, text-sm, space-y-2

    **Timeline page (src/app/lease/[id]/timeline/page.tsx):**
    - RSC (server component) following the EXACT pattern of compare/page.tsx:
      - Export metadata: { title: "Timeline | Lease Tracker", description: "..." }
      - Props: { params: Promise<{ id: string }> }
      - Await params, call getLease(id), handle notFound()
      - Fetch market value: getLatestMarketValue(id), convert to Decimal if present
      - Call buildTimelineData(lease, estimatedSalePrice)
      - Call detectCrossovers(timelineSeries.data)
      - Call generateRecommendation(timelineSeries.data)
    - Build vehicle heading (same pattern as compare page)
    - Render layout:
      - Back link to /lease/{id}/compare (not /lease like compare page -- timeline goes back to compare)
      - h1 with vehicle heading
      - RecommendationSummary with recommendation and crossovers
      - TimelineChart with data and crossovers
      - If !timelineSeries.hasMarketValue, show a muted note: "Add market value on the comparison page for sell-privately projections"
      - Disclaimers section at bottom (general disclaimer)
    - Wrap in <main className="mx-auto max-w-4xl px-4 py-8"> (matches compare page)

    **Loading skeleton (src/app/lease/[id]/timeline/loading.tsx):**
    - Simple skeleton with a card placeholder for recommendation and a large rectangular placeholder for chart area
    - Use Skeleton component if available, otherwise div with animate-pulse bg-muted rounded classes

    IMPORTANT: The timeline page is a SERVER component. TimelineChart is a client component. Data flows server -> client via props. Decimal values are already converted to numbers in buildTimelineData, so no RSC serialization issues.

    IMPORTANT: Import getLease and getLatestMarketValue from "@/app/lease/actions" (same as compare page).
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify no TypeScript errors.
    Run `npm run build` to verify the page compiles in production build.
  </verify>
  <done>Timeline page renders at /lease/{id}/timeline with recommendation summary, interactive chart, and crossover markers. Loading skeleton shown during data fetch.</done>
</task>

<task type="auto">
  <name>Task 2: Add navigation link from comparison page to timeline</name>
  <files>
    src/app/lease/[id]/compare/page.tsx
  </files>
  <action>
    Add a navigation link/button on the comparison page that takes the user to the timeline view.

    In src/app/lease/[id]/compare/page.tsx:
    - Import Link from "next/link" (already imported)
    - Import { TrendingUp } from "lucide-react" (or Clock, or LineChart icon)
    - After the ComparisonView component (but before closing </main>), add a section:
      - A card or styled link block:
        ```
        <div className="mt-8 rounded-lg border bg-card p-6 text-center">
          <h2 className="text-lg font-semibold mb-2">When should you act?</h2>
          <p className="text-sm text-muted-foreground mb-4">
            See how your options change month-by-month over the remaining lease term.
          </p>
          <Link
            href={`/lease/${id}/timeline`}
            className="inline-flex items-center gap-2 rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground hover:bg-primary/90"
          >
            <TrendingUp className="h-4 w-4" />
            View Timeline
          </Link>
        </div>
        ```

    IMPORTANT: Do NOT modify the existing ComparisonView rendering or layout. Add the timeline link AFTER it.
    IMPORTANT: Use the same id variable already available in the page component.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify no TypeScript errors.
    Visually confirm the link appears on the compare page when running `npm run dev`.
  </verify>
  <done>Compare page shows a "View Timeline" link/button that navigates to /lease/{id}/timeline.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete timeline feature: month-by-month cost chart with hoverable tooltips, crossover markers, recommendation summary ("best now" vs "wait"), and navigation from comparison page.
  </what-built>
  <how-to-verify>
    1. Start dev server: `npm run dev`
    2. Navigate to an existing lease's comparison page at http://localhost:3000/lease/{id}/compare
    3. Scroll down and click "View Timeline"
    4. Verify the timeline page loads with:
       - Vehicle heading at top
       - Recommendation summary card (shows best option today + whether waiting helps)
       - Interactive line chart showing cost curves for multiple scenarios
       - X-axis labeled "Months from now", Y-axis showing dollar amounts
    5. Hover over different months on the chart -- verify tooltip shows cost breakdown for all scenarios at that month
    6. Check if crossover markers appear (they will only show if scenario rankings change over time)
    7. If no market value is set, verify the "Add market value" note appears and sell-privately line is absent from chart
    8. Navigate back to compare page using the back link
    9. Test with a lease that HAS a market value set -- verify sell-privately line appears on the chart
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with the timeline visualization.</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. Timeline page accessible at /lease/{id}/timeline
4. Chart shows scenario cost curves over remaining months
5. Tooltip shows per-month cost breakdown on hover
6. Recommendation summary shows best-now vs wait advice
7. Navigation from compare page works
8. Incomplete scenarios (no market value) handled gracefully
</verification>

<success_criteria>
- /lease/{id}/timeline renders an interactive multi-line cost chart
- Hovering any month shows cost breakdown for all active scenarios
- Crossover points are identified and marked on chart
- Recommendation summary distinguishes "best today" from "better if you wait"
- Compare page has navigation link to timeline
- Sell-privately line only appears when market value is set
- Extension line only appears at lease end month
- User has visually verified the feature works
</success_criteria>

<output>
After completion, create `.planning/phases/06-timeline-and-smart-recommendations/06-04-SUMMARY.md`
</output>
