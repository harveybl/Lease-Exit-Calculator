---
phase: 06-timeline-and-smart-recommendations
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/lib/calculations/timeline.ts
  - src/lib/types/timeline.ts
  - src/__tests__/lib/calculations/timeline.test.ts
autonomous: true

must_haves:
  truths:
    - "Month-by-month cost projections exist for each scenario across the remaining lease term"
    - "Timeline data uses Decimal for all financial calculations, converting to number only at export boundary"
    - "Incomplete scenarios (no market value) produce null values instead of misleading placeholder data"
  artifacts:
    - path: "src/lib/types/timeline.ts"
      provides: "TimelineDataPoint, MonthlyProjection, TimelineSeries types"
      exports: ["TimelineDataPoint", "MonthlyProjection", "TimelineSeries"]
    - path: "src/lib/calculations/timeline.ts"
      provides: "Month-by-month scenario cost projections"
      exports: ["buildTimelineData", "projectScenarioCosts"]
    - path: "src/__tests__/lib/calculations/timeline.test.ts"
      provides: "Tests for timeline projection accuracy"
      min_lines: 80
  key_links:
    - from: "src/lib/calculations/timeline.ts"
      to: "src/lib/calculations/scenarios/index.ts"
      via: "imports scenario evaluators"
      pattern: "import.*from.*scenarios"
    - from: "src/lib/calculations/timeline.ts"
      to: "src/lib/db/schema.ts"
      via: "accepts Lease type"
      pattern: "Lease"
---

<objective>
Build the timeline calculation engine that projects month-by-month costs for each lease exit scenario across the remaining lease term.

Purpose: This is the data foundation for the entire timeline feature. Without accurate month-by-month projections, the chart, crossover detection, and recommendations have nothing to visualize or analyze. TDD ensures the financial projections are correct before any UI work begins.

Output: Tested pure functions that accept a Lease and optional market value, returning an array of monthly cost projections for all 5 scenarios.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-timeline-and-smart-recommendations/06-RESEARCH.md

@src/lib/calculations/evaluate-all.ts
@src/lib/calculations/scenarios/return.ts
@src/lib/calculations/scenarios/buyout.ts
@src/lib/calculations/scenarios/sell-privately.ts
@src/lib/calculations/scenarios/early-termination.ts
@src/lib/calculations/scenarios/extension.ts
@src/lib/types/scenario.ts
@src/lib/db/schema.ts
@src/lib/decimal.ts
</context>

<feature>
  <name>Timeline Calculation Engine</name>
  <files>
    src/lib/types/timeline.ts
    src/lib/calculations/timeline.ts
    src/__tests__/lib/calculations/timeline.test.ts
  </files>
  <behavior>
    The timeline engine re-evaluates all 5 scenarios at each month offset from now until lease end.

    Types (src/lib/types/timeline.ts):
    - TimelineDataPoint: { month: number, return: number, buyout: number, sellPrivately: number | null, earlyTermination: number, extension: number | null }
      - number values are Decimal.toDP(2).toNumber() for chart consumption
      - sellPrivately is null when no market value provided
      - extension is null for all months except the final month (lease end)
    - MonthlyProjection: { month: number, costs: Record<ScenarioType, Decimal | null> }
      - Internal type with full Decimal precision before chart conversion
    - TimelineSeries: { data: TimelineDataPoint[], monthsRemaining: number, hasMarketValue: boolean, scenarios: ScenarioType[] }
      - Wrapper returned by buildTimelineData

    Core function: buildTimelineData(lease: Lease, estimatedSalePrice?: Decimal): TimelineSeries

    Logic for each month offset (0 to monthsRemaining):
    - Return scenario: remaining payments decrease each month (monthsRemaining - monthOffset). Disposition fee stays constant. Excess mileage projection adjusts (fewer months = less projected overage). Call evaluateReturnScenario with adjusted params.
    - Buyout scenario: Call evaluateBuyoutScenario with monthsElapsed incremented by monthOffset. Payoff amount decreases over time as book value amortizes.
    - Sell privately: Same as buyout but subtract estimatedSalePrice. If no estimatedSalePrice, return null for this scenario.
    - Early termination: Call evaluateEarlyTerminationScenario with adjusted monthsElapsed. Cost decreases as remaining depreciation and rent charges shrink.
    - Extension: Only available at lease end (month === monthsRemaining). For all other months, null. At lease end, call evaluateExtensionScenario.

    Key insight: For each month offset, we simulate "what if we're N months further into the lease" by adjusting monthsElapsed and recalculating remaining payments. The lease data itself doesn't change -- we project forward.

    Expected test cases:
    - A 36-month lease with 12 months elapsed produces 24 data points (months 0-24, where 0 = today)
    - Month 0 return cost matches evaluateReturnScenario called with current lease data
    - Month 24 (final month) return cost has zero remaining payments but still has disposition fee
    - Buyout cost at month 0 > buyout cost at month 24 (payoff decreases over time)
    - sellPrivately is null for all months when no estimatedSalePrice provided
    - extension is null for months 0-23, has a value at month 24
    - All number values are rounded to 2 decimal places
  </behavior>
  <implementation>
    1. Create src/lib/types/timeline.ts with TimelineDataPoint, MonthlyProjection, TimelineSeries types. Export ScenarioType re-export from scenario.ts for convenience.

    2. Create src/lib/calculations/timeline.ts:
       - Import all 5 scenario evaluators from scenarios/index.ts
       - Import Decimal from @/lib/decimal
       - Import Lease from @/lib/db/schema
       - Helper: projectScenarioCosts(lease, monthOffset, estimatedSalePrice?) -> MonthlyProjection
         - Adjusts monthsElapsed by monthOffset
         - Recalculates remainingPayments as monthlyPayment * (monthsRemaining - monthOffset)
         - Calls each scenario evaluator with adjusted params
         - Returns MonthlyProjection with Decimal costs
       - Main: buildTimelineData(lease, estimatedSalePrice?) -> TimelineSeries
         - Computes monthsRemaining = termMonths - (monthsElapsed ?? 0)
         - Loops 0 to monthsRemaining inclusive
         - Calls projectScenarioCosts for each month
         - Converts Decimal costs to number using .toDP(2).toNumber()
         - Null for sellPrivately when no estimatedSalePrice
         - Null for extension except at final month
         - Returns TimelineSeries with data array, monthsRemaining, hasMarketValue flag, active scenarios list

    IMPORTANT: Use Decimal for ALL calculations. Only call .toDP(2).toNumber() at the final conversion step when building TimelineDataPoint from MonthlyProjection.

    IMPORTANT: For the return scenario projection at each month, mileage projection needs adjustment. As months advance, currentMileage stays the same (we don't know future mileage), but monthsElapsed increases and monthsRemaining decreases. The mileage projection at future months should use the same currentMileage but with an advanced monthsElapsed, so the projected end-of-lease mileage decreases (closer to today's actual mileage). This makes the excess mileage cost decrease over time as the projection window shrinks.

    IMPORTANT: For early termination, at month === monthsRemaining (lease end), the cost is just residualValue + fees (no remaining depreciation or rent charges). This should naturally fall out of the formula when monthsRemaining - monthOffset = 0.
  </implementation>
</feature>

<verification>
Run `npm test -- --run src/__tests__/lib/calculations/timeline.test.ts` and all tests pass.
</verification>

<success_criteria>
- buildTimelineData returns correct number of data points (monthsRemaining + 1)
- Month 0 costs match direct scenario evaluation with same lease data
- Costs generally decrease over time for return, buyout, and early-termination
- sellPrivately is null when no market value; has values when market value provided
- extension is null except at final month
- All number values are rounded to 2 decimal places
- Tests cover at least 5 distinct behaviors
</success_criteria>

<output>
After completion, create `.planning/phases/06-timeline-and-smart-recommendations/06-01-SUMMARY.md`
</output>
